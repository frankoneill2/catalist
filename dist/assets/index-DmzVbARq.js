import{initializeApp as Jn}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";import{getFirestore as Zn,addDoc as Ae,collection as oe,serverTimestamp as We,query as ye,orderBy as Be,onSnapshot as Le,updateDoc as ae,doc as Y,deleteDoc as xe,collectionGroup as Qn,where as It,getDoc as wn,getDocs as yt,limit as eo}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import{getAuth as to,signInAnonymously as no}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}})();const oo={apiKey:"AIzaSyBo5a6Uxk1vJwS8WqFnccjSnNOOXreOhcg",authDomain:"catalist-1.firebaseapp.com",projectId:"catalist-1",storageBucket:"catalist-1.firebasestorage.app",messagingSenderId:"843924921323",appId:"1:843924921323:web:0e7a847f8cd70db55f57ae",measurementId:"G-6NZEC4ED4C"},kn=Jn(oo),I=Zn(kn),ao=to(kn);let ln,me,Ie,_t,zt,ft,ve,Ve,yn,xn,jt,gt,Ln,Nn,Tn,In,Sn,An,Bn,Fn,Mn,Dn,Pn,se,Me,$e,Dt,be,we,ct,Vt,Xe,Ct,qe,Gt,rt,Wt,Kt,re=null,pt=!1,St=!1,Xt="list",$n=0,Ze=null,ke=null,Re=null,Ee=null,_e=null,ge=null,le=null,pe=null,nt=new Map,At=null,Bt=null,Ye=[],Yt=[],Ge=[],it=null,Pt=new Set(["open","in progress","complete"]),$t="all",Et="none",Rt="",Rn=[],Hn=null,Je=new Map,Ce=new Map,De=new Set(["open","in progress","complete"]),Ue="all",Oe="none",rn=new Map,he="me",Jt=!1,Zt=!1,Qt=!1,en=!1,je="",tn=[],nn,on,qn=new Map;const so=["#fef3c7","#fde68a","#dcfce7","#bbf7d0","#dbeafe","#bfdbfe","#e0e7ff","#ddd6fe","#fae8ff","#fee2e2","#ffe4e6","#f3e8ff"];let lt=!0;function gn(n){lt=!!n;const t=document.getElementById("table-section");t&&t.classList.toggle("cell-color-disabled",!n);try{localStorage.setItem("table.showCellColor",n?"1":"0")}catch{}if(!n){const e=document.querySelector(".color-panel");e&&e.remove()}}let ce=new Map,Se=new Map,j={location:new Set,consultant:new Set,room:new Set},de="none",Pe="asc";function ot(n){return Array.from(n||[]).join(",")}function at(n){return new Set((n||"").split(",").map(t=>t.trim()).filter(Boolean))}function Te(){try{localStorage.setItem("table.filters.location",ot(j.location)),localStorage.setItem("table.filters.consultant",ot(j.consultant)),localStorage.setItem("table.filters.room",ot(j.room)),localStorage.setItem("table.sort.key",de||"none"),localStorage.setItem("table.sort.dir",Pe||"asc")}catch{}try{const n=new URL(window.location.href),t=n.searchParams,e=(a,i)=>{i?t.set(a,i):t.delete(a)};e("loc",ot(j.location)),e("cons",ot(j.consultant)),e("room",ot(j.room)),e("sort",de&&de!=="none"?de:""),e("dir",Pe&&de!=="none"?Pe:"");const o=n.toString();window.history.replaceState(null,"",o)}catch{}}function co(){try{const t=new URL(window.location.href).searchParams,e=t.get("loc"),o=t.get("cons"),a=t.get("room"),i=t.get("sort"),c=t.get("dir");if(e||o||a||i){e&&(j.location=at(e)),o&&(j.consultant=at(o)),a&&(j.room=at(a)),i&&(de=i),c&&(Pe=c);return}}catch{}try{j.location=at(localStorage.getItem("table.filters.location")),j.consultant=at(localStorage.getItem("table.filters.consultant")),j.room=at(localStorage.getItem("table.filters.room")),de=localStorage.getItem("table.sort.key")||"none",Pe=localStorage.getItem("table.sort.dir")||"asc"}catch{}}function vt(n){const t=document.getElementById("table-tags-controls"),e=document.getElementById("table-section");if(!t||!e)return;let o=document.getElementById("filters-placeholder");if(n){t.style.display="none",o||(o=document.createElement("div"),o.id="filters-placeholder",o.className="filters-placeholder",e.insertBefore(o,document.getElementById("table-root"))),o.innerHTML="";const a=document.createElement("button");a.type="button",a.className="show-filters-btn",a.textContent="Show Filters",a.addEventListener("click",()=>vt(!1)),o.appendChild(a);try{localStorage.setItem("tableFiltersHidden","1")}catch{}}else{t.style.display="",o&&o.remove();try{localStorage.setItem("tableFiltersHidden","0")}catch{}}}async function Un(){const n=document.createElement("div");n.className="modal-overlay";const t=document.createElement("div");t.className="modal",n.appendChild(t);const e=document.createElement("h3");e.textContent="New Case",t.appendChild(e);const o=document.createElement("div");o.className="stack",t.appendChild(o);const a=document.createElement("label");a.textContent="Title";const i=document.createElement("input");i.placeholder="Enter case title",i.setAttribute("aria-label","Case title"),a.appendChild(i),o.appendChild(a);const c=document.createElement("label");c.textContent="Location";const d=document.createElement("select");c.appendChild(d),o.appendChild(c);const h=document.createElement("label");h.textContent="Room";const l=document.createElement("select");h.appendChild(l),o.appendChild(h);const f=document.createElement("label");f.textContent="Consultant";const r=document.createElement("select");f.appendChild(r),o.appendChild(f);const s=document.createElement("div");s.className="actions";const p=document.createElement("button");p.className="btn",p.textContent="Cancel";const u=document.createElement("button");u.className="btn primary",u.textContent="Create",s.appendChild(p),s.appendChild(u),t.appendChild(s),document.body.appendChild(n);const m=(S,W,F=!0)=>{if(S.innerHTML="",F){const L=document.createElement("option");L.value="",L.textContent="Unassigned",S.appendChild(L)}for(const L of W){const q=document.createElement("option");q.value=L.id,q.textContent=L.name,S.appendChild(q)}},k=async()=>{const S=d.value||"";if(S){const W=await mn(S);m(l,W,!0)}else m(l,[],!0)};m(d,ce.get("location")||[]),m(r,ce.get("consultant")||[]);const b=Array.from(j.location||[]);b.length===1&&(d.value=b[0]);const y=Array.from(j.consultant||[]);y.length===1&&(r.value=y[0]),await k();const D=Array.from(j.room||[]);D.length===1&&(l.value=D[0]),d.addEventListener("change",async()=>{await k(),l.value=""});const M=()=>n.remove();p.addEventListener("click",M),u.addEventListener("click",async()=>{const S=(i.value||"").trim();if(!S){i.focus();return}try{const W=await ne(S),F={location:d.value||null,consultant:r.value||null},L=d.value||null,q=l.value||null;L&&q?F.room=q:F.room=null,await Ae(oe(I,"cases"),{titleCipher:W.cipher,titleIv:W.iv,createdAt:We(),caseTags:F}),M(),G("Case created")}catch(W){console.error("Failed to create case",W),G("Failed to create case")}}),i.focus()}function dn(n){if(!n)return{bg:"#e5e7eb",border:"#d1d5db",color:"#374151"};let t=0;for(let i=0;i<n.length;i++)t=(t*31+n.charCodeAt(i))%360;const e=`hsl(${t}, 70%, 90%)`,o=`hsl(${t}, 60%, 65%)`,a=`hsl(${t}, 40%, 25%)`;return{bg:e,border:o,color:a}}async function io(n){const t=new TextEncoder,e=t.encode("shared-salt"),o=await crypto.subtle.importKey("raw",t.encode(n),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function lo(n){return btoa(String.fromCharCode(...new Uint8Array(n)))}function ro(n){return Uint8Array.from(atob(n),t=>t.charCodeAt(0))}async function ne(n){const t=new TextEncoder,e=crypto.getRandomValues(new Uint8Array(12)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},ln,t.encode(n));return{cipher:lo(o),iv:Array.from(e)}}async function ie(n,t){const e=new TextDecoder,o=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(t)},ln,ro(n));return e.decode(o)}async function wt(n,t,e="list",o="notes"){re=n,Xt=e==="user"?"user":e==="table"?"table":"list",Ve.textContent=t,se&&(se.hidden=!0),Ie&&(Ie.style.display="none"),qe.hidden=!0,ve.hidden=!1,ho(n),Io(n),cn(o);try{const a=new URL(window.location.href);a.searchParams.set("case",n),window.history.pushState({caseId:n},"",a.toString())}catch{}}function Ft(n){const t=document.getElementById("tab-table"),e=document.getElementById("tab-my"),o=document.getElementById("tab-updates"),a=n==="table",i=n==="my",c=n==="updates";if(t&&(t.classList.toggle("active",a),t.setAttribute("aria-selected",String(a))),e&&(e.classList.toggle("active",i),e.setAttribute("aria-selected",String(i))),o&&(o.classList.toggle("active",c),o.setAttribute("aria-selected",String(c))),a){if(Ie&&(Ie.style.display="none"),ve.hidden=!0,qe.hidden=!0,$e&&($e.hidden=!0),se&&(se.hidden=!1),_e||ko(),ge){try{ge()}catch{}ge=null}}else if(i){if(se&&(se.hidden=!0),_e&&(_e(),_e=null),$e&&($e.hidden=!0),ge){try{ge()}catch{}ge=null}un(me)}else if(c)se&&(se.hidden=!0),_e&&(_e(),_e=null),ve.hidden=!0,qe.hidden=!0,$e&&($e.hidden=!1),ge||Co();else{if($e&&($e.hidden=!0),ge){try{ge()}catch{}ge=null}se&&(se.hidden=!1)}}function On(){return new Promise(async n=>{const t=document.createElement("div");t.className="modal-overlay";const e=document.createElement("div");e.className="modal",t.appendChild(e);const o=document.createElement("h3");o.textContent="Select your user",e.appendChild(o);const a=document.createElement("div");a.className="row",e.appendChild(a);const i=document.createElement("select");i.style.height="48px",i.style.borderRadius="12px",i.style.border="1px solid #e5e7eb",i.style.padding="0 12px",a.appendChild(i);const c=document.createElement("div");c.className="actions",e.appendChild(c);const d=document.createElement("button");d.className="btn",d.textContent="Cancel",c.appendChild(d);const h=document.createElement("button");h.className="btn primary",h.textContent="Continue",c.appendChild(h),document.body.appendChild(t);let l=null;const f=s=>{const p=i.value;i.innerHTML="";for(const u of s){const m=document.createElement("option");m.value=u,m.textContent=u,i.appendChild(m)}p&&s.includes(p)&&(i.value=p)};try{const s=ye(oe(I,"users"),Be("username"));l=Le(s,p=>{const u=p.docs.map(m=>(m.data().username||"").trim()).filter(Boolean);f(u)})}catch{const p=await yt(ye(oe(I,"users"),Be("username")));f(p.docs.map(u=>(u.data().username||"").trim()).filter(Boolean))}const r=()=>{l&&l(),t.remove()};d.addEventListener("click",()=>{r(),n("")}),h.addEventListener("click",()=>{const s=i.value||"";r(),n(s)}),i.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),h.click())}),i.focus()})}function mo(){const n=ye(oe(I,"tags"),Be("order"));Le(n,async t=>{const e=new Map;for(const o of t.docs){const a=o.data(),i=a.type||"";let c="";try{c=await ie(a.nameCipher,a.nameIv)}catch{}const d={id:o.id,name:c,order:typeof a.order=="number"?a.order:0,type:i};e.has(i)||e.set(i,[]),e.get(i).push(d)}for(const[o,a]of e)a.sort((i,c)=>i.order-c.order||i.name.localeCompare(c.name));ce=e,uo(),document.dispatchEvent(new CustomEvent("tags:updated"))},t=>console.error("Tags listener error",t))}function mn(n){return n?Se.has(n)?Promise.resolve(Se.get(n)):new Promise(t=>{const e=ye(oe(I,"tags",n,"subtags"),Be("order"));Le(e,async o=>{const a=[];for(const i of o.docs){const c=i.data();let d="";try{d=await ie(c.nameCipher,c.nameIv)}catch{}a.push({id:i.id,name:d,order:typeof c.order=="number"?c.order:0,type:c.type||"room"})}a.sort((i,c)=>i.order-c.order||i.name.localeCompare(c.name)),Se.set(n,a),document.dispatchEvent(new CustomEvent("subtags:updated",{detail:{parentId:n}})),t(a)})}):Promise.resolve([])}function uo(){be&&Cn(be,ce.get("location")||[]),we&&Cn(we,ce.get("consultant")||[])}function Cn(n,t){const e=new Set(Array.from(n.selectedOptions||[]).map(o=>o.value));n.innerHTML="";for(const o of t){const a=document.createElement("option");a.value=o.id,a.textContent=o.name,n.appendChild(a)}for(const o of Array.from(n.options))e.has(o.value)&&(o.selected=!0)}function po(){const n=()=>{se&&!se.hidden&&le&&pe&&pe(le)},t=()=>{j.location=new Set(Array.from((be==null?void 0:be.selectedOptions)||[]).map(e=>e.value)),j.consultant=new Set(Array.from((we==null?void 0:we.selectedOptions)||[]).map(e=>e.value)),Te(),n()};be&&be.addEventListener("change",t),we&&we.addEventListener("change",t),ct&&ct.addEventListener("change",()=>{de=ct.value||"none",Te(),n()}),Vt&&Vt.addEventListener("click",()=>{var e,o;j.location.clear(),j.consultant.clear(),(o=(e=j.room)==null?void 0:e.clear)==null||o.call(e),be&&Array.from(be.options).forEach(a=>a.selected=!1),we&&Array.from(we.options).forEach(a=>a.selected=!1),ct&&(ct.value="none"),de="none",Te(),n()})}function fo(n){for(const t of["location","consultant","room"]){const e=j[t];if(e&&e.size){const o=n&&n[t];if(!o||!e.has(o))return!1}}return!0}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("toggle-all-tasks");if(!n)return;const t=()=>{document.querySelectorAll(".case-tasks-wrap").forEach(a=>{a.hidden=pt}),document.querySelectorAll(".case-tasks-toggle").forEach(a=>{a instanceof HTMLElement&&(a.id==="toggle-all-tasks"||a.id==="toggle-all-comments"||(a.textContent=pt?"Show tasks":"Hide tasks"))}),n.textContent=pt?"Expand all":"Collapse all"};n.addEventListener("click",()=>{pt=!pt,t()}),t()});document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("toggle-all-comments");if(!n)return;const t=()=>{document.querySelectorAll(".case-mini-comments").forEach(o=>{o instanceof HTMLElement&&(o.hidden=St)}),n.textContent=St?"Show comments":"Hide comments"};n.addEventListener("click",()=>{St=!St,t()}),t()});function ho(n){const t=ye(oe(I,"cases",n,"tasks"),Be("createdAt","desc"));ke&&ke();let e=null;ke=Le(t,async o=>{gt.innerHTML="";const a=[];for(const c of o.docs){const d=c.data();try{const h=await ie(d.textCipher,d.textIv),l=await ie(d.statusCipher,d.statusIv),f=d.createdAt&&d.createdAt.toMillis?d.createdAt.toMillis():0;a.push({docSnap:c,data:d,text:h,status:l,createdAt:f})}catch(h){console.error("Skipping undecryptable task",h)}}if(e)for(const c of a){const d=c.docSnap.id;e.includes(d)||e.unshift(d)}else{const c=h=>h==="open"?0:h==="in progress"?1:2;e=[...a].sort((h,l)=>{const f=c(h.status)-c(l.status);return f!==0?f:l.createdAt-h.createdAt}).map(h=>h.docSnap.id)}const i=new Map(e.map((c,d)=>[c,d]));a.sort((c,d)=>(i.get(c.docSnap.id)??999999)-(i.get(d.docSnap.id)??999999)),Hn=e.slice(),Rn=a.map(({docSnap:c,data:d,text:h,status:l,createdAt:f})=>({caseId:n,id:c.id,text:h,status:l,data:d,createdAt:f})),ze()})}function bt(n,t,e,o){const a=ye(oe(I,"cases",n,"tasks",t,"comments"),Be("createdAt","asc"));Le(a,async i=>{o&&o(i.size),e.innerHTML="";for(const c of i.docs){const{cipher:d,iv:h,username:l}=c.data();try{const f=await ie(d,h),r=document.createElement("li"),s=document.createElement("span");s.textContent=l?`${l}: ${f}`:f,r.appendChild(s);const p=document.createElement("div");p.className="case-actions";const u=document.createElement("button");u.className="icon-btn",u.textContent="âœï¸",u.setAttribute("aria-label","Edit comment"),u.addEventListener("click",async()=>{const b=(prompt("Edit comment",f)||"").trim();if(!b)return;const{cipher:y,iv:D}=await ne(b);await ae(Y(I,"cases",n,"tasks",t,"comments",c.id),{cipher:y,iv:D}),G("Comment updated")}),p.appendChild(u);const m=document.createElement("button");m.className="icon-btn delete-btn",m.textContent="ðŸ—‘",m.setAttribute("aria-label","Delete comment"),m.addEventListener("click",async()=>{confirm("Delete this comment?")&&(await xe(Y(I,"cases",n,"tasks",t,"comments",c.id)),G("Comment deleted"))}),p.appendChild(m),r.appendChild(p),e.appendChild(r)}catch(f){console.error("Skipping undecryptable comment",f)}}},i=>console.error("Comments listener error",i))}async function Qe(n={}){try{const t={type:n.type,caseId:n.caseId||re||"",username:me,createdAt:We()};let e=n.caseTitle||(typeof Ve<"u"&&Ve&&Ve.textContent?Ve.textContent:"Case");try{e=(e||"").trim()}catch{}const{cipher:o,iv:a}=await ne(e||"Case"),i={...t,caseTitleCipher:o,caseTitleIv:a},c=["taskId","taskTextCipher","taskTextIv","assignee","priority","commentCipher","commentIv","noteSection","noteTitleCipher","noteTitleIv"];for(const d of c)n[d]!==void 0&&(i[d]=n[d]);await Ae(oe(I,"updates"),i)}catch(t){console.error("Failed to log update",t)}}function yo(n){var t;try{if(!n)return"";const e=n.toDate?n.toDate():n;return((t=e.toLocaleString)==null?void 0:t.call(e))||String(e)}catch{return""}}function go(n){const t=document.createElement("li");t.className="update-item";const e=n.data(),o=e.username||"Someone",a=yo(e.createdAt);let i="",c="Case";return(async()=>{try{e.caseTitleCipher&&e.caseTitleIv&&(c=await ie(e.caseTitleCipher,e.caseTitleIv))}catch{}const h=e.type;if(h==="task_added"){let r="";try{e.taskTextCipher&&e.taskTextIv&&(r=await ie(e.taskTextCipher,e.taskTextIv))}catch{}i=`${o} added ${r||"a task"} to ${c}`}else if(h==="task_completed"){let r="";try{e.taskTextCipher&&e.taskTextIv&&(r=await ie(e.taskTextCipher,e.taskTextIv))}catch{}i=`${o} marked ${r||"a task"} as complete`}else if(h==="comment_added"){let r="";try{e.commentCipher&&e.commentIv&&(r=await ie(e.commentCipher,e.commentIv))}catch{}i=`${o} commented on ${c}: ${r}`}else if(h==="note_added"){const r=e.noteSection||"";let s="";try{e.noteTitleCipher&&e.noteTitleIv&&(s=await ie(e.noteTitleCipher,e.noteTitleIv))}catch{}i=`${o} added ${s?"â€œ"+s+"â€ ":""}to section ${r} of ${c}`}else i=`${o} updated ${c}`;const l=document.createElement("a");l.href="#",l.textContent=i,l.addEventListener("click",r=>{r.preventDefault();const s=e.caseId;s&&(e.taskId&&(it=e.taskId),wt(s,c||"Case","table","tasks"))});const f=document.createElement("div");f.className="update-meta",f.textContent=a,t.innerHTML="",t.appendChild(l),t.appendChild(f)})(),t}function Co(){try{const n=ye(oe(I,"updates"),Be("createdAt","desc"),eo(200));if(ge)try{ge()}catch{}ge=Le(n,async t=>{if(Dt){Dt.innerHTML="";for(const e of t.docs)Dt.appendChild(go(e))}},t=>console.error("Updates listener error",t))}catch(n){console.error("Failed to start updates listener",n)}}function Ht(n){return{c:`col${n}Cipher`,iv:`col${n}Iv`}}function Wn(n){return{c:`col${n}BodyCipher`,iv:`col${n}BodyIv`}}async function Eo(n,t,e){const{c:o,iv:a}=Ht(t),i=(e||"").trim();if(n)try{if(!i)await ae(Y(I,"cases",n),{[o]:null,[a]:null});else{const c=await ne(i);await ae(Y(I,"cases",n),{[o]:c.cipher,[a]:c.iv})}}catch(c){console.error("Failed to save column",t,c),G("Failed to save")}}async function vo(n,t,e){const{c:o,iv:a}=Wn(t),i=(e||"").trim();if(n)try{if(!i)await ae(Y(I,"cases",n),{[o]:null,[a]:null});else{const c=await ne(i);await ae(Y(I,"cases",n),{[o]:c.cipher,[a]:c.iv})}}catch(c){console.error("Failed to save body column",t,c),G("Failed to save")}}function Kn(n){return`col${n}Items`}function ht(n="",t=""){return{id:Math.random().toString(36).slice(2,10),title:n,body:t,order:Date.now()}}async function _n(n,t){const e=n[Kn(t)]||null;if(Array.isArray(e)&&e.length){const i=[];for(const c of e){let d="",h="";try{c.titleCipher&&c.titleIv&&(d=await ie(c.titleCipher,c.titleIv))}catch{}try{c.bodyCipher&&c.bodyIv&&(h=await ie(c.bodyCipher,c.bodyIv))}catch{}i.push({id:c.id||Math.random().toString(36).slice(2,10),title:d,body:h,order:c.order||0})}return i.sort((c,d)=>(c.order||0)-(d.order||0)),i}let o="",a="";try{const{c:i,iv:c}=Ht(t);n[i]&&n[c]&&(o=await ie(n[i],n[c]))}catch{}try{const{c:i,iv:c}=Wn(t);n[i]&&n[c]&&(a=await ie(n[i],n[c]))}catch{}return o||a?[{id:"legacy",title:o,body:a,order:0}]:[]}async function bo(n){const t=[];for(const e of n){const{cipher:o,iv:a}=await ne((e.title||"").trim()),{cipher:i,iv:c}=await ne((e.body||"").trim());t.push({id:e.id,titleCipher:o,titleIv:a,bodyCipher:i,bodyIv:c,order:e.order||0})}return t}async function zn(n,t,e){const o=Kn(t),a=await bo(e),i=e[0]&&(e[0].title||"").trim()||"",c=i?await ne(i):null,d={[o]:a};if(c){const{c:h,iv:l}=Ht(t);d[h]=c.cipher,d[l]=c.iv}else{const{c:h,iv:l}=Ht(t);d[h]=null,d[l]=null}await ae(Y(I,"cases",n),d)}function wo(){if(!Me)return{table:null,tbody:null};const n=document.createElement("table");n.className="data-table";const t=document.createElement("thead"),e=document.createElement("tr"),o=["Patient","Diagnosis","History","Micro/ABx","Investigations","Updates","Tasks"];for(const i of o){const c=document.createElement("th");c.textContent=i,e.appendChild(c)}t.appendChild(e);const a=document.createElement("tbody");return n.appendChild(t),n.appendChild(a),{table:n,tbody:a}}function ko(){const n=ye(oe(I,"cases"),Be("createdAt","desc"));pe=async t=>{const e=document.activeElement;if(e&&e.classList&&(e.classList.contains("cell-editable")||e.classList.contains("cell-title")))return;const{table:o,tbody:a}=wo();if(!o||!a||!Me)return;let i=t;if(de&&de!=="none"){const l=[];for(const f of i){const s=f.data().caseTags||{};let p=999999;if(de==="location"){const m=(ce.get("location")||[]).findIndex(k=>k.id===s.location);p=m===-1?999999:m}else if(de==="consultant"){const m=(ce.get("consultant")||[]).findIndex(k=>k.id===s.consultant);p=m===-1?999999:m}else if(de==="room"){const m=(Se.get(s.location)||[]).findIndex(k=>k.id===s.room);p=m===-1?999999:m}l.push({d:f,score:p,title:""})}for(const f of l)try{const r=f.d.data();f.title=await ie(r.titleCipher,r.titleIv)}catch{}l.sort((f,r)=>f.score-r.score||f.title.localeCompare(r.title)),Pe==="desc"&&l.reverse(),i=l.map(f=>f.d)}for(const l of i){const f=l.data();let r="";try{r=await ie(f.titleCipher,f.titleIv)}catch{}if(!r||!r.trim())continue;const s=document.createElement("tr"),p=document.createElement("td"),u=document.createElement("div");u.className="name-cell";const m=document.createElement("div");m.className="name-row";const k=document.createElement("button");k.className="patient-link",k.textContent=r,k.addEventListener("click",()=>{$n=window.scrollY,wt(l.id,r,"table","notes")}),m.appendChild(k);const b=document.createElement("button");b.type="button",b.className="edit-tags-btn",b.textContent="Tags",b.addEventListener("click",W=>{W.stopPropagation(),an(l.id,p)}),m.appendChild(b);const y=document.createElement("button");y.type="button",y.className="icon-btn delete-btn",y.textContent="ðŸ—‘",y.title="Delete case",y.addEventListener("click",async W=>{if(W.stopPropagation(),!!confirm("Delete this case and all its items?"))try{if(await Vn(l.id),re===l.id){if(ke){try{ke()}catch{}ke=null}if(Re){try{Re()}catch{}Re=null}if(Ee){try{Ee()}catch{}Ee=null}re=null,ve.hidden=!0,se&&(se.hidden=!1)}G("Case deleted")}catch(F){console.error("Failed to delete case",F),G("Failed to delete case")}}),m.appendChild(y),u.appendChild(m);const D=document.createElement("div");D.className="tag-chips";const M=f.caseTags||{},S=(W,F,L)=>{if(!L)return;const q=F==="room"?Se.get(M.location)||[]:ce.get(F)||[],U=q.findIndex(K=>K.id===L);if(U===-1)return;const B=q[U],A=document.createElement("span");A.className="tag-chip",A.setAttribute("role","button"),A.setAttribute("tabindex","0");const H=document.createElement("span");H.className="tag-order",H.textContent=String(U+1)+".",A.appendChild(H);const Z=document.createElement("span");if(Z.textContent=B.name,A.appendChild(Z),F==="location"){A.title="Edit tags";const K=()=>{an(l.id,p)};A.addEventListener("click",x=>{x.stopPropagation(),K()}),A.addEventListener("keydown",x=>{(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),K())})}else{A.title=`Filter by ${W}`;const K=()=>{const x=j[F];x.has(L)?x.delete(L):x.add(L),A.classList.toggle("active",x.has(L)),Te(),le&&pe&&pe(le);const O=new CustomEvent("filters:updated");document.dispatchEvent(O)};try{const x=j[F];A.classList.toggle("active",x&&x.has(L))}catch{}A.addEventListener("click",x=>{x.stopPropagation(),K()}),A.addEventListener("keydown",x=>{(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),K())})}D.appendChild(A)};S("Location","location",M.location||null),M.room&&M.location&&S("Room","room",M.room),S("Consultant","consultant",M.consultant||null),u.appendChild(D),p.appendChild(u),s.appendChild(p);for(const W of["A","B","C","D","E","F"]){const F=document.createElement("td");if(W==="F"){const L=document.createElement("div");L.className="cell-tasks";const q=document.createElement("ul");L.appendChild(q);const U=document.createElement("form");U.className="composer compact";const B=document.createElement("input");if(B.placeholder="Add taskâ€¦",B.setAttribute("aria-label","Task description"),U.appendChild(B),U.addEventListener("submit",async H=>{H.preventDefault();const Z=(B.value||"").trim();if(!Z)return;const{cipher:K,iv:x}=await ne(Z),{cipher:O,iv:$}=await ne("open"),w=await Ae(oe(I,"cases",l.id,"tasks"),{textCipher:K,textIv:x,statusCipher:O,statusIv:$,createdAt:We(),username:me||null,assignee:null,priority:null});try{await Qe({type:"task_added",caseId:l.id,caseTitle:r,taskId:w.id,taskTextCipher:K,taskTextIv:x})}catch{}B.value=""}),F.appendChild(L),F.appendChild(U),nt.has(l.id)){try{nt.get(l.id)()}catch{}nt.delete(l.id)}const A=Lo(l.id,q);nt.set(l.id,A)}else{const L=document.createElement("div");L.className="cell-items";const q=await _n(f,W),U=8,B=`${l.id}:${W}`;window._cellExpand||(window._cellExpand=new Set);const A=window._cellExpand.has(B),H=async()=>{try{await zn(l.id,W,q)}catch(w){console.error("save",w),G("Failed to save")}};let Z=null;const K=()=>{clearTimeout(Z),Z=setTimeout(H,500)},x=w=>{if(L.innerHTML="",!q.length){const g=document.createElement("div");g.className="cell-line";const P=document.createElement("div");P.className="cell-bullet",g.appendChild(P);const E=document.createElement("div");E.className="cell-title",E.setAttribute("contenteditable","true"),E.dataset.placeholder="Add headerâ€¦",E.addEventListener("input",()=>{const v=(E.textContent||"").trim();v.length>0&&q.length===0&&(q.push(ht(v,"")),window._cellExpand.add(B),x(!0),K(),setTimeout(()=>{const N=L.querySelector(".cell-title");N&&N.focus()},0))}),E.addEventListener("keydown",v=>{if(v.key==="Enter"&&!(v.ctrlKey||v.metaKey||v.shiftKey)){v.preventDefault();const N=(E.textContent||"").trim();if(!N)return;q.splice(0,0,ht(N,"")),q.splice(1,0,ht("","")),window._cellExpand.add(B),x(!0),K(),setTimeout(()=>{const C=L.querySelectorAll(".cell-title")[1];C&&C.focus()},0)}else if(v.key==="Enter"&&(v.ctrlKey||v.metaKey)){v.preventDefault();const N=F.cellIndex,C=s.nextElementSibling;if(C&&C.children[N]){const T=C.children[N].querySelector(".cell-title, .cell-editable");T&&T.focus()}}else if(v.key==="Tab"){v.preventDefault();const N=v.shiftKey?-1:1;let T=F.cellIndex+N,R=s;if(T<1){const V=s.previousElementSibling;if(V)R=V,T=6;else return}else if(T>6){const V=s.nextElementSibling;if(V)R=V,T=1;else return}const X=R.children[T];if(X){const V=X.querySelector(".cell-title, .cell-editable");V&&V.focus()}}}),g.appendChild(E),L.appendChild(g);return}const _=w?Math.min(q.length,U):Math.min(q.length,3);for(let g=0;g<_;g++){const P=q[g],E=document.createElement("div");E.className="cell-line";const v=document.createElement("div");v.className="cell-bullet",E.appendChild(v);const N=document.createElement("div");if(N.className="cell-title",N.setAttribute("contenteditable","true"),N.textContent=P.title||"",N.addEventListener("keydown",C=>{const T=window.getSelection(),R=T&&T.anchorOffset===0&&T.anchorNode&&(T.anchorNode===N||T.anchorNode.parentElement===N),X=!N.textContent||N.textContent.replace(/\u200B/g,"").trim()==="";if(C.key==="Enter"&&!(C.ctrlKey||C.metaKey||C.shiftKey)){if(C.preventDefault(),q.length>=U){G("Limit 8 items");return}const V=ht("","");q.splice(g+1,0,V),window._cellExpand.add(B),x(!0),K(),setTimeout(()=>{const ee=L.querySelectorAll(".cell-title")[g+1];if(ee){ee.focus();try{const z=window.getSelection(),J=document.createRange();J.selectNodeContents(ee),J.collapse(!0),z.removeAllRanges(),z.addRange(J)}catch{}}},0)}else if(C.key==="Backspace"&&g>0&&X)C.preventDefault(),q.splice(g,1),x(w),K(),setTimeout(()=>{const V=L.querySelectorAll(".cell-title")[g-1];if(V){V.focus();try{const ee=window.getSelection(),z=document.createRange();z.selectNodeContents(V),z.collapse(!1),ee.removeAllRanges(),ee.addRange(z)}catch{}}},0);else if(C.key==="Backspace"&&R&&g>0){C.preventDefault();const V=q[g-1],ee=q[g];V.title=(V.title||"")+(ee.title||""),q.splice(g,1),x(w),K(),setTimeout(()=>{const z=L.querySelectorAll(".cell-title")[g-1];if(z){z.focus();try{const J=window.getSelection(),te=document.createRange();te.selectNodeContents(z),te.collapse(!1),J.removeAllRanges(),J.addRange(te)}catch{}}},0)}else if(C.key==="Tab"){C.preventDefault();const V=C.shiftKey?-1:1;let z=F.cellIndex+V,J=s;if(z<1){const Q=s.previousElementSibling;if(Q)J=Q,z=6;else return}else if(z>6){const Q=s.nextElementSibling;if(Q)J=Q,z=1;else return}const te=J.children[z];if(te){const Q=te.querySelector(".cell-title, .cell-editable");Q&&Q.focus()}}else if(C.key==="Enter"&&(C.ctrlKey||C.metaKey)){C.preventDefault();const V=F.cellIndex,ee=s.nextElementSibling;if(ee&&ee.children[V]){const z=ee.children[V].querySelector(".cell-title, .cell-editable");z&&z.focus()}}}),N.addEventListener("input",()=>{P.title=N.textContent||"",K()}),E.appendChild(N),(P.body||"").trim().length>0){const C=document.createElement("button");C.type="button",C.className="line-info-btn",C.textContent="â€º",C.title="Show details";let T=null,R=!1,X=!1,V=!1;const ee=()=>{T&&(T.remove(),T=null),R=!1,document.removeEventListener("click",z,!0)},z=te=>{T&&!T.contains(te.target)&&te.target!==C&&ee()},J=()=>{if(T)return;T=document.createElement("div"),T.className="cell-body-panel";const te=document.createElement("div");te.className="cell-body-text",te.textContent=P.body||"",T.appendChild(te),document.body.appendChild(T);const Q=C.getBoundingClientRect();requestAnimationFrame(()=>{const fe=T.offsetWidth||240,et=T.offsetHeight||120,Ke=Math.min(Math.max(8,Q.right-fe),window.innerWidth-fe-8),kt=Math.min(window.innerHeight-et-8,Q.bottom+6);T.style.left=`${Math.round(Ke)}px`,T.style.top=`${Math.round(kt)}px`}),T.addEventListener("mouseenter",()=>{V=!0}),T.addEventListener("mouseleave",()=>{V=!1,!R&&!X&&setTimeout(()=>{!R&&!X&&T&&ee()},120)})};C.addEventListener("mouseenter",()=>{X=!0,R||J()}),C.addEventListener("mouseleave",()=>{X=!1,!R&&!V&&setTimeout(()=>{!R&&!X&&T&&ee()},120)}),C.addEventListener("click",te=>{te.stopPropagation(),T||J(),R?ee():(R=!0,document.addEventListener("click",z,!0))}),E.appendChild(C)}L.appendChild(E)}if(!w&&q.length>3){const g=document.createElement("div");g.className="cell-more",g.textContent=`+${q.length-3}`,g.addEventListener("click",()=>{window._cellExpand.add(B),x(!0)}),L.appendChild(g)}if(w&&q.length>3){const g=document.createElement("div");g.className="cell-collapse",g.textContent="Collapse",g.addEventListener("click",()=>{window._cellExpand.delete(B),x(!1)}),L.appendChild(g)}};x(A);const O=`col${W}Color`,$=f[O]||null;if($&&(F.style.background=$),lt){const w=document.createElement("button");w.type="button",w.className="cell-color-btn",w.title="Cell color",w.addEventListener("click",_=>{_.stopPropagation();const g=document.querySelector(".color-panel");g&&g.remove();const P=document.createElement("div");P.className="color-panel";const E=document.createElement("div");E.className="color-swatch none",E.title="None",E.addEventListener("click",async C=>{C.stopPropagation();try{const T={};T[O]=null,await ae(Y(I,"cases",l.id),T),F.style.background=""}catch(T){console.error("Failed to clear color",T),G("Failed to update color")}P.remove()}),P.appendChild(E);for(const C of so){const T=document.createElement("div");T.className="color-swatch",T.style.background=C,T.title=C,T.addEventListener("click",async R=>{R.stopPropagation();try{const X={};X[O]=C,await ae(Y(I,"cases",l.id),X),F.style.background=C}catch(X){console.error("Failed to set color",X),G("Failed to update color")}P.remove()}),P.appendChild(T)}document.body.appendChild(P);const v=w.getBoundingClientRect();requestAnimationFrame(()=>{const C=P.offsetWidth||180,T=P.offsetHeight||120,R=Math.min(Math.max(8,v.right-C),window.innerWidth-C-8),X=Math.min(window.innerHeight-T-8,v.bottom+6);P.style.left=`${Math.round(R)}px`,P.style.top=`${Math.round(X)}px`});const N=C=>{!P.contains(C.target)&&C.target!==w&&(P.remove(),document.removeEventListener("click",N,!0))};setTimeout(()=>document.addEventListener("click",N,!0),0)}),F.appendChild(w)}F.appendChild(L)}s.appendChild(F)}fo(f.caseTags||{})&&a.appendChild(s)}Me.innerHTML="",Me.appendChild(o);const c=document.createElement("div");c.className="new-case-footer";const d=document.createElement("button");d.type="button",d.className="btn primary",d.textContent="âž• New Case",d.addEventListener("click",Un),c.appendChild(d),Me.appendChild(c);const h=new Set(t.map(l=>l.id));for(const[l,f]of Array.from(nt.entries()))if(!h.has(l)){try{f()}catch{}nt.delete(l)}},_e=Le(n,t=>{le=t.docs,pe&&pe(le);try{document.dispatchEvent(new CustomEvent("filters:updated"))}catch{}},t=>console.error("Table listener error",t))}function xo(){const n=document.getElementById("table-tags-controls");if(!n)return;n.innerHTML="";const t=document.createElement("div");t.className="left";const e=document.createElement("div");e.className="right",n.appendChild(t),n.appendChild(e);const o=document.createElement("div");o.className="filter-chips",t.appendChild(o);const a=document.createElement("span");a.className="section-label",a.textContent="Filters",t.appendChild(a);const i=document.createElement("div");i.className="pills-wrap",t.appendChild(i);const c=document.createElement("button");c.type="button",c.className="filter-pill",c.setAttribute("aria-haspopup","listbox"),c.setAttribute("aria-expanded","false"),c.textContent="Location";const d=document.createElement("span");d.className="count",d.textContent="",c.appendChild(d),i.appendChild(c);const h=document.createElement("button");h.type="button",h.className="filter-pill",h.setAttribute("aria-haspopup","listbox"),h.setAttribute("aria-expanded","false"),h.textContent="Room";const l=document.createElement("span");l.className="count",l.textContent="",h.appendChild(l),i.appendChild(h);const f=document.createElement("button");f.type="button",f.className="filter-pill",f.setAttribute("aria-haspopup","listbox"),f.setAttribute("aria-expanded","false"),f.textContent="Consultant";const r=document.createElement("span");r.className="count",r.textContent="",f.appendChild(r),i.appendChild(f);const s=document.createElement("button");s.type="button",s.className="mobile-filters-btn",s.textContent="Filters",e.appendChild(s);const p=document.createElement("span");p.className="section-label",p.textContent="Sort",e.appendChild(p);const u=document.createElement("div");u.className="segmented";const m=(g,P)=>{const E=document.createElement("button");return E.type="button",E.textContent=g,E.dataset.key=P,E.addEventListener("click",()=>{de=P,Te(),Z(),le&&pe&&pe(le)}),E},k=m("None","none"),b=m("Location","location"),y=m("Room","room"),D=m("Consultant","consultant");u.appendChild(k);const M=document.createElement("div");M.className="sep",u.appendChild(M),u.appendChild(b);const S=document.createElement("div");S.className="sep",u.appendChild(S),u.appendChild(y);const W=document.createElement("div");W.className="sep",u.appendChild(W),u.appendChild(D);const F=document.createElement("button");F.type="button",F.className="sort-dir",F.textContent="â†‘",F.title="Toggle sort direction",F.addEventListener("click",()=>{Pe=Pe==="asc"?"desc":"asc",F.textContent=Pe==="asc"?"â†‘":"â†“",Te(),le&&pe&&pe(le)});const L=document.createElement("button");L.type="button",L.className="icon-btn small",L.textContent="Clear",L.addEventListener("click",()=>{j.location.clear(),j.consultant.clear(),j.room.clear(),Te(),w(),le&&pe&&pe(le)});const q=document.createElement("button");q.type="button",q.className="icon-btn small",q.textContent="Hide",q.addEventListener("click",()=>{vt(!0)}),e.appendChild(u),e.appendChild(F),e.appendChild(L),e.appendChild(q);const U=document.createElement("label");U.className="ctrl",U.style.display="inline-flex",U.style.alignItems="center",U.style.gap="6px";const B=document.createElement("input");B.type="checkbox";const A=document.createElement("span");A.textContent="Cell colors",A.className="section-label";try{lt=(localStorage.getItem("table.showCellColor")??"1")!=="0"}catch{lt=!0}B.checked=!!lt,gn(lt),B.addEventListener("change",()=>{gn(B.checked)}),U.appendChild(B),U.appendChild(A),e.insertBefore(U,L);function H(){o.innerHTML="";const g=(E,v,N)=>{const C=document.createElement("span");C.className="filter-chip";const T=document.createElement("span");T.textContent=N,C.appendChild(T);const R=document.createElement("span");R.className="x",R.textContent="âœ•",R.setAttribute("role","button"),R.setAttribute("tabindex","0");const X=()=>{j[E].delete(v),Te(),w(),le&&pe&&pe(le)};R.addEventListener("click",X),R.addEventListener("keydown",V=>{(V.key==="Enter"||V.key===" ")&&(V.preventDefault(),X())}),C.appendChild(R),o.appendChild(C)},P=(E,v)=>{for(const N of j[E]){const C=v.find(T=>T.id===N);C&&g(E,N,C.name)}};P("location",ce.get("location")||[]),P("consultant",ce.get("consultant")||[]);for(const E of j.room){let v="Room";for(const[N,C]of Se.entries()){const T=(C||[]).find(R=>R.id===E);if(T){v=T.name;break}}g("room",E,v)}}function Z(){[k,b,y,D].forEach(g=>g.classList.toggle("active",g.dataset.key===(de||"none"))),F.style.display=de&&de!=="none"?"":"none",F.textContent=Pe==="asc"?"â†‘":"â†“"}let K=null;function x(g,P){const E=document.querySelector(".filter-popover");if(E&&K===g){E.remove(),g.setAttribute("aria-expanded","false"),K=null;return}O(g,P)}function O(g,P){if(g.getAttribute("aria-disabled")==="true")return;const E=document.querySelector(".filter-popover");E&&E.remove();const v=document.createElement("div");v.className="filter-popover",v.setAttribute("role","listbox");const N=document.createElement("input");N.className="search",N.type="search",N.placeholder="Searchâ€¦",v.appendChild(N);const C=document.createElement("div");C.className="list",v.appendChild(C),document.body.appendChild(v);const T=g.getBoundingClientRect();requestAnimationFrame(()=>{const z=Math.min(window.innerWidth-v.offsetWidth-8,T.left),J=Math.min(window.innerHeight-v.offsetHeight-8,T.bottom+6);v.style.left=`${Math.max(8,z)}px`,v.style.top=`${Math.max(8,J)}px`});const R=j[P],X=[];if(P==="room"){const z=Array.from(j.location),J=z.length===1?z[0]:null,te=J?Se.get(J)||[]:[];for(const Q of te)X.push({id:Q.id,name:Q.name,count:$({room:Q.id})})}else{const z=ce.get(P)||[];for(const J of z)X.push({id:J.id,name:J.name,count:$({[P]:J.id})})}const V=()=>{const z=(N.value||"").toLowerCase();C.innerHTML="";for(const J of X){if(z&&!J.name.toLowerCase().includes(z))continue;const te=document.createElement("div");te.className="opt",te.setAttribute("role","option"),te.setAttribute("aria-selected",String(R.has(J.id)));const Q=document.createElement("div");Q.className="label";const fe=document.createElement("input");fe.type="checkbox",fe.checked=R.has(J.id),Q.appendChild(fe);const et=document.createElement("span");et.textContent=J.name,Q.appendChild(et);const Ke=document.createElement("div");Ke.className="opt-count",Ke.textContent=String(J.count),te.appendChild(Q),te.appendChild(Ke),te.addEventListener("click",()=>{R.has(J.id)?R.delete(J.id):R.add(J.id),te.setAttribute("aria-selected",String(R.has(J.id))),fe.checked=R.has(J.id),Te(),w(),le&&pe&&pe(le)}),C.appendChild(te)}};V(),N.addEventListener("input",()=>{clearTimeout(N._t),N._t=setTimeout(V,120)});const ee=z=>{!v.contains(z.target)&&z.target!==g&&(v.remove(),document.removeEventListener("click",ee,!0),g.setAttribute("aria-expanded","false"),K=null)};setTimeout(()=>document.addEventListener("click",ee,!0),0),g.setAttribute("aria-expanded","true"),K=g,N.focus()}function $(g){if(!Array.isArray(le))return 0;let P=0;for(const E of le){const v=E.data().caseTags||{};let N=!0;for(const C in g)if(!v[C]||v[C]!==g[C]){N=!1;break}N&&P++}return P}function w(){d.textContent=j.location.size?` (${j.location.size})`:"",r.textContent=j.consultant.size?` (${j.consultant.size})`:"",l.textContent=j.room.size?` (${j.room.size})`:"";const g=j.location.size===1;h.setAttribute("aria-disabled",g?"false":"true"),H()}c.addEventListener("click",()=>x(c,"location")),f.addEventListener("click",()=>x(f,"consultant")),h.addEventListener("click",()=>x(h,"room")),Z(),w(),document.addEventListener("tags:updated",w),document.addEventListener("filters:updated",w);function _(){const g=document.createElement("div");g.className="sheet-overlay";const P=document.createElement("div");P.className="sheet",g.appendChild(P);const E=ue=>{const Ne=document.createElement("div");Ne.className="section";const Fe=document.createElement("h4");return Fe.textContent=ue,Ne.appendChild(Fe),P.appendChild(Ne),Ne},v=E("Location"),N=E("Room"),C=E("Consultant"),T=E("Sort"),R=(ue,Ne,Fe)=>{const Ut=document.createElement("div");Ut.className="list",ue.appendChild(Ut);for(const mt of Fe){const ut=document.createElement("div");ut.className="opt";const Tt=document.createElement("label");Tt.className="label";const tt=document.createElement("input");tt.type="checkbox",tt.checked=j[Ne].has(mt.id);const hn=document.createElement("span");hn.textContent=mt.name,Tt.appendChild(tt),Tt.appendChild(hn);const Ot=document.createElement("div");Ot.className="opt-count",Ot.textContent=String(mt.count),ut.appendChild(Tt),ut.appendChild(Ot),ut.addEventListener("click",()=>{tt.checked=!tt.checked,tt.checked?j[Ne].add(mt.id):j[Ne].delete(mt.id)}),Ut.appendChild(ut)}},X=(ce.get("location")||[]).map(ue=>({id:ue.id,name:ue.name,count:$({location:ue.id})}));R(v,"location",X);const V=Array.from(j.location),ee=V.length===1?V[0]:null,J=(ee?Se.get(ee)||[]:[]).map(ue=>({id:ue.id,name:ue.name,count:$({room:ue.id})}));R(N,"room",J);const te=(ce.get("consultant")||[]).map(ue=>({id:ue.id,name:ue.name,count:$({consultant:ue.id})}));R(C,"consultant",te);const Q=document.createElement("div");Q.className="segmented";const fe=(ue,Ne)=>{const Fe=document.createElement("button");return Fe.type="button",Fe.textContent=ue,Fe.classList.toggle("active",(de||"none")===Ne),Fe.addEventListener("click",()=>{de=Ne,et()}),Fe},et=()=>{Te()};Q.appendChild(fe("None","none"));const Ke=document.createElement("div");Ke.className="sep",Q.appendChild(Ke),Q.appendChild(fe("Location","location"));const kt=document.createElement("div");kt.className="sep",Q.appendChild(kt),Q.appendChild(fe("Room","room"));const fn=document.createElement("div");fn.className="sep",Q.appendChild(fn),Q.appendChild(fe("Consultant","consultant")),T.appendChild(Q);const dt=document.createElement("div");dt.className="actions";const xt=document.createElement("button");xt.className="btn",xt.textContent="Clear",xt.addEventListener("click",()=>{j.location.clear(),j.room.clear(),j.consultant.clear()});const Lt=document.createElement("button");Lt.className="btn primary",Lt.textContent="Apply",Lt.addEventListener("click",()=>{Te(),w(),le&&pe&&pe(le),g.remove()});const Nt=document.createElement("button");Nt.className="btn primary",Nt.textContent="New Case",Nt.addEventListener("click",()=>{g.remove(),Un()}),dt.appendChild(xt),dt.appendChild(Lt),dt.appendChild(Nt),P.appendChild(dt),g.addEventListener("click",ue=>{ue.target===g&&g.remove()}),document.body.appendChild(g)}s.addEventListener("click",_)}function Lo(n,t,e={}){const o=ye(oe(I,"cases",n,"tasks"),Be("createdAt","desc"));let a=null,i=!1,c=null;const d=r=>{if(t){t.innerHTML="";for(const s of r)t.appendChild(No(n,s,{...e,_onEditStart:h,_onEditEnd:l}))}},h=()=>{t.dataset.editing="1"},l=()=>{if(delete t.dataset.editing,i&&c){const r=c;c=null,i=!1,d(r)}},f=Le(o,async r=>{if(!t)return;const s=[];for(const u of r.docs){const m=u.data();try{const k=await ie(m.textCipher,m.textIv),b=await ie(m.statusCipher,m.statusIv),y=m.createdAt&&m.createdAt.toMillis?m.createdAt.toMillis():0;s.push({id:u.id,text:k,status:b,data:m,createdAt:y})}catch{}}if(a)for(const u of s)a.includes(u.id)||a.unshift(u.id);else{const u=k=>k==="open"?0:k==="in progress"?1:2;a=[...s].sort((k,b)=>{const y=u(k.status)-u(b.status);return y!==0?y:b.createdAt-k.createdAt}).map(k=>k.id)}const p=new Map(a.map((u,m)=>[u,m]));if(s.sort((u,m)=>(p.get(u.id)??999999)-(p.get(m.id)??999999)),t.dataset.editing==="1"){c=s,i=!0;return}d(s)},r=>console.error("Tasks cell listener error",r));return()=>{try{f()}catch{}}}function No(n,t,e={}){const o=document.createElement("li"),a=t.status==="in progress"?"s-inprogress":t.status==="complete"?"s-complete":"s-open";o.className="case-task "+a;const i=document.createElement("button");i.type="button",i.className="status-btn";const c=s=>s==="complete"?"â˜‘":s==="in progress"?"â—":"â˜";i.textContent=c(t.status),i.setAttribute("aria-label",`Task status: ${t.status}`),i.addEventListener("click",async s=>{s.stopPropagation();const p=["open","in progress","complete"],u=p[(p.indexOf(t.status)+1)%p.length];try{const{cipher:m,iv:k}=await ne(u);await ae(Y(I,"cases",n,"tasks",t.id),{statusCipher:m,statusIv:k}),t.status=u,i.textContent=c(u),i.setAttribute("aria-label",`Task status: ${u}`),o.className="case-task "+(u==="in progress"?"s-inprogress":u==="complete"?"s-complete":"s-open")}catch(m){console.error("Failed to update status",m),G("Failed to update status")}});const d=document.createElement("span");if(d.className="task-text",d.textContent=t.text,d.addEventListener("click",s=>{s.stopPropagation(),typeof e._onEditStart=="function"&&e._onEditStart();const p=document.createElement("div");p.className="cell-editable",p.setAttribute("contenteditable","true"),p.style.minWidth="120px",p.textContent=t.text;let u=t.text;const m=async()=>{const y=(p.innerText||"").replace(/\r/g,"");if(y===u){k();return}try{const{cipher:D,iv:M}=await ne(y);await ae(Y(I,"cases",n,"tasks",t.id),{textCipher:D,textIv:M}),u=y,t.text=y,d.textContent=y,b()}catch(D){console.error("Failed to update task text",D),G("Failed to update task"),b()}},k=()=>{b()},b=()=>{try{p.remove()}catch{}d.style.display="",typeof e._onEditEnd=="function"&&e._onEditEnd()};p.addEventListener("paste",y=>{y.preventDefault();const D=(y.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,D);else{const M=window.getSelection();M&&M.rangeCount&&(M.deleteFromDocument(),M.getRangeAt(0).insertNode(document.createTextNode(D)))}}),p.addEventListener("keydown",y=>{y.key==="Enter"&&!(y.ctrlKey||y.metaKey)?(y.preventDefault(),m()):y.key==="Escape"&&(y.preventDefault(),k())}),p.addEventListener("blur",()=>{m()}),d.insertAdjacentElement("afterend",p),d.style.display="none",p.focus()}),o.appendChild(i),o.appendChild(d),t.data&&t.data.priority)if(e.compact){const s=document.createElement("span");s.style.fontSize="11px",s.style.color="#6b7280",s.title="Priority";const p=(t.data.priority||"").toLowerCase();s.textContent=p==="high"?"H":p==="medium"?"M":p==="low"?"L":"",s.textContent&&o.appendChild(s)}else{const s=document.createElement("span");s.className="mini-chip",s.textContent=t.data.priority,o.appendChild(s)}const h=document.createElement("span");h.className="mini-avatar";const l=t.data&&t.data.assignee?t.data.assignee.split(/\s+/).map(s=>s[0]).join("").slice(0,2).toUpperCase():"";h.textContent=l||"";const f=dn(t.data&&t.data.assignee||"");h.style.background=f.bg,h.style.color=f.color,h.style.border=`1px solid ${f.border}`,h.addEventListener("click",s=>{s.stopPropagation();const p=document.querySelector(".assignee-panel");p&&p.remove();const u=document.createElement("div");u.className="assignee-panel",u.style.position="fixed",u.style.zIndex="2147483646";const m=(y,D)=>{const M=document.createElement("button");M.type="button",M.className="assignee-option",M.textContent=y,M.addEventListener("click",async S=>{S.stopPropagation();try{await ae(Y(I,"cases",n,"tasks",t.id),{assignee:D})}catch(W){console.error("Failed to reassign",W),G("Failed to reassign")}finally{u.remove()}}),u.appendChild(M)};m("Unassigned",null);for(const y of Ye)m(y.username,y.username);document.body.appendChild(u);const k=h.getBoundingClientRect();requestAnimationFrame(()=>{const y=u.offsetWidth||160,D=Math.min(Math.max(8,k.right-y),window.innerWidth-y-8),M=Math.min(window.innerHeight-u.offsetHeight-8,k.bottom+6);u.style.left=`${Math.round(D)}px`,u.style.top=`${Math.round(M)}px`});const b=y=>{!u||u.contains(y.target)||y.target===h||(u.remove(),document.removeEventListener("click",b,!0))};setTimeout(()=>document.addEventListener("click",b,!0),0)});const r=document.createElement("button");return r.type="button",r.className="icon-btn delete-btn",r.textContent="ðŸ—‘",r.title="Delete task",r.addEventListener("click",async s=>{if(s.stopPropagation(),!!confirm("Delete this task?"))try{await xe(Y(I,"cases",n,"tasks",t.id))}catch(p){console.error("Failed to delete task",p),G("Failed to delete task")}}),o.appendChild(h),o.appendChild(r),o}function an(n,t){const e=document.createElement("div");e.className="tag-panel";const o=document.createElement("h4");o.textContent="Edit tags",e.appendChild(o);const a=document.createElement("div");a.className="row",e.appendChild(a);const i=document.createElement("div");i.style.display="flex",i.style.gap="6px";const c=document.createElement("select"),d=(S,W,F=!0)=>{if(S.innerHTML="",F){const L=document.createElement("option");L.value="",L.textContent="Unassigned",S.appendChild(L)}for(const L of W){const q=document.createElement("option");q.value=L.id,q.textContent=L.name,S.appendChild(q)}};d(c,ce.get("location")||[]);const h=document.createElement("button");h.type="button",h.textContent="+",h.className="icon-btn small",h.title="Add ward",h.addEventListener("click",async()=>{await qt("location")}),i.appendChild(c),i.appendChild(h),a.appendChild(i);const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";const f=document.createElement("select");d(f,[],!0);const r=document.createElement("button");r.type="button",r.textContent="+",r.className="icon-btn small",r.title="Add room",r.addEventListener("click",async()=>{const S=c.value||"";if(!S){G("Pick a ward first");return}await Gn(S)}),l.appendChild(f),l.appendChild(r),a.appendChild(l);const s=document.createElement("div");s.style.display="flex",s.style.gap="6px";const p=document.createElement("select");d(p,ce.get("consultant")||[]);const u=document.createElement("button");u.type="button",u.textContent="+",u.className="icon-btn small",u.title="Add consultant",u.addEventListener("click",async()=>{await qt("consultant")}),s.appendChild(p),s.appendChild(u),a.appendChild(s);const m=document.createElement("div");m.className="actions",e.appendChild(m);const k=document.createElement("button");k.className="icon-btn small",k.textContent="Cancel",m.appendChild(k);const b=document.createElement("button");b.className="icon-btn small",b.textContent="Save",m.appendChild(b),(async()=>{const S=Y(I,"cases",n),W=await wn(S),F=W.exists()&&W.data().caseTags||{};F.location?c.value=F.location:c.value="",await y(),F.room?f.value=F.room:f.value="",F.consultant?p.value=F.consultant:p.value=""})();async function y(){const S=c.value||null;if(S){const W=await mn(S);d(f,W,!0)}else d(f,[],!0)}c.addEventListener("change",async()=>{await y(),f.value=""}),k.addEventListener("click",()=>{e.remove(),document.removeEventListener("click",M,!0)}),b.addEventListener("click",async()=>{try{const S=c.value||null,W=f.value||null,F=p.value||null,L={location:S,consultant:F};S&&W?L.room=W:L.room=null,await ae(Y(I,"cases",n),{caseTags:L}),e.remove(),document.removeEventListener("click",M,!0)}catch(S){console.error("Failed to update tags",S),G("Failed to update tags")}}),document.body.appendChild(e);const D=t.getBoundingClientRect();requestAnimationFrame(()=>{const S=Math.min(window.innerWidth-e.offsetWidth-8,D.left),W=Math.min(window.innerHeight-e.offsetHeight-8,D.bottom+6);e.style.left=`${Math.max(8,S)}px`,e.style.top=`${Math.max(8,W)}px`});const M=S=>{!e||e.contains(S.target)||(e.remove(),document.removeEventListener("click",M,!0))};setTimeout(()=>document.addEventListener("click",M,!0),0)}function To(){const n=[{el:Ln,L:"A"},{el:Nn,L:"B"},{el:Tn,L:"C"},{el:In,L:"D"},{el:Sn,L:"E"},{el:An,L:"F"}];for(const{el:e,L:o}of n)e&&e.addEventListener("blur",()=>{re!=null&&Eo(re,o,e.value)});const t=[{el:Bn,L:"A"},{el:Fn,L:"B"},{el:Mn,L:"C"},{el:Dn,L:"D"},{el:Pn,L:"E"}];for(const{el:e,L:o}of t)e&&e.addEventListener("blur",()=>{re!=null&&vo(re,o,e.value)})}function Io(n){Ee&&(Ee(),Ee=null);const t=Y(I,"cases",n);Ee=Le(t,async e=>{if(!e.exists())return;const o=e.data();try{const i=document.getElementById("case-tag-chips");if(i){i.innerHTML="";const c=o.caseTags||{},d=(h,l)=>{if(!l)return;const r=(h==="room"?Se.get(c.location)||[]:ce.get(h)||[]).find(m=>m.id===l);if(!r)return;const s=document.createElement("span");s.className="tag-chip",s.setAttribute("role","button"),s.setAttribute("tabindex","0");const p=document.createElement("span");p.textContent=r.name,s.appendChild(p);const u=()=>{an(n,Ve||i)};s.addEventListener("click",m=>{m.stopPropagation(),u()}),s.addEventListener("keydown",m=>{(m.key==="Enter"||m.key===" ")&&(m.preventDefault(),u())}),i.appendChild(s)};d("location",c.location||null),c.room&&c.location&&d("room",c.room),d("consultant",c.consultant||null)}}catch{}const a=[{L:"A",el:document.getElementById("notes-A-items")},{L:"B",el:document.getElementById("notes-B-items")},{L:"C",el:document.getElementById("notes-C-items")},{L:"D",el:document.getElementById("notes-D-items")},{L:"E",el:document.getElementById("notes-E-items")}];for(const i of a){const c=await _n(o,i.L);So(i.el,i.L,c)}try{const i=(d,h)=>{if(!d)return;const l=`col${h}Color`,f=o[l]||null;d.style.background=f||""},c=(d,h)=>{const l=document.getElementById(d);if(!l)return;const f=`col${h}Color`,r=o[f]||null;l.querySelectorAll("input, textarea").forEach(s=>{s.style.background=r||""})};c("notes-A-items","A"),c("notes-B-items","B"),c("notes-C-items","C"),c("notes-D-items","D"),c("notes-E-items","E")}catch{}})}function So(n,t,e){var f;if(!n)return;n.innerHTML="";const o=8,a=(f=n.parentElement)==null?void 0:f.querySelector('.add-note-item[data-letter="'+t+'"]'),i=e.length<o;a&&(a.disabled=!i,a.onclick=()=>{if(e.length>=o){G("Limit reached");return}e.push(ht()),d();try{Qe({type:"note_added",caseId:re,noteSection:t})}catch{}c()});const c=()=>{n.innerHTML="",e.forEach((r,s)=>{const p=document.createElement("div");p.className="note-item",p.dataset.id=r.id;const u=document.createElement("input");u.type="text",u.className="note-item-header",u.placeholder="Header",u.value=r.title||"";const m=document.createElement("textarea");m.className="note-item-body",m.placeholder="Add detailsâ€¦",m.value=r.body||"";const k=document.createElement("div");k.className="note-actions";const b=document.createElement("button");b.type="button",b.className="icon-btn small",b.textContent="â†‘",b.title="Move up",b.disabled=s===0;const y=document.createElement("button");y.type="button",y.className="icon-btn small",y.textContent="â†“",y.title="Move down",y.disabled=s===e.length-1;const D=document.createElement("button");D.type="button",D.className="icon-btn small delete-btn",D.textContent="ðŸ—‘",D.title="Delete",k.appendChild(b),k.appendChild(y),k.appendChild(D),p.appendChild(u),p.appendChild(m),p.appendChild(k),n.appendChild(p),u.addEventListener("blur",()=>{r.title=u.value,l()}),m.addEventListener("blur",()=>{r.body=m.value,l()}),b.addEventListener("click",()=>{const M=e[s-1];e[s-1]=e[s],e[s]=M,d(),c()}),y.addEventListener("click",()=>{const M=e[s+1];e[s+1]=e[s],e[s]=M,d(),c()}),D.addEventListener("click",()=>{e.splice(s,1),d(),c()})})},d=async()=>{try{await zn(re,t,e)}catch(r){console.error("save items",r),G("Failed to save")}a&&(a.disabled=e.length>=o)};let h=null;const l=()=>{clearTimeout(h),h=setTimeout(d,500)};c()}function Ao(){Xe.addEventListener("click",()=>cn("tasks")),Ct.addEventListener("click",()=>cn("notes"))}function Bo(){try{return window.matchMedia("(min-width: 900px)").matches}catch{return!1}}function sn(){const n=document.getElementById("tasks"),t=document.getElementById("notes");if(!(!n||!t))if(Bo())n.hidden=!1,t.hidden=!1;else{const e=Xe&&Xe.classList.contains("active");n.hidden=!e,t.hidden=e}}function cn(n){const t=n==="tasks";Xe&&(Xe.classList.toggle("active",t),Xe.setAttribute("aria-selected",String(t))),Ct&&(Ct.classList.toggle("active",!t),Ct.setAttribute("aria-selected",String(!t))),sn()}function ze(){if(Jt){Zt=!0;return}if(!gt)return;const n=o=>o==="high"?3:o==="medium"?2:o==="low"?1:0;let t=Rn.filter(o=>{const a=o.data&&o.data.priority||"",i=!Pt.size||Pt.has(o.status),c=$t==="all"||a===$t,d=!Rt||o.text.toLowerCase().includes(Rt.toLowerCase());return i&&c&&d}),e;if(Et==="pri-asc"||Et==="pri-desc")e=[...t].sort((o,a)=>{const i=o.data&&o.data.priority||"",c=a.data&&a.data.priority||"";return Et==="pri-asc"?n(i)-n(c):n(c)-n(i)});else{const o=new Map((Hn||[]).map((a,i)=>[a,i]));e=[...t].sort((a,i)=>(o.get(a.id)??999999)-(o.get(i.id)??999999))}gt.innerHTML="";for(const o of e){const a=it&&o.id===it;gt.appendChild(Fo(o,{openComments:a}))}if(it){const o=document.getElementById("task-"+it);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("flash-highlight"),setTimeout(()=>o.classList.remove("flash-highlight"),1400)),it=null}}function Fo(n,t={}){const{caseId:e,id:o,text:a,status:i,data:c}=n,d=document.createElement("li"),h=i==="in progress"?"s-inprogress":i==="complete"?"s-complete":"s-open";d.className="case-task "+h,d.id="task-"+o;const l=document.createElement("button");l.type="button",l.className="status-btn";const f=B=>B==="complete"?"â˜‘":B==="in progress"?"â—":"â˜";l.textContent=f(i),l.setAttribute("aria-label",`Task status: ${i}`),l.addEventListener("click",async B=>{var Z;B.stopPropagation();const A=["open","in progress","complete"],H=A[(A.indexOf(((Z=l.getAttribute("aria-label"))==null?void 0:Z.split(": ")[1])||i)+1)%A.length];try{const{cipher:K,iv:x}=await ne(H);if(await ae(Y(I,"cases",e,"tasks",o),{statusCipher:K,statusIv:x}),l.textContent=f(H),l.setAttribute("aria-label",`Task status: ${H}`),d.className="case-task "+(H==="in progress"?"s-inprogress":H==="complete"?"s-complete":"s-open"),H==="complete")try{const O=await ne(r.textContent||"");await Qe({type:"task_completed",caseId:e,taskId:o,taskTextCipher:O.cipher,taskTextIv:O.iv})}catch{}}catch(K){console.error("Failed to update status",K),G("Failed to update status")}});const r=document.createElement("span");if(r.className="task-text",r.textContent=a,r.addEventListener("click",B=>{B.stopPropagation(),Jt=!0;const A=document.createElement("div");A.className="cell-editable",A.setAttribute("contenteditable","true"),A.textContent=a;let H=a;const Z=()=>{try{A.remove()}catch{}r.style.display="",Jt=!1,Zt&&(Zt=!1,ze())},K=async()=>{const x=(A.innerText||"").replace(/\r/g,"");if(x===H){Z();return}try{const{cipher:O,iv:$}=await ne(x);await ae(Y(I,"cases",e,"tasks",o),{textCipher:O,textIv:$}),H=x,r.textContent=x}catch(O){console.error("Failed to update task",O),G("Failed to update task")}Z()};A.addEventListener("paste",x=>{x.preventDefault();const O=(x.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,O);else{const $=window.getSelection();$&&$.rangeCount&&($.deleteFromDocument(),$.getRangeAt(0).insertNode(document.createTextNode(O)))}}),A.addEventListener("keydown",x=>{x.key==="Enter"&&!(x.ctrlKey||x.metaKey)?(x.preventDefault(),K()):x.key==="Escape"&&(x.preventDefault(),Z())}),A.addEventListener("blur",()=>{K()}),r.insertAdjacentElement("afterend",A),r.style.display="none",A.focus()}),d.appendChild(l),d.appendChild(r),c.priority){const B=document.createElement("span");B.className="mini-chip",B.textContent=c.priority,d.appendChild(B)}const s=document.createElement("span");s.className="mini-avatar";const p=c.assignee?c.assignee.split(/\s+/).map(B=>B[0]).join("").slice(0,2).toUpperCase():"";s.textContent=p||"";const u=dn(c.assignee||"");s.style.background=u.bg,s.style.color=u.color,s.style.border=`1px solid ${u.border}`;let m=null;const k=()=>{m&&(m.remove(),m=null)};s.addEventListener("mouseenter",()=>{if(!c.assignee)return;m=document.createElement("div"),m.className="assignee-tip",m.textContent=c.assignee,m.style.position="fixed",m.style.zIndex="2147483647",document.body.appendChild(m);const B=s.getBoundingClientRect();requestAnimationFrame(()=>{const A=m.offsetHeight||24;m.style.left=`${Math.round(B.left+B.width/2)}px`,m.style.top=`${Math.round(B.top-6-A)}px`,m.style.transform="translateX(-50%)"})}),s.addEventListener("mouseleave",k),s.addEventListener("click",B=>{B.stopPropagation(),k();const A=document.querySelector(".assignee-panel");A&&A.remove();const H=document.createElement("div");H.className="assignee-panel",H.style.position="fixed",H.style.zIndex="2147483646";const Z=(O,$)=>{const w=document.createElement("button");w.type="button",w.className="assignee-option",w.textContent=O,w.addEventListener("click",async _=>{_.stopPropagation();try{await ae(Y(I,"cases",e,"tasks",o),{assignee:$}),ze()}catch(g){console.error("Failed to reassign",g),G("Failed to reassign")}finally{H.remove()}}),H.appendChild(w)};Z("Unassigned",null);for(const O of Ye)Z(O.username,O.username);document.body.appendChild(H);const K=s.getBoundingClientRect();requestAnimationFrame(()=>{const O=H.offsetWidth||180,$=Math.min(Math.max(8,K.right-O),window.innerWidth-O-8),w=Math.min(window.innerHeight-H.offsetHeight-8,K.bottom+6);H.style.left=`${Math.round($)}px`,H.style.top=`${Math.round(w)}px`});const x=O=>{!H||H.contains(O.target)||O.target===s||(H.remove(),document.removeEventListener("click",x,!0))};setTimeout(()=>document.addEventListener("click",x,!0),0)}),d.appendChild(s);const b=document.createElement("button");b.type="button",b.className="icon-btn comment-toggle",b.setAttribute("aria-label","Show comments"),b.textContent="ðŸ’¬";const y=document.createElement("span");y.className="badge comment-count",d.appendChild(b),d.appendChild(y);const D=document.createElement("div");D.className="comment-section",D.hidden=!(t&&t.openComments);const M=document.createElement("ul");M.className="comments",D.appendChild(M);const S=document.createElement("form");S.className="comment-form";const W=document.createElement("input");W.placeholder="Add comment",S.appendChild(W);const F=document.createElement("button");F.className="icon-btn add-comment-btn",F.type="submit",F.textContent="âž•",F.setAttribute("aria-label","Add comment"),S.appendChild(F),D.appendChild(S);let L=!1,q=0;const U=()=>{y.textContent=q>0?String(q):"",b.setAttribute("aria-label",D.hidden?"Show comments":"Hide comments"),b.textContent=D.hidden?"ðŸ’¬":"âœ–"};return U(),!D.hidden&&!L&&(bt(e,o,M,B=>{q=B,U()}),L=!0),b.addEventListener("click",()=>{const B=D.hidden;D.hidden=!B,U(),B&&!L&&(bt(e,o,M,A=>{q=A,U()}),L=!0)}),S.addEventListener("submit",async B=>{B.preventDefault();const A=W.value.trim();if(!A)return;const H=document.createElement("li");H.className="optimistic";const Z=document.createElement("span");Z.textContent=me?`${me}: ${A}`:A,H.appendChild(Z),M.appendChild(H),W.value="",D.hidden=!1,U();try{const{cipher:K,iv:x}=await ne(A);await Ae(oe(I,"cases",e,"tasks",o,"comments"),{cipher:K,iv:x,username:me,createdAt:We()});try{await Qe({type:"comment_added",caseId:e,taskId:o,commentCipher:K,commentIv:x})}catch{}L||(bt(e,o,M,O=>{q=O,U()}),L=!0)}catch{H.classList.add("failed"),G("Failed to add comment")}}),d.appendChild(D),d}function Mo(){_t&&_t.addEventListener("submit",async n=>{n.preventDefault();const t=zt.value.trim();if(!t)return;const{cipher:e,iv:o}=await ne(t),a=ft&&ft.value||null;await Ae(oe(I,"cases"),{titleCipher:e,titleIv:o,createdAt:We(),username:me,location:a}),zt.value="",ft&&(ft.value="")})}function Do(){jn(),document.getElementById("task-input")&&document.getElementById("composer-opts")&&document.getElementById("task-input").addEventListener("focus",()=>{document.getElementById("composer-opts").hidden=!1}),xn.addEventListener("submit",async n=>{if(n.preventDefault(),!re)return;const t=jt.value.trim(),e="open";if(!t)return;const{cipher:o,iv:a}=await ne(t),{cipher:i,iv:c}=await ne(e),d=document.getElementById("task-assignee"),h=document.getElementById("task-priority"),l=d&&d.value||null,f=h&&h.value||null,r=await Ae(oe(I,"cases",re,"tasks"),{textCipher:o,textIv:a,statusCipher:i,statusIv:c,createdAt:We(),username:me,assignee:l,priority:f});try{await Qe({type:"task_added",caseId:re,taskId:r.id,taskTextCipher:o,taskTextIv:a,assignee:l,priority:f})}catch{}jt.value="",d&&(d.value=""),h&&(h.value="")})}function jn(){const n=document.getElementById("task-assignee");if(!n)return;const t=n.value;n.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="Unassigned",n.appendChild(e);for(const o of Ye){const a=document.createElement("option");a.value=o.username,a.textContent=o.username,n.appendChild(a)}n.value=t||""}window.addEventListener("DOMContentLoaded",async()=>{document.getElementById("case-list"),Ie=document.getElementById("case-list-section"),_t=document.getElementById("case-form"),zt=document.getElementById("case-input"),ft=document.getElementById("case-location"),ve=document.getElementById("case-detail"),Ve=document.getElementById("case-title"),$e=document.getElementById("updates-section"),Dt=document.getElementById("updates-list"),yn=document.getElementById("back-btn"),xn=document.getElementById("task-form"),jt=document.getElementById("task-input"),gt=document.getElementById("task-list"),document.getElementById("task-assignee"),document.getElementById("task-priority"),document.getElementById("composer-opts"),Ln=document.getElementById("colA-input"),Nn=document.getElementById("colB-input"),Tn=document.getElementById("colC-input"),In=document.getElementById("colD-input"),Sn=document.getElementById("colE-input"),An=document.getElementById("colF-input"),Bn=document.getElementById("colA-body"),Fn=document.getElementById("colB-body"),Mn=document.getElementById("colC-body"),Dn=document.getElementById("colD-body"),Pn=document.getElementById("colE-body"),Xe=document.getElementById("tab-tasks"),Ct=document.getElementById("tab-notes");const n=document.getElementById("tab-table");document.getElementById("tab-cases");const t=document.getElementById("tab-my"),e=document.getElementById("tab-updates");qe=document.getElementById("user-detail"),Gt=document.getElementById("user-title"),rt=document.getElementById("user-task-list"),Wt=document.getElementById("user-back-btn"),Kt=document.getElementById("brand-home");const o=document.getElementById("case-header-actions");if(o&&!document.getElementById("case-overflow-btn")){const l=document.createElement("button");l.id="case-overflow-btn",l.className="icon-btn case-overflow-btn",l.type="button",l.setAttribute("aria-haspopup","true"),l.setAttribute("aria-expanded","false"),l.textContent="â‹¯";const f=document.createElement("div");f.id="case-overflow-panel",f.className="case-overflow-panel",f.hidden=!0,((p,u,m=!1)=>{const k=document.createElement("button");k.type="button",k.className="case-overflow-item"+(m?" delete":""),k.textContent=p,k.addEventListener("click",b=>{b.stopPropagation(),u(),f.hidden=!0,l.setAttribute("aria-expanded","false")}),f.appendChild(k)})("Delete case",async()=>{if(re&&confirm("Delete this case and all its items?"))try{await Vn(re),re=null,ve.hidden=!0,se&&(se.hidden=!1),G("Case deleted")}catch(p){console.error("Failed to delete case",p),G("Failed to delete case")}},!0),o.appendChild(l),o.appendChild(f);const s=p=>{f.hidden=!p,l.setAttribute("aria-expanded",String(p))};l.addEventListener("click",p=>{p.stopPropagation(),s(f.hidden)}),document.addEventListener("click",p=>{!f.hidden&&p.target!==l&&!f.contains(p.target)&&s(!1)},!0)}document.getElementById("user-filter"),tn=Array.from(document.querySelectorAll(".user-status")),nn=document.getElementById("user-priority-filter"),on=document.getElementById("user-sort"),se=document.getElementById("table-section"),Me=document.getElementById("table-root");const a=document.getElementById("hide-filters-btn"),i=document.getElementById("show-filters-btn"),c=document.getElementById("print-open-btn");be=document.getElementById("filter-location"),we=document.getElementById("filter-consultant"),ct=document.getElementById("sort-by-tag"),Vt=document.getElementById("clear-tag-filters"),Mo(),Do(),To(),Ao(),sn(),window.addEventListener("resize",sn),n&&n.addEventListener("click",()=>Ft("table")),e&&e.addEventListener("click",()=>Ft("updates")),t&&t.addEventListener("click",()=>Ft("my"));const d="tableFiltersHidden";a&&a.addEventListener("click",()=>vt(!0)),i&&i.addEventListener("click",()=>vt(!1));try{const l=localStorage.getItem(d)==="1";vt(l)}catch{}co(),c&&c.addEventListener("click",()=>{const f=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><div class="print-header">Printed ${new Date().toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}</div><section id="table-section">${Me?Me.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,r=window.open("","_blank");if(!r){G("Pop-up blocked. Allow pop-ups to print.");return}r.document.open(),r.document.write(f),r.document.close()}),c&&c.addEventListener("click",()=>{const l=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><section id="table-section">${Me?Me.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,f=window.open("","_blank");if(!f){G("Pop-up blocked. Allow pop-ups to print.");return}f.document.open(),f.document.write(l),f.document.close()}),yn.addEventListener("click",()=>{if(Xt==="user"&&qe)ke&&(ke(),ke=null),Re&&(Re(),Re=null),Ee&&(Ee(),Ee=null),re=null,ve.hidden=!0,qe.hidden=!1,Ie&&(Ie.style.display="none"),Xt="list";else{ke&&(ke(),ke=null),Re&&(Re(),Re=null),Ee&&(Ee(),Ee=null),re=null,ve.hidden=!0,se&&(se.hidden=!1);try{window.scrollTo(0,$n||0);const l=new URL(window.location.href);l.searchParams.delete("case"),window.history.pushState({},"",l.toString())}catch{}}}),Wt&&Wt.addEventListener("click",()=>{if(qe.hidden=!0,re?(ve.hidden=!1,Ie&&(Ie.style.display="none")):se&&(se.hidden=!1),Array.isArray(Ge)){for(const l of Ge)try{l()}catch{}Ge=[]}}),Kt&&(Kt.addEventListener("click",()=>{se&&(se.hidden=!1),ve.hidden=!0,qe.hidden=!0}),document.addEventListener("taskToolbar:status",l=>{const f=l&&l.detail||{};Pt=new Set((f.statuses||[]).map(String)),ze()}),document.addEventListener("taskToolbar:priority",l=>{$t=l&&l.detail&&l.detail.priority||"all",ze()}),document.addEventListener("taskToolbar:sort",l=>{Et=l&&l.detail&&l.detail.sort||"none",ze()}),document.addEventListener("taskToolbar:search",l=>{Rt=l&&l.detail&&l.detail.query||"",ze()}),document.addEventListener("taskToolbar:clear",()=>{Pt=new Set(["open","in progress","complete"]),$t="all",Et="none",Rt="",ze()})),document.addEventListener("userToolbar:status",l=>{const f=l&&l.detail||{};De=new Set((f.statuses||[]).map(String)),st(),He()}),document.addEventListener("userToolbar:priority",l=>{Ue=l&&l.detail&&l.detail.priority||"all",st(),He()}),document.addEventListener("userToolbar:sort",l=>{Oe=l&&l.detail&&l.detail.sort||"none",st(),He()}),document.addEventListener("userToolbar:search",l=>{je=l&&l.detail&&l.detail.query||"",st(),He()}),document.addEventListener("userToolbar:assignee",l=>{he=l&&l.detail&&l.detail.assignee||"me",st(),Xn();const r=rn.get(pn());r&&r.perCase&&r.titles&&(Je=new Map(r.perCase),Ce=new Map(r.titles),He()),Yn(Ze||me)}),document.addEventListener("userToolbar:clear",()=>{De=new Set(["open","in progress","complete"]),Ue="all",Oe="none",st(),He()});try{await no(ao)}catch(l){console.error("Failed to sign in anonymously",l);return}const h=prompt("Enter shared passphrase");if(h&&(ln=await io(h),me=await On(),!!me)){mo(),po(),xo(),be&&Array.from(be.options).forEach(l=>{l.selected=j.location.has(l.value)}),we&&Array.from(we.options).forEach(l=>{l.selected=j.consultant.has(l.value)}),Po(),Ft("table");try{const f=new URL(window.location.href).searchParams.get("case");f&&wt(f,"Case","table","notes")}catch{}window.addEventListener("popstate",()=>{try{const f=new URL(window.location.href).searchParams.get("case");f?re!==f&&wt(f,"Case","table","notes"):(ve.hidden=!0,se&&(se.hidden=!1))}catch{}})}});function G(n){const t=document.getElementById("toast-container");if(!t)return;const e=document.createElement("div");e.className="toast",e.textContent=n,t.appendChild(e),setTimeout(()=>{e.remove()},3300)}async function Vn(n){const t=await yt(oe(I,"cases",n,"tasks"));for(const o of t.docs){const a=await yt(oe(I,"cases",n,"tasks",o.id,"comments"));await Promise.all(a.docs.map(i=>xe(Y(I,"cases",n,"tasks",o.id,"comments",i.id)))),await xe(Y(I,"cases",n,"tasks",o.id))}const e=await yt(oe(I,"cases",n,"notes"));await Promise.all(e.docs.map(o=>xe(Y(I,"cases",n,"notes",o.id)))),await xe(Y(I,"cases",n))}function Po(){const n=document.getElementById("user-list"),t=document.getElementById("add-user-btn"),e=document.getElementById("users-menu"),o=document.getElementById("users-btn"),a=document.getElementById("location-list"),i=document.getElementById("add-location-btn"),c=document.getElementById("manage-tags-btn");if(!n||!t||!e||!o||!a||!i)return;const d=r=>{e.hidden=!r,o.setAttribute("aria-expanded",String(r))};o.addEventListener("click",r=>{r.stopPropagation(),d(e.hidden)}),document.addEventListener("click",r=>{!e.hidden&&!e.contains(r.target)&&r.target!==o&&d(!1)}),t.addEventListener("click",async r=>{r.stopPropagation();const s=(prompt("Add user name")||"").trim();s&&await Ae(oe(I,"users"),{username:s,createdAt:We()})}),c&&c.addEventListener("click",r=>{r.stopPropagation(),d(!1),f()});const h=ye(oe(I,"users"),Be("username"));At&&(At(),At=null),At=Le(h,r=>{n.innerHTML="",Ye=[];for(const s of r.docs){const u=s.data().username||"Unknown";Ye.push({id:s.id,username:u});const m=document.createElement("li"),k=document.createElement("button");k.className="name icon-btn",k.textContent=u,k.addEventListener("click",()=>{d(!1),me=u,un(u)});const b=document.createElement("button");b.className="icon-btn",b.textContent="âœï¸",b.setAttribute("aria-label",`Edit ${u}`),b.addEventListener("click",async D=>{D.stopPropagation();const M=(prompt("Edit user name",u)||"").trim();!M||M===u||await ae(Y(I,"users",s.id),{username:M})});const y=document.createElement("button");y.className="icon-btn delete-btn",y.textContent="ðŸ—‘",y.setAttribute("aria-label",`Delete ${u}`),y.addEventListener("click",async D=>{D.stopPropagation(),confirm(`Delete user '${u}'?`)&&await xe(Y(I,"users",s.id))}),m.appendChild(k),m.appendChild(b),m.appendChild(y),n.appendChild(m)}jn();try{const s=Ye.map(p=>p.username);document.dispatchEvent(new CustomEvent("userToolbar:users",{detail:{users:s}}))}catch{}});const l=ye(oe(I,"locations"),Be("name"));Bt&&(Bt(),Bt=null),Bt=Le(l,r=>{a.innerHTML="",Yt=[];for(const s of r.docs){const u=(s.data().name||"").trim()||"Unnamed";Yt.push({id:s.id,name:u});const m=document.createElement("li"),k=document.createElement("button");k.className="name icon-btn",k.textContent=u;const b=document.createElement("button");b.className="icon-btn",b.textContent="âœï¸",b.setAttribute("aria-label",`Edit ${u}`),b.addEventListener("click",async D=>{D.stopPropagation();const M=(prompt("Edit location",u)||"").trim();if(!(!M||M===u))try{await ae(Y(I,"locations",s.id),{name:M})}catch(S){console.error("Failed to update location",S),G("Failed to update location (permissions)")}});const y=document.createElement("button");y.className="icon-btn delete-btn",y.textContent="ðŸ—‘",y.setAttribute("aria-label",`Delete ${u}`),y.addEventListener("click",async D=>{if(D.stopPropagation(),!!confirm(`Delete location '${u}'?`))try{await xe(Y(I,"locations",s.id))}catch(M){console.error("Failed to delete location",M),G("Failed to delete location (permissions)")}}),m.appendChild(k),m.appendChild(b),m.appendChild(y),a.appendChild(m)}$o()},r=>{console.error("Locations listener error",r),G("Cannot access locations (permissions)")});function f(){const r=document.createElement("div");r.className="modal-overlay";const s=document.createElement("div");s.className="modal tags-manager",r.appendChild(s);const p=document.createElement("h3");p.textContent="Manage Tags",s.appendChild(p);const u=document.createElement("div");u.className="tabs";const m=document.createElement("button");m.className="tab active",m.textContent="Locations",u.appendChild(m);const k=document.createElement("button");k.className="tab",k.textContent="Consultants",u.appendChild(k),s.appendChild(u);const b=document.createElement("div");s.appendChild(b);const y=document.createElement("div");y.className="section-actions",s.appendChild(y);const D=document.createElement("button");D.className="btn",D.textContent="Close",y.appendChild(D),document.body.appendChild(r);const M=U=>{m.classList.toggle("active",U==="loc"),k.classList.toggle("active",U==="cons"),L(U)};m.addEventListener("click",()=>M("loc")),k.addEventListener("click",()=>M("cons")),D.addEventListener("click",()=>r.remove());const S=()=>{const U=m.classList.contains("active")?"loc":"cons";L(U)},W=U=>{m.classList.contains("active")&&L("loc")};document.addEventListener("tags:updated",S),document.addEventListener("subtags:updated",W);const F=()=>{document.removeEventListener("tags:updated",S),document.removeEventListener("subtags:updated",W)};D.addEventListener("click",F,{once:!0}),M("loc");async function L(U){var P;if(b.innerHTML="",U==="cons"){q("consultant");return}const B=document.createElement("div");B.className="grid",b.appendChild(B);const A=document.createElement("div");A.className="tags-list",B.appendChild(A);const H=document.createElement("div");H.className="rooms-list",B.appendChild(H);const Z=document.createElement("h4");Z.textContent="Wards",A.appendChild(Z);const K=document.createElement("h4");K.textContent="Rooms",H.appendChild(K);const x=document.createElement("div");A.appendChild(x);const O=document.createElement("div");O.className="section-actions",A.appendChild(O);const $=document.createElement("button");$.textContent="Add ward",$.className="btn",O.appendChild($);let w=((P=(ce.get("location")||[])[0])==null?void 0:P.id)||"";function _(){x.innerHTML="";const E=ce.get("location")||[];for(let v=0;v<E.length;v++){const N=E[v],C=document.createElement("div");C.className="entry";const T=document.createElement("span");T.className="name",T.textContent=`${v+1}. ${N.name}`,C.appendChild(T),C.addEventListener("click",()=>{w=N.id,g()});const R=document.createElement("div");R.className="row-actions";const X=document.createElement("button");X.textContent="â†‘",X.addEventListener("click",()=>Mt("location",v,-1)),R.appendChild(X);const V=document.createElement("button");V.textContent="â†“",V.addEventListener("click",()=>Mt("location",v,1)),R.appendChild(V);const ee=document.createElement("button");ee.textContent="Edit",ee.addEventListener("click",()=>En(N.id,N.name)),R.appendChild(ee);const z=document.createElement("button");z.textContent="Delete",z.addEventListener("click",()=>vn("location",N.id)),R.appendChild(z),C.appendChild(R),x.appendChild(C)}}_(),$.addEventListener("click",()=>qt("location"));async function g(){H.innerHTML="";const E=document.createElement("h4");E.textContent="Rooms",H.appendChild(E);const v=document.createElement("div");H.appendChild(v);const N=await mn(w);for(let R=0;R<N.length;R++){const X=N[R],V=document.createElement("div");V.className="entry";const ee=document.createElement("span");ee.className="name",ee.textContent=`${R+1}. ${X.name}`,V.appendChild(ee);const z=document.createElement("div");z.className="row-actions";const J=document.createElement("button");J.textContent="â†‘",J.addEventListener("click",()=>bn(w,R,-1)),z.appendChild(J);const te=document.createElement("button");te.textContent="â†“",te.addEventListener("click",()=>bn(w,R,1)),z.appendChild(te);const Q=document.createElement("button");Q.textContent="Edit",Q.addEventListener("click",()=>Ro(w,X.id,X.name)),z.appendChild(Q);const fe=document.createElement("button");fe.textContent="Delete",fe.addEventListener("click",()=>Ho(w,X.id)),z.appendChild(fe),V.appendChild(z),v.appendChild(V)}const C=document.createElement("div");C.className="section-actions",H.appendChild(C);const T=document.createElement("button");T.className="btn",T.textContent="Add room",T.addEventListener("click",()=>Gn(w)),C.appendChild(T)}g()}function q(U){b.innerHTML="";const B=document.createElement("div");B.className="tags-list",b.appendChild(B);const A=document.createElement("h4");A.textContent="Consultants",B.appendChild(A);const H=document.createElement("div");B.appendChild(H);const Z=ce.get(U)||[];for(let O=0;O<Z.length;O++){const $=Z[O],w=document.createElement("div");w.className="entry";const _=document.createElement("span");_.className="name",_.textContent=`${O+1}. ${$.name}`,w.appendChild(_);const g=document.createElement("div");g.className="row-actions";const P=document.createElement("button");P.textContent="â†‘",P.addEventListener("click",()=>Mt(U,O,-1)),g.appendChild(P);const E=document.createElement("button");E.textContent="â†“",E.addEventListener("click",()=>Mt(U,O,1)),g.appendChild(E);const v=document.createElement("button");v.textContent="Edit",v.addEventListener("click",()=>En($.id,$.name)),g.appendChild(v);const N=document.createElement("button");N.textContent="Delete",N.addEventListener("click",()=>vn(U,$.id)),g.appendChild(N),w.appendChild(g),H.appendChild(w)}const K=document.createElement("div");K.className="section-actions",B.appendChild(K);const x=document.createElement("button");x.className="btn",x.textContent="Add",x.addEventListener("click",()=>qt(U)),K.appendChild(x)}}i.addEventListener("click",async r=>{r.stopPropagation();const s=(prompt("Add location name")||"").trim();if(s)try{await Ae(oe(I,"locations"),{name:s,createdAt:We()})}catch(p){console.error("Failed to add location",p),G("Failed to add location (permissions)")}})}function $o(){const n=document.getElementById("case-location");if(!n)return;const t=n.value;n.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="No location",n.appendChild(e);for(const o of Yt){const a=document.createElement("option");a.value=o.name,a.textContent=o.name,n.appendChild(a)}n.value=t||""}async function qt(n){try{const t=(prompt(`Add ${n}`)||"").trim();if(!t)return;const{cipher:e,iv:o}=await ne(t),a=ce.get(n)||[];await Ae(oe(I,"tags"),{type:n,order:a.length,nameCipher:e,nameIv:o})}catch(t){console.error("Failed to add tag",t),G("Failed to add tag")}}async function En(n,t){try{const e=(prompt("Rename",t)||"").trim();if(!e)return;const{cipher:o,iv:a}=await ne(e);await ae(Y(I,"tags",n),{nameCipher:o,nameIv:a})}catch(e){console.error("Failed to rename tag",e),G("Failed to rename")}}async function vn(n,t){try{if(!confirm("Delete tag and its rooms (if any)?"))return;const e=await yt(oe(I,"tags",t,"subtags"));for(const o of e.docs)await xe(Y(I,"tags",t,"subtags",o.id));await xe(Y(I,"tags",t))}catch(e){console.error("Failed to delete tag",e),G("Failed to delete")}}async function Mt(n,t,e){try{const o=(ce.get(n)||[]).slice(),a=t+e;if(a<0||a>=o.length)return;const i=o[t],c=o[a];await Promise.all([ae(Y(I,"tags",i.id),{order:a}),ae(Y(I,"tags",c.id),{order:t})])}catch(o){console.error("Failed to reorder",o),G("Failed to reorder")}}async function Gn(n){try{if(!n)return;const t=(prompt("Add room")||"").trim();if(!t)return;const{cipher:e,iv:o}=await ne(t),a=Se.get(n)||[];await Ae(oe(I,"tags",n,"subtags"),{type:"room",order:a.length,nameCipher:e,nameIv:o})}catch(t){console.error("Failed to add room",t),G("Failed to add room")}}async function Ro(n,t,e){try{const o=(prompt("Rename room",e)||"").trim();if(!o)return;const{cipher:a,iv:i}=await ne(o);await ae(Y(I,"tags",n,"subtags",t),{nameCipher:a,nameIv:i})}catch(o){console.error("Failed to rename room",o),G("Failed to rename room")}}async function Ho(n,t){try{if(!confirm("Delete this room?"))return;await xe(Y(I,"tags",n,"subtags",t))}catch(e){console.error("Failed to delete room",e),G("Failed to delete room")}}async function bn(n,t,e){try{const o=(Se.get(n)||[]).slice(),a=t+e;if(a<0||a>=o.length)return;const i=o[t],c=o[a];await Promise.all([ae(Y(I,"tags",n,"subtags",i.id),{order:a}),ae(Y(I,"tags",n,"subtags",c.id),{order:t})])}catch(o){console.error("Failed to reorder room",o),G("Failed to reorder room")}}function un(n){Ze=n,Xn(),Ie&&(Ie.style.display="none"),ve.hidden=!0,qe.hidden=!1;const t=document.getElementById("change-user-link");t&&t.addEventListener("click",async()=>{const a=await On();a&&a!==me&&(me=a,un(a))},{once:!0});const e=qn.get(n);e&&typeof e=="object"?(De=new Set(e.statuses||["open","in progress","complete"]),Ue=e.priority||"all",Oe=e.sort||"none",je=e.search||"",he=e.assignee||"me"):(De=new Set(["open","in progress","complete"]),Ue="all",Oe="none",je="",he="me"),tn.length&&tn.forEach(a=>a.checked=De.has(a.value)),nn&&(nn.value=Ue),on&&(on.value=Oe),document.dispatchEvent(new CustomEvent("userToolbar:hydrate",{detail:{statuses:Array.from(De),priority:Ue,sort:Oe,search:je,assignee:he}}));const o=rn.get(pn());o&&o.perCase&&o.titles?(Je=new Map(o.perCase),Ce=new Map(o.titles),He()):rt&&(rt.innerHTML='<li style="list-style:none;color:var(--muted);padding:8px 0;">Loadingâ€¦</li>'),Yn(n)}function Xn(){if(!Gt)return;let n="";he==="all"?n="All tasks":he==="unassigned"?n="Unassigned tasks":he==="me"?n=`${me||Ze||"Me"}'s tasks`:he.startsWith("name:")&&(n=`${he.slice(5)}'s tasks`),Gt.innerHTML=`${n} <button id="change-user-link" class="change-user-link" type="button">(Change user)</button>`}function pn(){return he||"me"}function st(){Ze&&qn.set(Ze,{statuses:Array.from(De),priority:Ue,sort:Oe,search:je,assignee:he})}async function Yn(n){if(Array.isArray(Ge)){for(const a of Ge)try{a()}catch{}Ge=[]}Ce||(Ce=new Map),Je||(Je=new Map);let t=Qn(I,"tasks"),e;he==="all"?e=t:he==="unassigned"?e=ye(t,It("assignee","==",null)):he==="me"?e=ye(t,It("assignee","==",me||n)):he.startsWith("name:")?e=ye(t,It("assignee","==",he.slice(5))):e=ye(t,It("assignee","==",me||n));const o=Le(e,async a=>{try{const i=a.docs,c=new Map,d=[],h=[],l=new Set;for(const r of i){const s=r.data(),p=r.ref.parent&&r.ref.parent.parent,u=p?p.id:null;if(!u)continue;l.add(u);const m={taskId:r.id,caseId:u,assignee:s.assignee||null,priority:s.priority||null,text:null,status:null};h.push(m),d.push(Promise.all([ie(s.textCipher,s.textIv),ie(s.statusCipher,s.statusIv)]).then(([k,b])=>{m.text=k,m.status=b}).catch(k=>{console.error("Decrypt task failed",k)}))}await Promise.all(d);for(const r of h)!r||!r.caseId||!r.text||(c.has(r.caseId)||c.set(r.caseId,[]),c.get(r.caseId).push(r));const f=[];for(const r of l)Ce.has(r)||f.push(wn(Y(I,"cases",r)).then(async s=>{if(s.exists()){const p=s.data();try{const u=await ie(p.titleCipher,p.titleIv);Ce.set(r,u)}catch{Ce.set(r,"(case)")}}else Ce.set(r,"(case)")}).catch(()=>{Ce.set(r,"(case)")}));if(await Promise.all(f),Je=c,rn.set(pn(),{perCase:new Map(c),titles:new Map(Ce)}),Qt){en=!0;return}He()}catch(i){console.error("Failed to build user tasks view",i)}});Ge.push(o)}function He(){if(!rt)return;rt.innerHTML="";const n=Array.from(Je.keys()).sort((t,e)=>(Ce.get(t)||"").localeCompare(Ce.get(e)||""));for(const t of n){let e=Je.get(t)||[];if(De&&De.size&&(e=e.filter(s=>De.has(s.status))),Ue!=="all"&&(e=e.filter(s=>(s.priority||"")===Ue)),je&&je.trim()){const s=je.toLowerCase();e=e.filter(p=>(p.text||"").toLowerCase().includes(s))}if(e.length===0)continue;const o=Ce.get(t)||"(case)",a=document.createElement("div");a.className="card user-case-card";const i=document.createElement("div");i.className="user-case-header";const c=document.createElement("h3"),d=document.createElement("button");d.className="link-btn",d.textContent=o,d.setAttribute("aria-label",`Open case ${o}`),d.addEventListener("click",()=>wt(t,o,"user","notes")),c.appendChild(d),i.appendChild(c);const h=document.createElement("span");h.className="badge",h.textContent=String(e.length),i.appendChild(h),a.appendChild(i);const l=document.createElement("ul"),f=s=>s==="high"?3:s==="medium"?2:s==="low"?1:0;let r=[...e];Oe==="pri-desc"?r.sort((s,p)=>f(p.priority)-f(s.priority)):Oe==="pri-asc"&&r.sort((s,p)=>f(s.priority)-f(p.priority));for(const s of r){const p=document.createElement("li"),u=s.status==="in progress"?"s-inprogress":s.status==="complete"?"s-complete":"s-open";p.className="case-task "+u;const m=document.createElement("button");m.type="button",m.className="status-btn";const k=$=>$==="complete"?"â˜‘":$==="in progress"?"â—":"â˜";m.textContent=k(s.status),m.setAttribute("aria-label",`Task status: ${s.status}`),m.addEventListener("click",async $=>{$.stopPropagation();const w=["open","in progress","complete"],_=w[(w.indexOf(s.status)+1)%w.length];try{const{cipher:g,iv:P}=await ne(_);if(await ae(Y(I,"cases",t,"tasks",s.taskId),{statusCipher:g,statusIv:P}),s.status=_,m.textContent=k(_),m.setAttribute("aria-label",`Task status: ${_}`),p.className="case-task "+(_==="in progress"?"s-inprogress":_==="complete"?"s-complete":"s-open"),_==="complete")try{const E=await ne(s.text||"");await Qe({type:"task_completed",caseId:t,taskId:s.taskId,taskTextCipher:E.cipher,taskTextIv:E.iv})}catch{}}catch(g){console.error("Failed to update status",g),G("Failed to update status")}});const b=document.createElement("span");if(b.className="task-text",b.textContent=s.text,b.addEventListener("click",$=>{$.stopPropagation(),Qt=!0;const w=document.createElement("div");w.className="cell-editable",w.setAttribute("contenteditable","true"),w.textContent=s.text;let _=s.text;const g=()=>{try{w.remove()}catch{}b.style.display="",Qt=!1,en&&(en=!1,He())},P=async()=>{const E=(w.innerText||"").replace(/\r/g,"");if(E===_){g();return}try{const{cipher:v,iv:N}=await ne(E);await ae(Y(I,"cases",t,"tasks",s.taskId),{textCipher:v,textIv:N}),_=E,b.textContent=E}catch(v){console.error("Failed to update task",v),G("Failed to update task")}g()};w.addEventListener("paste",E=>{E.preventDefault();const v=(E.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,v);else{const N=window.getSelection();N&&N.rangeCount&&(N.deleteFromDocument(),N.getRangeAt(0).insertNode(document.createTextNode(v)))}}),w.addEventListener("keydown",E=>{E.key==="Enter"&&!(E.ctrlKey||E.metaKey)?(E.preventDefault(),P()):E.key==="Escape"&&(E.preventDefault(),g())}),w.addEventListener("blur",()=>{P()}),b.insertAdjacentElement("afterend",w),b.style.display="none",w.focus()}),p.appendChild(m),p.appendChild(b),s.priority){const $=document.createElement("span");$.className="mini-chip",$.textContent=s.priority,p.appendChild($)}const y=document.createElement("span");y.className="mini-avatar";const D=s.assignee?s.assignee.split(/\s+/).map($=>$[0]).join("").slice(0,2).toUpperCase():"";y.textContent=D||"";const M=dn(s.assignee||"");y.style.background=M.bg,y.style.color=M.color,y.style.border=`1px solid ${M.border}`;let S=null;const W=()=>{S&&(S.remove(),S=null)};y.addEventListener("mouseenter",()=>{if(!s.assignee)return;S=document.createElement("div"),S.className="assignee-tip",S.textContent=s.assignee,S.style.position="fixed",S.style.zIndex="2147483647",document.body.appendChild(S);const $=y.getBoundingClientRect();requestAnimationFrame(()=>{const w=S.offsetHeight||24;S.style.left=`${Math.round($.left+$.width/2)}px`,S.style.top=`${Math.round($.top-6-w)}px`,S.style.transform="translateX(-50%)"})}),y.addEventListener("mouseleave",W),y.addEventListener("click",$=>{$.stopPropagation(),W();const w=document.querySelector(".assignee-panel");w&&w.remove();const _=document.createElement("div");_.className="assignee-panel",_.style.position="fixed",_.style.zIndex="2147483646";const g=(v,N)=>{const C=document.createElement("button");C.type="button",C.className="assignee-option",C.textContent=v,C.addEventListener("click",async T=>{var R;T.stopPropagation();try{if(await ae(Y(I,"cases",t,"tasks",s.taskId),{assignee:N}),Ze&&N!==Ze){p.remove();const X=parseInt(((R=a.querySelector(".badge"))==null?void 0:R.textContent)||"1",10);!Number.isNaN(X)&&X>0&&(a.querySelector(".badge").textContent=String(X-1))}}catch(X){console.error("Failed to reassign",X),G("Failed to reassign")}finally{_.remove()}}),_.appendChild(C)};g("Unassigned",null);for(const v of Ye)g(v.username,v.username);document.body.appendChild(_);const P=y.getBoundingClientRect();requestAnimationFrame(()=>{const v=_.offsetWidth||180,N=Math.min(Math.max(8,P.right-v),window.innerWidth-v-8),C=Math.min(window.innerHeight-_.offsetHeight-8,P.bottom+6);_.style.left=`${Math.round(N)}px`,_.style.top=`${Math.round(C)}px`});const E=v=>{!_||_.contains(v.target)||v.target===y||(_.remove(),document.removeEventListener("click",E,!0))};setTimeout(()=>document.addEventListener("click",E,!0),0)}),p.appendChild(y);const F=document.createElement("button");F.type="button",F.className="icon-btn delete-btn",F.textContent="ðŸ—‘",F.title="Delete task",F.addEventListener("click",async $=>{if($.stopPropagation(),!!confirm("Delete this task?"))try{await xe(Y(I,"cases",t,"tasks",s.taskId)),p.remove();const w=a.querySelector(".badge");if(w){const _=parseInt(w.textContent||"1",10);!Number.isNaN(_)&&_>0&&(w.textContent=String(_-1))}}catch(w){console.error("Failed to delete task",w),G("Failed to delete task")}}),p.appendChild(F);const L=document.createElement("button");L.type="button",L.className="icon-btn comment-toggle",L.setAttribute("aria-label","Show comments"),L.textContent="ðŸ’¬";const q=document.createElement("span");q.className="badge comment-count",p.appendChild(L),p.appendChild(q);const U=document.createElement("div");U.className="comment-section",U.hidden=!0;const B=document.createElement("ul");B.className="comments",U.appendChild(B);const A=document.createElement("form");A.className="comment-form";const H=document.createElement("input");H.placeholder="Add comment",A.appendChild(H);const Z=document.createElement("button");Z.className="icon-btn add-comment-btn",Z.type="submit",Z.textContent="âž•",Z.setAttribute("aria-label","Add comment"),A.appendChild(Z),U.appendChild(A);let K=!1,x=0;const O=()=>{q.textContent=x>0?String(x):"",L.textContent=U.hidden?"ðŸ’¬":"âœ–",L.setAttribute("aria-label",U.hidden?"Show comments":"Hide comments")};O(),L.addEventListener("click",()=>{const $=U.hidden;U.hidden=!$,O(),$&&!K&&(bt(t,s.taskId,B,w=>{x=w,O()}),K=!0)}),A.addEventListener("submit",async $=>{$.preventDefault();const w=H.value.trim();if(!w)return;const _=document.createElement("li");_.className="optimistic";const g=document.createElement("span");g.textContent=me?`${me}: ${w}`:w,_.appendChild(g),B.appendChild(_),H.value="",U.hidden=!1,O();try{const{cipher:P,iv:E}=await ne(w);await Ae(oe(I,"cases",t,"tasks",s.taskId,"comments"),{cipher:P,iv:E,username:me,createdAt:We()});try{await Qe({type:"comment_added",caseId:t,taskId:s.taskId,commentCipher:P,commentIv:E})}catch{}K||(bt(t,s.taskId,B,v=>{x=v,O()}),K=!0)}catch{_.classList.add("failed"),G("Failed to add comment")}}),p.appendChild(U),l.appendChild(p)}a.appendChild(l),rt.appendChild(a)}}
