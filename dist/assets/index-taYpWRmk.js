import{initializeApp as la}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";import{getFirestore as da,addDoc as Me,collection as ae,serverTimestamp as Oe,query as Ce,orderBy as Ne,onSnapshot as Ie,updateDoc as se,doc as G,deleteDoc as xe,collectionGroup as ra,where as Ft,getDoc as Bn,getDocs as ut,limit as Fn}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import{getAuth as ma,signInAnonymously as ua}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();const pa={apiKey:"AIzaSyBo5a6Uxk1vJwS8WqFnccjSnNOOXreOhcg",authDomain:"catalist-1.firebaseapp.com",projectId:"catalist-1",storageBucket:"catalist-1.firebasestorage.app",messagingSenderId:"843924921323",appId:"1:843924921323:web:0e7a847f8cd70db55f57ae",measurementId:"G-6NZEC4ED4C"},Mn=la(pa),S=da(Mn),ha=ma(Mn);let Cn,me,Be,Jt,Zt,Et,ve,Qe,Ln,Dn,Qt,bt,Pn,$n,Rn,Hn,qn,Un,_n,On,Wn,Kn,zn,ce,Pe,we,Xe,je,Mt,Yt,Le,Te,rt,en,tt,xt,qe,tn,pt,Gt,Xt,ie=null,gt=!1,Dt=!1,Ht="list",jn=0,at=null,ge=null,ke=null,fe=null,Ke=null,Ee=null,qt=null,Tt=[],nn=new Map,an="",on="",de=null,pe=null,ct=new Map,Pt=null,$t=null,Ve=[],sn=[],et=[],Je=null,Ut=new Set(["open","in progress","complete"]),_t="all",kt="none",Ot="",Vn=[],Yn=null,nt=new Map,be=new Map,$e=new Set(["open","in progress","complete"]),Ue="all",_e="none",gn=new Map,ye="me",cn=!1,ln=!1,dn=!1,rn=!1,Ye="",mn=[],un,pn,Gn=new Map;const fa=["#fef3c7","#fde68a","#dcfce7","#bbf7d0","#dbeafe","#bfdbfe","#e0e7ff","#ddd6fe","#fae8ff","#fee2e2","#ffe4e6","#f3e8ff"];let mt=!0;function Tn(t){mt=!!t;const n=document.getElementById("table-section");n&&n.classList.toggle("cell-color-disabled",!t);try{localStorage.setItem("table.showCellColor",t?"1":"0")}catch{}if(!t){const e=document.querySelector(".color-panel");e&&e.remove()}}let le=new Map,Fe=new Map,K={location:new Set,consultant:new Set,room:new Set},re="none",Re="asc";function it(t){return Array.from(t||[]).join(",")}function lt(t){return new Set((t||"").split(",").map(n=>n.trim()).filter(Boolean))}function Ae(){try{localStorage.setItem("table.filters.location",it(K.location)),localStorage.setItem("table.filters.consultant",it(K.consultant)),localStorage.setItem("table.filters.room",it(K.room)),localStorage.setItem("table.sort.key",re||"none"),localStorage.setItem("table.sort.dir",Re||"asc")}catch{}try{const t=new URL(window.location.href),n=t.searchParams,e=(s,a)=>{a?n.set(s,a):n.delete(s)};e("loc",it(K.location)),e("cons",it(K.consultant)),e("room",it(K.room)),e("sort",re&&re!=="none"?re:""),e("dir",Re&&re!=="none"?Re:"");const o=t.toString();window.history.replaceState(null,"",o)}catch{}}function ya(){try{const n=new URL(window.location.href).searchParams,e=n.get("loc"),o=n.get("cons"),s=n.get("room"),a=n.get("sort"),c=n.get("dir");if(e||o||s||a){e&&(K.location=lt(e)),o&&(K.consultant=lt(o)),s&&(K.room=lt(s)),a&&(re=a),c&&(Re=c);return}}catch{}try{K.location=lt(localStorage.getItem("table.filters.location")),K.consultant=lt(localStorage.getItem("table.filters.consultant")),K.room=lt(localStorage.getItem("table.filters.room")),re=localStorage.getItem("table.sort.key")||"none",Re=localStorage.getItem("table.sort.dir")||"asc"}catch{}}function wt(t){const n=document.getElementById("table-tags-controls"),e=document.getElementById("table-section");if(!n||!e)return;let o=document.getElementById("filters-placeholder");if(t){n.style.display="none",o||(o=document.createElement("div"),o.id="filters-placeholder",o.className="filters-placeholder",e.insertBefore(o,document.getElementById("table-root"))),o.innerHTML="";const s=document.createElement("button");s.type="button",s.className="show-filters-btn",s.textContent="Show Filters",s.addEventListener("click",()=>wt(!1)),o.appendChild(s);try{localStorage.setItem("tableFiltersHidden","1")}catch{}}else{n.style.display="",o&&o.remove();try{localStorage.setItem("tableFiltersHidden","0")}catch{}}}async function Xn(){const t=document.createElement("div");t.className="modal-overlay";const n=document.createElement("div");n.className="modal",t.appendChild(n);const e=document.createElement("h3");e.textContent="New Case",n.appendChild(e);const o=document.createElement("div");o.className="stack",n.appendChild(o);const s=document.createElement("label");s.textContent="Title";const a=document.createElement("input");a.placeholder="Enter case title",a.setAttribute("aria-label","Case title"),s.appendChild(a),o.appendChild(s);const c=document.createElement("label");c.textContent="Location";const d=document.createElement("select");c.appendChild(d),o.appendChild(c);const f=document.createElement("label");f.textContent="Room";const l=document.createElement("select");f.appendChild(l),o.appendChild(f);const r=document.createElement("label");r.textContent="Consultant";const m=document.createElement("select");r.appendChild(m),o.appendChild(r);const i=document.createElement("div");i.className="actions";const h=document.createElement("button");h.className="btn",h.textContent="Cancel";const u=document.createElement("button");u.className="btn primary",u.textContent="Create",i.appendChild(h),i.appendChild(u),n.appendChild(i),document.body.appendChild(t);const p=(T,F,D=!0)=>{if(T.innerHTML="",D){const A=document.createElement("option");A.value="",A.textContent="Unassigned",T.appendChild(A)}for(const A of F){const U=document.createElement("option");U.value=A.id,U.textContent=A.name,T.appendChild(U)}},v=async()=>{const T=d.value||"";if(T){const F=await vn(T);p(l,F,!0)}else p(l,[],!0)};p(d,le.get("location")||[]),p(m,le.get("consultant")||[]);const C=Array.from(K.location||[]);C.length===1&&(d.value=C[0]);const E=Array.from(K.consultant||[]);E.length===1&&(m.value=E[0]),await v();const L=Array.from(K.room||[]);L.length===1&&(l.value=L[0]),d.addEventListener("change",async()=>{await v(),l.value=""});const x=()=>t.remove();h.addEventListener("click",x),u.addEventListener("click",async()=>{const T=(a.value||"").trim();if(!T){a.focus();return}try{const F=await ne(T),D={location:d.value||null,consultant:m.value||null},A=d.value||null,U=l.value||null;A&&U?D.room=U:D.room=null,await Me(ae(S,"cases"),{titleCipher:F.cipher,titleIv:F.iv,createdAt:Oe(),caseTags:D}),x(),j("Case created")}catch(F){console.error("Failed to create case",F),j("Failed to create case")}}),a.focus()}function En(t){if(!t)return{bg:"#e5e7eb",border:"#d1d5db",color:"#374151"};let n=0;for(let a=0;a<t.length;a++)n=(n*31+t.charCodeAt(a))%360;const e=`hsl(${n}, 70%, 90%)`,o=`hsl(${n}, 60%, 65%)`,s=`hsl(${n}, 40%, 25%)`;return{bg:e,border:o,color:s}}async function Ca(t){const n=new TextEncoder,e=n.encode("shared-salt"),o=await crypto.subtle.importKey("raw",n.encode(t),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function ga(t){return btoa(String.fromCharCode(...new Uint8Array(t)))}function Ea(t){return Uint8Array.from(atob(t),n=>n.charCodeAt(0))}async function ne(t){const n=new TextEncoder,e=crypto.getRandomValues(new Uint8Array(12)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},Cn,n.encode(t));return{cipher:ga(o),iv:Array.from(e)}}async function oe(t,n){const e=new TextDecoder,o=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(n)},Cn,Ea(t));return e.decode(o)}async function ht(t,n,e="list",o="notes"){ie=t,Ht=e==="user"?"user":e==="table"?"table":e==="updates"?"updates":"list",Qe.textContent=n,ce&&(ce.hidden=!0),we&&(we.hidden=!0),Be&&(Be.style.display="none"),qe.hidden=!0,ve.hidden=!1,wa(t),Ua(t),yn(o);try{const s=new URL(window.location.href);s.searchParams.set("case",t),window.history.pushState({caseId:t},"",s.toString())}catch{}}function Ze(t){const n=document.getElementById("tab-table"),e=document.getElementById("tab-my"),o=document.getElementById("tab-updates"),s=t==="table",a=t==="my",c=t==="updates";if(n&&(n.classList.toggle("active",s),n.setAttribute("aria-selected",String(s))),e&&(e.classList.toggle("active",a),e.setAttribute("aria-selected",String(a))),o&&(o.classList.toggle("active",c),o.setAttribute("aria-selected",String(c))),s){if(Be&&(Be.style.display="none"),ve.hidden=!0,qe.hidden=!0,we&&(we.hidden=!0),ce&&(ce.hidden=!1),Ke||Pa(),Ee){try{Ee()}catch{}Ee=null}}else if(a){if(ce&&(ce.hidden=!0),Ke&&(Ke(),Ke=null),we&&(we.hidden=!0),Ee){try{Ee()}catch{}Ee=null}bn(me)}else if(c)ce&&(ce.hidden=!0),Ke&&(Ke(),Ke=null),ve.hidden=!0,qe.hidden=!0,we&&(we.hidden=!1),Ee||Sa();else{if(we&&(we.hidden=!0),Ee){try{Ee()}catch{}Ee=null}ce&&(ce.hidden=!1)}}function Jn(){return new Promise(async t=>{const n=document.createElement("div");n.className="modal-overlay";const e=document.createElement("div");e.className="modal",n.appendChild(e);const o=document.createElement("h3");o.textContent="Select your user",e.appendChild(o);const s=document.createElement("div");s.className="row",e.appendChild(s);const a=document.createElement("select");a.style.height="48px",a.style.borderRadius="12px",a.style.border="1px solid #e5e7eb",a.style.padding="0 12px",s.appendChild(a);const c=document.createElement("div");c.className="actions",e.appendChild(c);const d=document.createElement("button");d.className="btn",d.textContent="Cancel",c.appendChild(d);const f=document.createElement("button");f.className="btn primary",f.textContent="Continue",c.appendChild(f),document.body.appendChild(n);let l=null;const r=i=>{const h=a.value;a.innerHTML="";for(const u of i){const p=document.createElement("option");p.value=u,p.textContent=u,a.appendChild(p)}h&&i.includes(h)&&(a.value=h)};try{const i=Ce(ae(S,"users"),Ne("username"));l=Ie(i,h=>{const u=h.docs.map(p=>(p.data().username||"").trim()).filter(Boolean);r(u)})}catch{const h=await ut(Ce(ae(S,"users"),Ne("username")));r(h.docs.map(u=>(u.data().username||"").trim()).filter(Boolean))}const m=()=>{l&&l(),n.remove()};d.addEventListener("click",()=>{m(),t("")}),f.addEventListener("click",()=>{const i=a.value||"";m(),t(i)}),a.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),f.click())}),a.focus()})}function va(){const t=Ce(ae(S,"tags"),Ne("order"));Ie(t,async n=>{const e=new Map;for(const o of n.docs){const s=o.data(),a=s.type||"";let c="";try{c=await oe(s.nameCipher,s.nameIv)}catch{}const d={id:o.id,name:c,order:typeof s.order=="number"?s.order:0,type:a};e.has(a)||e.set(a,[]),e.get(a).push(d)}for(const[o,s]of e)s.sort((a,c)=>a.order-c.order||a.name.localeCompare(c.name));le=e,ba(),document.dispatchEvent(new CustomEvent("tags:updated"))},n=>console.error("Tags listener error",n))}function vn(t){return t?Fe.has(t)?Promise.resolve(Fe.get(t)):new Promise(n=>{const e=Ce(ae(S,"tags",t,"subtags"),Ne("order"));Ie(e,async o=>{const s=[];for(const a of o.docs){const c=a.data();let d="";try{d=await oe(c.nameCipher,c.nameIv)}catch{}s.push({id:a.id,name:d,order:typeof c.order=="number"?c.order:0,type:c.type||"room"})}s.sort((a,c)=>a.order-c.order||a.name.localeCompare(c.name)),Fe.set(t,s),document.dispatchEvent(new CustomEvent("subtags:updated",{detail:{parentId:t}})),n(s)})}):Promise.resolve([])}function ba(){Le&&Nn(Le,le.get("location")||[]),Te&&Nn(Te,le.get("consultant")||[])}function Nn(t,n){const e=new Set(Array.from(t.selectedOptions||[]).map(o=>o.value));t.innerHTML="";for(const o of n){const s=document.createElement("option");s.value=o.id,s.textContent=o.name,t.appendChild(s)}for(const o of Array.from(t.options))e.has(o.value)&&(o.selected=!0)}function xa(){const t=()=>{ce&&!ce.hidden&&de&&pe&&pe(de)},n=()=>{K.location=new Set(Array.from((Le==null?void 0:Le.selectedOptions)||[]).map(e=>e.value)),K.consultant=new Set(Array.from((Te==null?void 0:Te.selectedOptions)||[]).map(e=>e.value)),Ae(),t()};Le&&Le.addEventListener("change",n),Te&&Te.addEventListener("change",n),rt&&rt.addEventListener("change",()=>{re=rt.value||"none",Ae(),t()}),en&&en.addEventListener("click",()=>{var e,o;K.location.clear(),K.consultant.clear(),(o=(e=K.room)==null?void 0:e.clear)==null||o.call(e),Le&&Array.from(Le.options).forEach(s=>s.selected=!1),Te&&Array.from(Te.options).forEach(s=>s.selected=!1),rt&&(rt.value="none"),re="none",Ae(),t()})}function ka(t){for(const n of["location","consultant","room"]){const e=K[n];if(e&&e.size){const o=t&&t[n];if(!o||!e.has(o))return!1}}return!0}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggle-all-tasks");if(!t)return;const n=()=>{document.querySelectorAll(".case-tasks-wrap").forEach(s=>{s.hidden=gt}),document.querySelectorAll(".case-tasks-toggle").forEach(s=>{s instanceof HTMLElement&&(s.id==="toggle-all-tasks"||s.id==="toggle-all-comments"||(s.textContent=gt?"Show tasks":"Hide tasks"))}),t.textContent=gt?"Expand all":"Collapse all"};t.addEventListener("click",()=>{gt=!gt,n()}),n()});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggle-all-comments");if(!t)return;const n=()=>{document.querySelectorAll(".case-mini-comments").forEach(o=>{o instanceof HTMLElement&&(o.hidden=Dt)}),t.textContent=Dt?"Show comments":"Hide comments"};t.addEventListener("click",()=>{Dt=!Dt,n()}),n()});function wa(t){const n=Ce(ae(S,"cases",t,"tasks"),Ne("createdAt","desc"));ge&&ge();let e=null;ge=Ie(n,async o=>{bt.innerHTML="";const s=[];for(const c of o.docs){const d=c.data();try{const f=await oe(d.textCipher,d.textIv),l=await oe(d.statusCipher,d.statusIv),r=d.createdAt&&d.createdAt.toMillis?d.createdAt.toMillis():0;s.push({docSnap:c,data:d,text:f,status:l,createdAt:r})}catch(f){console.error("Skipping undecryptable task",f)}}if(e)for(const c of s){const d=c.docSnap.id;e.includes(d)||e.unshift(d)}else{const c=f=>f==="open"?0:f==="in progress"?1:2;e=[...s].sort((f,l)=>{const r=c(f.status)-c(l.status);return r!==0?r:l.createdAt-f.createdAt}).map(f=>f.docSnap.id)}const a=new Map(e.map((c,d)=>[c,d]));s.sort((c,d)=>(a.get(c.docSnap.id)??999999)-(a.get(d.docSnap.id)??999999)),Yn=e.slice(),Vn=s.map(({docSnap:c,data:d,text:f,status:l,createdAt:r})=>({caseId:t,id:c.id,text:f,status:l,data:d,createdAt:r})),ze()})}function Lt(t,n,e,o){const s=Ce(ae(S,"cases",t,"tasks",n,"comments"),Ne("createdAt","asc"));Ie(s,async a=>{o&&o(a.size),e.innerHTML="";for(const c of a.docs){const{cipher:d,iv:f,username:l}=c.data();try{const r=await oe(d,f),m=document.createElement("li"),i=document.createElement("span");i.textContent=l?`${l}: ${r}`:r,m.appendChild(i);const h=document.createElement("div");h.className="case-actions";const u=document.createElement("button");u.className="icon-btn",u.textContent="‚úèÔ∏è",u.setAttribute("aria-label","Edit comment"),u.addEventListener("click",async()=>{const C=(prompt("Edit comment",r)||"").trim();if(!C)return;const{cipher:E,iv:L}=await ne(C);await se(G(S,"cases",t,"tasks",n,"comments",c.id),{cipher:E,iv:L}),j("Comment updated")}),h.appendChild(u);const p=document.createElement("button");p.className="icon-btn delete-btn",p.textContent="üóë",p.setAttribute("aria-label","Delete comment"),p.addEventListener("click",async()=>{confirm("Delete this comment?")&&(await xe(G(S,"cases",t,"tasks",n,"comments",c.id)),j("Comment deleted"))}),h.appendChild(p),m.appendChild(h),e.appendChild(m)}catch(r){console.error("Skipping undecryptable comment",r)}}},a=>console.error("Comments listener error",a))}async function Ge(t={}){try{const n={type:t.type,caseId:t.caseId||ie||"",username:me,createdAt:Oe()};let e=t.caseTitle||(typeof Qe<"u"&&Qe&&Qe.textContent?Qe.textContent:"Case");try{e=(e||"").trim()}catch{}const{cipher:o,iv:s}=await ne(e||"Case"),a={...n,caseTitleCipher:o,caseTitleIv:s},c=["taskId","taskTextCipher","taskTextIv","assignee","priority","commentCipher","commentIv","noteSection","noteTitleCipher","noteTitleIv","noteTextCipher","noteTextIv"];for(const d of c)t[d]!==void 0&&(a[d]=t[d]);await Me(ae(S,"updates"),a)}catch(n){console.error("Failed to log update",n)}}function La(t){var n;try{if(!t)return"";const e=t.toDate?t.toDate():t;return((n=e.toLocaleString)==null?void 0:n.call(e))||String(e)}catch{return""}}function Zn(t){try{const n=t.toDate?t.toDate():t,e=Date.now()-n.getTime(),o=Math.floor(e/1e3);if(o<60)return`${o}s ago`;const s=Math.floor(o/60);if(s<60)return`${s}m ago`;const a=Math.floor(s/60);return a<24?`${a}h ago`:`${Math.floor(a/24)}d ago`}catch{return""}}function Ta(t){try{const n=t.toDate?t.toDate():t;return n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0")}catch{return""}}function Na(t){var n;try{const e=t.toDate?t.toDate():t,o=new Date,s=new Date;s.setDate(o.getDate()-1);const a=(c,d)=>c.getFullYear()===d.getFullYear()&&c.getMonth()===d.getMonth()&&c.getDate()===d.getDate();return a(e,o)?"Today":a(e,s)?"Yesterday":((n=e.toLocaleDateString)==null?void 0:n.call(e,void 0,{weekday:"short",month:"short",day:"numeric"}))||e.toDateString()}catch{return""}}function Ia(t){const n=document.createElement("li");n.className="update-item";const e=document.createElement("div");e.className="update-icon",e.textContent=t.icon||"‚Ä¢";const o=document.createElement("div");o.className="update-content";const s=document.createElement("div");s.className="update-line";const a=document.createElement("span");a.className="who",a.textContent=t.username||"Someone";const c=document.createElement("a");c.href="#",c.className="link",c.style.textDecoration="none",c.style.color="inherit";const d=document.createElement("span");d.className="chip",d.textContent=t.caseTitle||"Case";const f=document.createDocumentFragment();if(f.appendChild(a),t.type==="task_added"){if(f.appendChild(document.createTextNode(" added ")),t.taskText){const r=document.createElement("span");r.className="task-name-chip",r.textContent=t.taskText,f.appendChild(r)}else f.appendChild(document.createTextNode("a task"));f.appendChild(document.createTextNode(" to ")),f.appendChild(d)}else if(t.type==="task_completed"){if(f.appendChild(document.createTextNode(" marked ")),t.taskText){const r=document.createElement("span");r.className="task-name-chip",r.textContent=t.taskText,f.appendChild(r)}else f.appendChild(document.createTextNode("a task"));f.appendChild(document.createTextNode(" as complete in ")),f.appendChild(d)}else if(t.type==="comment_added"){if(f.appendChild(document.createTextNode(" commented in ")),f.appendChild(d),t.comment){const r=document.createElement("span");r.className="chip",r.textContent=t.comment,r.style.maxWidth="220px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",f.appendChild(document.createTextNode(" ")),f.appendChild(r)}}else if(t.type==="note_added"){if(f.appendChild(document.createTextNode(" added a note ")),t.noteSection&&f.appendChild(document.createTextNode(`to section ${t.noteSection} `)),f.appendChild(document.createTextNode("in ")),f.appendChild(d),t.note){const r=document.createElement("span");r.className="chip",r.textContent=t.note,r.style.maxWidth="220px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",f.appendChild(document.createTextNode(" ")),f.appendChild(r)}}else f.appendChild(document.createTextNode(" updated ")),f.appendChild(d);s.appendChild(f),c.appendChild(s),c.addEventListener("click",r=>{r.preventDefault();const m=t.caseId;if(m){try{Ze("table")}catch{}t.taskId&&(Je=t.taskId),ht(m,t.caseTitle||"Case","updates","tasks")}}),o.appendChild(c);const l=document.createElement("div");return l.className="update-meta",l.title=t.createdAt?La(t.createdAt):"",l.textContent=t.createdAt?Zn(t.createdAt):"",n.appendChild(e),n.appendChild(o),n.appendChild(l),n}function Wt(){if(!Xe)return;Xe.innerHTML="";const t=Tt.filter(a=>!(an&&(a.username||"")!==an||on&&!`${a.username||""} ${a.caseTitle||""} ${a.taskText||""} ${a.comment||""}`.toLowerCase().includes(on.toLowerCase())));if(t.length===0){const a=document.createElement("div");a.className="update-empty",a.textContent="No updates yet.",Xe.appendChild(a);return}let n="",e="",o=[];const s=()=>{if(o.length){if(o.length===1)Xe.appendChild(Ia(o[0]));else{const a=document.createElement("li");a.className="update-item";const c=document.createElement("div");c.className="update-icon",c.textContent="üìÅ";const d=document.createElement("div");d.className="update-content";const f=document.createElement("div");f.className="update-line";const l=document.createElement("span");l.className="chip",l.textContent=o[0].caseTitle||"Case",f.appendChild(l),d.appendChild(f);const r=document.createElement("ul");r.style.margin="4px 0 0",r.style.padding="0",r.style.listStyle="none";const m=p=>{const v=document.createElement("li"),C=document.createElement("a");C.href="#",C.style.textDecoration="none",C.style.color="inherit";const E=document.createElement("span");E.className="who",E.textContent=p.username||"Someone";const L=document.createDocumentFragment();if(L.appendChild(E),p.type==="task_added")if(L.appendChild(document.createTextNode(" added ")),p.taskText){const x=document.createElement("span");x.className="task-name-chip",x.textContent=p.taskText,L.appendChild(x)}else L.appendChild(document.createTextNode("a task"));else if(p.type==="task_completed"){if(L.appendChild(document.createTextNode(" marked ")),p.taskText){const x=document.createElement("span");x.className="task-name-chip",x.textContent=p.taskText,L.appendChild(x)}else L.appendChild(document.createTextNode("a task"));L.appendChild(document.createTextNode(" as complete"))}else if(p.type==="comment_added"){if(L.appendChild(document.createTextNode(" commented")),p.comment){const x=document.createElement("span");x.className="chip",x.textContent=p.comment,x.style.maxWidth="220px",x.style.overflow="hidden",x.style.textOverflow="ellipsis",x.style.whiteSpace="nowrap",L.appendChild(document.createTextNode(" ")),L.appendChild(x)}}else if(p.type==="note_added"){if(L.appendChild(document.createTextNode(" added a note")),p.note){const x=document.createElement("span");x.className="chip",x.textContent=p.note,x.style.maxWidth="220px",x.style.overflow="hidden",x.style.textOverflow="ellipsis",x.style.whiteSpace="nowrap",L.appendChild(document.createTextNode(" ")),L.appendChild(x)}}else L.appendChild(document.createTextNode(" updated"));C.appendChild(L),C.addEventListener("click",x=>{x.preventDefault();try{Ze("table")}catch{}p.taskId&&(Je=p.taskId),ht(p.caseId,p.caseTitle||"Case","updates","tasks")}),v.appendChild(C),r.appendChild(v)},i=3,h=Math.max(0,o.length-i);if(o.slice(0,i).forEach(m),h>0){const p=document.createElement("li"),v=document.createElement("button");v.type="button",v.className="btn",v.textContent=`Show ${h} more`,v.addEventListener("click",()=>{v.remove(),o.slice(i).forEach(m)}),p.appendChild(v),r.appendChild(p)}d.appendChild(r);const u=document.createElement("div");u.className="update-meta",u.textContent=o[0].createdAt?Zn(o[0].createdAt):"",a.appendChild(c),a.appendChild(d),a.appendChild(u),Xe.appendChild(a)}o=[],e=""}};for(const a of t){const c=a.createdAt?Ta(a.createdAt):"";if(c&&c!==n){s(),n=c;const d=document.createElement("div");d.className="update-group",d.textContent=Na(a.createdAt),Xe.appendChild(d)}e?(a.caseId||"")===e?o.push(a):(s(),e=a.caseId||"",o=[a]):(e=a.caseId||"",o=[a])}s()}function Sa(){try{const t=Ce(ae(S,"updates"),Ne("createdAt","desc"),Fn(100));if(Ee)try{Ee()}catch{}Ee=Ie(t,async n=>{var e;Tt=[],nn.clear();for(const o of n.docs){const s=o.data(),a={id:o.id,type:s.type,username:s.username||"",caseId:s.caseId||"",taskId:s.taskId||"",createdAt:s.createdAt||null,createdAtMs:(e=s.createdAt)!=null&&e.toMillis?s.createdAt.toMillis():null};try{s.caseTitleCipher&&s.caseTitleIv&&(a.caseTitle=await oe(s.caseTitleCipher,s.caseTitleIv))}catch{}if(a.type==="task_added"||a.type==="task_completed")try{s.taskTextCipher&&s.taskTextIv&&(a.taskText=await oe(s.taskTextCipher,s.taskTextIv))}catch{}else if(a.type==="comment_added")try{s.commentCipher&&s.commentIv&&(a.comment=await oe(s.commentCipher,s.commentIv))}catch{}else if(a.type==="note_added"){a.noteSection=s.noteSection||"";try{s.noteTitleCipher&&s.noteTitleIv&&(a.noteTitle=await oe(s.noteTitleCipher,s.noteTitleIv))}catch{}try{s.noteTextCipher&&s.noteTextIv&&(a.note=await oe(s.noteTextCipher,s.noteTextIv))}catch{}}a.icon=a.type==="task_added"?"‚ûï":a.type==="task_completed"?"‚òë":a.type==="comment_added"?"üí¨":a.type==="note_added"?"üìù":"‚Ä¢",Tt.push(a),nn.set(o.id,a)}if(qt=n.docs[n.docs.length-1]||null,je){const o=je.value;je.innerHTML='<option value="">All users</option>'+(Ve||[]).map(s=>`<option value="${s.username}">${s.username}</option>`).join(""),je.value=o||""}Wt()},n=>console.error("Updates listener error",n))}catch(t){console.error("Failed to start updates listener",t)}}async function Aa(){var t;if(qt)try{const n=Ce(ae(S,"updates"),Ne("createdAt","desc"),startAfter(qt),Fn(100)),e=await ut(n),o=[];for(const s of e.docs){const a=s.data(),c={id:s.id,type:a.type,username:a.username||"",caseId:a.caseId||"",taskId:a.taskId||"",createdAt:a.createdAt||null,createdAtMs:(t=a.createdAt)!=null&&t.toMillis?a.createdAt.toMillis():null};try{a.caseTitleCipher&&a.caseTitleIv&&(c.caseTitle=await oe(a.caseTitleCipher,a.caseTitleIv))}catch{}if(c.type==="task_added"||c.type==="task_completed")try{a.taskTextCipher&&a.taskTextIv&&(c.taskText=await oe(a.taskTextCipher,a.taskTextIv))}catch{}else if(c.type==="comment_added")try{a.commentCipher&&a.commentIv&&(c.comment=await oe(a.commentCipher,a.commentIv))}catch{}else if(c.type==="note_added"){c.noteSection=a.noteSection||"";try{a.noteTitleCipher&&a.noteTitleIv&&(c.noteTitle=await oe(a.noteTitleCipher,a.noteTitleIv))}catch{}try{a.noteTextCipher&&a.noteTextIv&&(c.note=await oe(a.noteTextCipher,a.noteTextIv))}catch{}}c.icon=c.type==="task_added"?"‚ûï":c.type==="task_completed"?"‚òë":c.type==="comment_added"?"üí¨":c.type==="note_added"?"üìù":"‚Ä¢",o.push(c),nn.set(s.id,c)}qt=e.docs[e.docs.length-1]||null,Tt=Tt.concat(o),Wt()}catch(n){console.error("Failed to load more updates",n)}}function Kt(t){return{c:`col${t}Cipher`,iv:`col${t}Iv`}}function Qn(t){return{c:`col${t}BodyCipher`,iv:`col${t}BodyIv`}}async function Ba(t,n,e){const{c:o,iv:s}=Kt(n),a=(e||"").trim();if(t)try{if(!a)await se(G(S,"cases",t),{[o]:null,[s]:null});else{const c=await ne(a);await se(G(S,"cases",t),{[o]:c.cipher,[s]:c.iv})}}catch(c){console.error("Failed to save column",n,c),j("Failed to save")}}async function Fa(t,n,e){const{c:o,iv:s}=Qn(n),a=(e||"").trim();if(t)try{if(!a)await se(G(S,"cases",t),{[o]:null,[s]:null});else{const c=await ne(a);await se(G(S,"cases",t),{[o]:c.cipher,[s]:c.iv})}}catch(c){console.error("Failed to save body column",n,c),j("Failed to save")}}function ea(t){return`col${t}Items`}function vt(t="",n=""){return{id:Math.random().toString(36).slice(2,10),title:t,body:n,order:Date.now()}}async function ta(t,n){const e=t[ea(n)]||null;if(Array.isArray(e)&&e.length){const a=[];for(const c of e){let d="",f="";try{c.titleCipher&&c.titleIv&&(d=await oe(c.titleCipher,c.titleIv))}catch{}try{c.bodyCipher&&c.bodyIv&&(f=await oe(c.bodyCipher,c.bodyIv))}catch{}a.push({id:c.id||Math.random().toString(36).slice(2,10),title:d,body:f,order:c.order||0})}return a.sort((c,d)=>(c.order||0)-(d.order||0)),a}let o="",s="";try{const{c:a,iv:c}=Kt(n);t[a]&&t[c]&&(o=await oe(t[a],t[c]))}catch{}try{const{c:a,iv:c}=Qn(n);t[a]&&t[c]&&(s=await oe(t[a],t[c]))}catch{}return o||s?[{id:"legacy",title:o,body:s,order:0}]:[]}async function Ma(t){const n=[];for(const e of t){const{cipher:o,iv:s}=await ne((e.title||"").trim()),{cipher:a,iv:c}=await ne((e.body||"").trim());n.push({id:e.id,titleCipher:o,titleIv:s,bodyCipher:a,bodyIv:c,order:e.order||0})}return n}async function na(t,n,e){const o=ea(n),s=await Ma(e),a=e[0]&&(e[0].title||"").trim()||"",c=a?await ne(a):null,d={[o]:s};if(c){const{c:f,iv:l}=Kt(n);d[f]=c.cipher,d[l]=c.iv}else{const{c:f,iv:l}=Kt(n);d[f]=null,d[l]=null}await se(G(S,"cases",t),d)}function Da(){if(!Pe)return{table:null,tbody:null};const t=document.createElement("table");t.className="data-table";const n=document.createElement("thead"),e=document.createElement("tr"),o=["Patient","Diagnosis","History","Micro/ABx","Investigations","Updates","Tasks"];for(const a of o){const c=document.createElement("th");c.textContent=a,e.appendChild(c)}n.appendChild(e);const s=document.createElement("tbody");return t.appendChild(n),t.appendChild(s),{table:t,tbody:s}}function Pa(){const t=Ce(ae(S,"cases"),Ne("createdAt","desc"));pe=async n=>{const e=document.activeElement;if(e&&e.classList&&(e.classList.contains("cell-editable")||e.classList.contains("cell-title")))return;const{table:o,tbody:s}=Da();if(!o||!s||!Pe)return;let a=n;if(re&&re!=="none"){const l=[];for(const r of a){const i=r.data().caseTags||{};let h=999999;if(re==="location"){const p=(le.get("location")||[]).findIndex(v=>v.id===i.location);h=p===-1?999999:p}else if(re==="consultant"){const p=(le.get("consultant")||[]).findIndex(v=>v.id===i.consultant);h=p===-1?999999:p}else if(re==="room"){const p=(Fe.get(i.location)||[]).findIndex(v=>v.id===i.room);h=p===-1?999999:p}l.push({d:r,score:h,title:""})}for(const r of l)try{const m=r.d.data();r.title=await oe(m.titleCipher,m.titleIv)}catch{}l.sort((r,m)=>r.score-m.score||r.title.localeCompare(m.title)),Re==="desc"&&l.reverse(),a=l.map(r=>r.d)}for(const l of a){const r=l.data();let m="";try{m=await oe(r.titleCipher,r.titleIv)}catch{}if(!m||!m.trim())continue;const i=document.createElement("tr"),h=document.createElement("td"),u=document.createElement("div");u.className="name-cell";const p=document.createElement("div");p.className="name-row";const v=document.createElement("button");v.className="patient-link",v.textContent=m,v.addEventListener("click",()=>{jn=window.scrollY,ht(l.id,m,"table","notes")}),p.appendChild(v);const C=document.createElement("button");C.type="button",C.className="edit-tags-btn",C.textContent="Tags",C.addEventListener("click",F=>{F.stopPropagation(),hn(l.id,h)}),p.appendChild(C);const E=document.createElement("button");E.type="button",E.className="icon-btn delete-btn",E.textContent="üóë",E.title="Delete case",E.addEventListener("click",async F=>{if(F.stopPropagation(),!!confirm("Delete this case and all its items?"))try{if(await oa(l.id),ie===l.id){if(ge){try{ge()}catch{}ge=null}if(ke){try{ke()}catch{}ke=null}if(fe){try{fe()}catch{}fe=null}ie=null,ve.hidden=!0,ce&&(ce.hidden=!1)}j("Case deleted")}catch(D){console.error("Failed to delete case",D),j("Failed to delete case")}}),p.appendChild(E),u.appendChild(p);const L=document.createElement("div");L.className="tag-chips";const x=r.caseTags||{},T=(F,D,A)=>{if(!A)return;const U=D==="room"?Fe.get(x.location)||[]:le.get(D)||[],_=U.findIndex(M=>M.id===A);if(_===-1)return;const Y=U[_],V=document.createElement("span");V.className="tag-chip",V.setAttribute("role","button"),V.setAttribute("tabindex","0");const q=document.createElement("span");q.className="tag-order",q.textContent=String(_+1)+".",V.appendChild(q);const O=document.createElement("span");if(O.textContent=Y.name,V.appendChild(O),D==="location"){V.title="Edit tags";const M=()=>{hn(l.id,h)};V.addEventListener("click",P=>{P.stopPropagation(),M()}),V.addEventListener("keydown",P=>{(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),M())})}else{V.title=`Filter by ${F}`;const M=()=>{const P=K[D];P.has(A)?P.delete(A):P.add(A),V.classList.toggle("active",P.has(A)),Ae(),de&&pe&&pe(de);const J=new CustomEvent("filters:updated");document.dispatchEvent(J)};try{const P=K[D];V.classList.toggle("active",P&&P.has(A))}catch{}V.addEventListener("click",P=>{P.stopPropagation(),M()}),V.addEventListener("keydown",P=>{(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),M())})}L.appendChild(V)};T("Location","location",x.location||null),x.room&&x.location&&T("Room","room",x.room),T("Consultant","consultant",x.consultant||null),u.appendChild(L),h.appendChild(u),i.appendChild(h);for(const F of["A","B","C","D","E","F"]){const D=document.createElement("td");if(F==="F"){const A=document.createElement("div");A.className="cell-tasks";const U=document.createElement("ul");A.appendChild(U);const _=document.createElement("form");_.className="composer compact";const Y=document.createElement("input");if(Y.placeholder="Add task‚Ä¶",Y.setAttribute("aria-label","Task description"),_.appendChild(Y),_.addEventListener("submit",async q=>{q.preventDefault();const O=(Y.value||"").trim();if(!O)return;const{cipher:M,iv:P}=await ne(O),{cipher:J,iv:B}=await ne("open"),g=await Me(ae(S,"cases",l.id,"tasks"),{textCipher:M,textIv:P,statusCipher:J,statusIv:B,createdAt:Oe(),username:me||null,assignee:null,priority:null});try{await Ge({type:"task_added",caseId:l.id,caseTitle:m,taskId:g.id,taskTextCipher:M,taskTextIv:P})}catch{}Y.value=""}),D.appendChild(A),D.appendChild(_),ct.has(l.id)){try{ct.get(l.id)()}catch{}ct.delete(l.id)}const V=Ra(l.id,U,{caseTitle:m});ct.set(l.id,V)}else{const A=document.createElement("div");A.className="cell-items";const U=await ta(r,F),_=8,Y=`${l.id}:${F}`;window._cellExpand||(window._cellExpand=new Set);const V=window._cellExpand.has(Y),q=async()=>{try{await na(l.id,F,U)}catch(g){console.error("save",g),j("Failed to save")}};let O=null;const M=()=>{clearTimeout(O),O=setTimeout(q,500)},P=g=>{if(A.innerHTML="",!U.length){const y=document.createElement("div");y.className="cell-line";const $=document.createElement("div");$.className="cell-bullet",y.appendChild($);const k=document.createElement("div");k.className="cell-title",k.setAttribute("contenteditable","true"),k.dataset.placeholder="Add header‚Ä¶",k.addEventListener("input",()=>{const w=(k.textContent||"").trim();w.length>0&&U.length===0&&(U.push(vt(w,"")),window._cellExpand.add(Y),P(!0),M(),setTimeout(()=>{const N=A.querySelector(".cell-title");N&&N.focus()},0))}),k.addEventListener("keydown",w=>{if(w.key==="Enter"&&!(w.ctrlKey||w.metaKey||w.shiftKey)){w.preventDefault();const N=(k.textContent||"").trim();if(!N)return;U.splice(0,0,vt(N,"")),U.splice(1,0,vt("","")),window._cellExpand.add(Y),P(!0),M(),setTimeout(()=>{const b=A.querySelectorAll(".cell-title")[1];b&&b.focus()},0)}else if(w.key==="Enter"&&(w.ctrlKey||w.metaKey)){w.preventDefault();const N=D.cellIndex,b=i.nextElementSibling;if(b&&b.children[N]){const I=b.children[N].querySelector(".cell-title, .cell-editable");I&&I.focus()}}else if(w.key==="Tab"){w.preventDefault();const N=w.shiftKey?-1:1;let I=D.cellIndex+N,R=i;if(I<1){const z=i.previousElementSibling;if(z)R=z,I=6;else return}else if(I>6){const z=i.nextElementSibling;if(z)R=z,I=1;else return}const X=R.children[I];if(X){const z=X.querySelector(".cell-title, .cell-editable");z&&z.focus()}}}),y.appendChild(k),A.appendChild(y);return}const H=g?Math.min(U.length,_):Math.min(U.length,3);for(let y=0;y<H;y++){const $=U[y],k=document.createElement("div");k.className="cell-line";const w=document.createElement("div");w.className="cell-bullet",k.appendChild(w);const N=document.createElement("div");if(N.className="cell-title",N.setAttribute("contenteditable","true"),N.textContent=$.title||"",N.addEventListener("keydown",b=>{const I=window.getSelection(),R=I&&I.anchorOffset===0&&I.anchorNode&&(I.anchorNode===N||I.anchorNode.parentElement===N),X=!N.textContent||N.textContent.replace(/\u200B/g,"").trim()==="";if(b.key==="Enter"&&!(b.ctrlKey||b.metaKey||b.shiftKey)){if(b.preventDefault(),U.length>=_){j("Limit 8 items");return}const z=vt("","");U.splice(y+1,0,z),window._cellExpand.add(Y),P(!0),M(),setTimeout(()=>{const ee=A.querySelectorAll(".cell-title")[y+1];if(ee){ee.focus();try{const W=window.getSelection(),Z=document.createRange();Z.selectNodeContents(ee),Z.collapse(!0),W.removeAllRanges(),W.addRange(Z)}catch{}}},0)}else if(b.key==="Backspace"&&y>0&&X)b.preventDefault(),U.splice(y,1),P(g),M(),setTimeout(()=>{const z=A.querySelectorAll(".cell-title")[y-1];if(z){z.focus();try{const ee=window.getSelection(),W=document.createRange();W.selectNodeContents(z),W.collapse(!1),ee.removeAllRanges(),ee.addRange(W)}catch{}}},0);else if(b.key==="Backspace"&&R&&y>0){b.preventDefault();const z=U[y-1],ee=U[y];z.title=(z.title||"")+(ee.title||""),U.splice(y,1),P(g),M(),setTimeout(()=>{const W=A.querySelectorAll(".cell-title")[y-1];if(W){W.focus();try{const Z=window.getSelection(),te=document.createRange();te.selectNodeContents(W),te.collapse(!1),Z.removeAllRanges(),Z.addRange(te)}catch{}}},0)}else if(b.key==="Tab"){b.preventDefault();const z=b.shiftKey?-1:1;let W=D.cellIndex+z,Z=i;if(W<1){const Q=i.previousElementSibling;if(Q)Z=Q,W=6;else return}else if(W>6){const Q=i.nextElementSibling;if(Q)Z=Q,W=1;else return}const te=Z.children[W];if(te){const Q=te.querySelector(".cell-title, .cell-editable");Q&&Q.focus()}}else if(b.key==="Enter"&&(b.ctrlKey||b.metaKey)){b.preventDefault();const z=D.cellIndex,ee=i.nextElementSibling;if(ee&&ee.children[z]){const W=ee.children[z].querySelector(".cell-title, .cell-editable");W&&W.focus()}}}),N.addEventListener("input",()=>{$.title=N.textContent||"",M()}),k.appendChild(N),($.body||"").trim().length>0){const b=document.createElement("button");b.type="button",b.className="line-info-btn",b.textContent="‚Ä∫",b.title="Show details";let I=null,R=!1,X=!1,z=!1;const ee=()=>{I&&(I.remove(),I=null),R=!1,document.removeEventListener("click",W,!0)},W=te=>{I&&!I.contains(te.target)&&te.target!==b&&ee()},Z=()=>{if(I)return;I=document.createElement("div"),I.className="cell-body-panel";const te=document.createElement("div");te.className="cell-body-text",te.textContent=$.body||"",I.appendChild(te),document.body.appendChild(I);const Q=b.getBoundingClientRect();requestAnimationFrame(()=>{const he=I.offsetWidth||240,ot=I.offsetHeight||120,We=Math.min(Math.max(8,Q.right-he),window.innerWidth-he-8),Nt=Math.min(window.innerHeight-ot-8,Q.bottom+6);I.style.left=`${Math.round(We)}px`,I.style.top=`${Math.round(Nt)}px`}),I.addEventListener("mouseenter",()=>{z=!0}),I.addEventListener("mouseleave",()=>{z=!1,!R&&!X&&setTimeout(()=>{!R&&!X&&I&&ee()},120)})};b.addEventListener("mouseenter",()=>{X=!0,R||Z()}),b.addEventListener("mouseleave",()=>{X=!1,!R&&!z&&setTimeout(()=>{!R&&!X&&I&&ee()},120)}),b.addEventListener("click",te=>{te.stopPropagation(),I||Z(),R?ee():(R=!0,document.addEventListener("click",W,!0))}),k.appendChild(b)}A.appendChild(k)}if(!g&&U.length>3){const y=document.createElement("div");y.className="cell-more",y.textContent=`+${U.length-3}`,y.addEventListener("click",()=>{window._cellExpand.add(Y),P(!0)}),A.appendChild(y)}if(g&&U.length>3){const y=document.createElement("div");y.className="cell-collapse",y.textContent="Collapse",y.addEventListener("click",()=>{window._cellExpand.delete(Y),P(!1)}),A.appendChild(y)}};P(V);const J=`col${F}Color`,B=r[J]||null;if(B&&(D.style.background=B),mt){const g=document.createElement("button");g.type="button",g.className="cell-color-btn",g.title="Cell color",g.addEventListener("click",H=>{H.stopPropagation();const y=document.querySelector(".color-panel");y&&y.remove();const $=document.createElement("div");$.className="color-panel";const k=document.createElement("div");k.className="color-swatch none",k.title="None",k.addEventListener("click",async b=>{b.stopPropagation();try{const I={};I[J]=null,await se(G(S,"cases",l.id),I),D.style.background=""}catch(I){console.error("Failed to clear color",I),j("Failed to update color")}$.remove()}),$.appendChild(k);for(const b of fa){const I=document.createElement("div");I.className="color-swatch",I.style.background=b,I.title=b,I.addEventListener("click",async R=>{R.stopPropagation();try{const X={};X[J]=b,await se(G(S,"cases",l.id),X),D.style.background=b}catch(X){console.error("Failed to set color",X),j("Failed to update color")}$.remove()}),$.appendChild(I)}document.body.appendChild($);const w=g.getBoundingClientRect();requestAnimationFrame(()=>{const b=$.offsetWidth||180,I=$.offsetHeight||120,R=Math.min(Math.max(8,w.right-b),window.innerWidth-b-8),X=Math.min(window.innerHeight-I-8,w.bottom+6);$.style.left=`${Math.round(R)}px`,$.style.top=`${Math.round(X)}px`});const N=b=>{!$.contains(b.target)&&b.target!==g&&($.remove(),document.removeEventListener("click",N,!0))};setTimeout(()=>document.addEventListener("click",N,!0),0)}),D.appendChild(g)}D.appendChild(A)}i.appendChild(D)}ka(r.caseTags||{})&&s.appendChild(i)}Pe.innerHTML="",Pe.appendChild(o);const c=document.createElement("div");c.className="new-case-footer";const d=document.createElement("button");d.type="button",d.className="btn primary",d.textContent="‚ûï New Case",d.addEventListener("click",Xn),c.appendChild(d),Pe.appendChild(c);const f=new Set(n.map(l=>l.id));for(const[l,r]of Array.from(ct.entries()))if(!f.has(l)){try{r()}catch{}ct.delete(l)}},Ke=Ie(t,n=>{de=n.docs,pe&&pe(de);try{document.dispatchEvent(new CustomEvent("filters:updated"))}catch{}},n=>console.error("Table listener error",n))}function $a(){const t=document.getElementById("table-tags-controls");if(!t)return;t.innerHTML="";const n=document.createElement("div");n.className="left";const e=document.createElement("div");e.className="right",t.appendChild(n),t.appendChild(e);const o=document.createElement("div");o.className="filter-chips",n.appendChild(o);const s=document.createElement("span");s.className="section-label",s.textContent="Filters",n.appendChild(s);const a=document.createElement("div");a.className="pills-wrap",n.appendChild(a);const c=document.createElement("button");c.type="button",c.className="filter-pill",c.setAttribute("aria-haspopup","listbox"),c.setAttribute("aria-expanded","false"),c.textContent="Location";const d=document.createElement("span");d.className="count",d.textContent="",c.appendChild(d),a.appendChild(c);const f=document.createElement("button");f.type="button",f.className="filter-pill",f.setAttribute("aria-haspopup","listbox"),f.setAttribute("aria-expanded","false"),f.textContent="Room";const l=document.createElement("span");l.className="count",l.textContent="",f.appendChild(l),a.appendChild(f);const r=document.createElement("button");r.type="button",r.className="filter-pill",r.setAttribute("aria-haspopup","listbox"),r.setAttribute("aria-expanded","false"),r.textContent="Consultant";const m=document.createElement("span");m.className="count",m.textContent="",r.appendChild(m),a.appendChild(r);const i=document.createElement("button");i.type="button",i.className="mobile-filters-btn",i.textContent="Filters",e.appendChild(i);const h=document.createElement("span");h.className="section-label",h.textContent="Sort",e.appendChild(h);const u=document.createElement("div");u.className="segmented";const p=(y,$)=>{const k=document.createElement("button");return k.type="button",k.textContent=y,k.dataset.key=$,k.addEventListener("click",()=>{re=$,Ae(),O(),de&&pe&&pe(de)}),k},v=p("None","none"),C=p("Location","location"),E=p("Room","room"),L=p("Consultant","consultant");u.appendChild(v);const x=document.createElement("div");x.className="sep",u.appendChild(x),u.appendChild(C);const T=document.createElement("div");T.className="sep",u.appendChild(T),u.appendChild(E);const F=document.createElement("div");F.className="sep",u.appendChild(F),u.appendChild(L);const D=document.createElement("button");D.type="button",D.className="sort-dir",D.textContent="‚Üë",D.title="Toggle sort direction",D.addEventListener("click",()=>{Re=Re==="asc"?"desc":"asc",D.textContent=Re==="asc"?"‚Üë":"‚Üì",Ae(),de&&pe&&pe(de)});const A=document.createElement("button");A.type="button",A.className="icon-btn small",A.textContent="Clear",A.addEventListener("click",()=>{K.location.clear(),K.consultant.clear(),K.room.clear(),Ae(),g(),de&&pe&&pe(de)});const U=document.createElement("button");U.type="button",U.className="icon-btn small",U.textContent="Hide",U.addEventListener("click",()=>{wt(!0)}),e.appendChild(u),e.appendChild(D),e.appendChild(A),e.appendChild(U);const _=document.createElement("label");_.className="ctrl",_.style.display="inline-flex",_.style.alignItems="center",_.style.gap="6px";const Y=document.createElement("input");Y.type="checkbox";const V=document.createElement("span");V.textContent="Cell colors",V.className="section-label";try{mt=(localStorage.getItem("table.showCellColor")??"1")!=="0"}catch{mt=!0}Y.checked=!!mt,Tn(mt),Y.addEventListener("change",()=>{Tn(Y.checked)}),_.appendChild(Y),_.appendChild(V),e.insertBefore(_,A);function q(){o.innerHTML="";const y=(k,w,N)=>{const b=document.createElement("span");b.className="filter-chip";const I=document.createElement("span");I.textContent=N,b.appendChild(I);const R=document.createElement("span");R.className="x",R.textContent="‚úï",R.setAttribute("role","button"),R.setAttribute("tabindex","0");const X=()=>{K[k].delete(w),Ae(),g(),de&&pe&&pe(de)};R.addEventListener("click",X),R.addEventListener("keydown",z=>{(z.key==="Enter"||z.key===" ")&&(z.preventDefault(),X())}),b.appendChild(R),o.appendChild(b)},$=(k,w)=>{for(const N of K[k]){const b=w.find(I=>I.id===N);b&&y(k,N,b.name)}};$("location",le.get("location")||[]),$("consultant",le.get("consultant")||[]);for(const k of K.room){let w="Room";for(const[N,b]of Fe.entries()){const I=(b||[]).find(R=>R.id===k);if(I){w=I.name;break}}y("room",k,w)}}function O(){[v,C,E,L].forEach(y=>y.classList.toggle("active",y.dataset.key===(re||"none"))),D.style.display=re&&re!=="none"?"":"none",D.textContent=Re==="asc"?"‚Üë":"‚Üì"}let M=null;function P(y,$){const k=document.querySelector(".filter-popover");if(k&&M===y){k.remove(),y.setAttribute("aria-expanded","false"),M=null;return}J(y,$)}function J(y,$){if(y.getAttribute("aria-disabled")==="true")return;const k=document.querySelector(".filter-popover");k&&k.remove();const w=document.createElement("div");w.className="filter-popover",w.setAttribute("role","listbox");const N=document.createElement("input");N.className="search",N.type="search",N.placeholder="Search‚Ä¶",w.appendChild(N);const b=document.createElement("div");b.className="list",w.appendChild(b),document.body.appendChild(w);const I=y.getBoundingClientRect();requestAnimationFrame(()=>{const W=Math.min(window.innerWidth-w.offsetWidth-8,I.left),Z=Math.min(window.innerHeight-w.offsetHeight-8,I.bottom+6);w.style.left=`${Math.max(8,W)}px`,w.style.top=`${Math.max(8,Z)}px`});const R=K[$],X=[];if($==="room"){const W=Array.from(K.location),Z=W.length===1?W[0]:null,te=Z?Fe.get(Z)||[]:[];for(const Q of te)X.push({id:Q.id,name:Q.name,count:B({room:Q.id})})}else{const W=le.get($)||[];for(const Z of W)X.push({id:Z.id,name:Z.name,count:B({[$]:Z.id})})}const z=()=>{const W=(N.value||"").toLowerCase();b.innerHTML="";for(const Z of X){if(W&&!Z.name.toLowerCase().includes(W))continue;const te=document.createElement("div");te.className="opt",te.setAttribute("role","option"),te.setAttribute("aria-selected",String(R.has(Z.id)));const Q=document.createElement("div");Q.className="label";const he=document.createElement("input");he.type="checkbox",he.checked=R.has(Z.id),Q.appendChild(he);const ot=document.createElement("span");ot.textContent=Z.name,Q.appendChild(ot);const We=document.createElement("div");We.className="opt-count",We.textContent=String(Z.count),te.appendChild(Q),te.appendChild(We),te.addEventListener("click",()=>{R.has(Z.id)?R.delete(Z.id):R.add(Z.id),te.setAttribute("aria-selected",String(R.has(Z.id))),he.checked=R.has(Z.id),Ae(),g(),de&&pe&&pe(de)}),b.appendChild(te)}};z(),N.addEventListener("input",()=>{clearTimeout(N._t),N._t=setTimeout(z,120)});const ee=W=>{!w.contains(W.target)&&W.target!==y&&(w.remove(),document.removeEventListener("click",ee,!0),y.setAttribute("aria-expanded","false"),M=null)};setTimeout(()=>document.addEventListener("click",ee,!0),0),y.setAttribute("aria-expanded","true"),M=y,N.focus()}function B(y){if(!Array.isArray(de))return 0;let $=0;for(const k of de){const w=k.data().caseTags||{};let N=!0;for(const b in y)if(!w[b]||w[b]!==y[b]){N=!1;break}N&&$++}return $}function g(){d.textContent=K.location.size?` (${K.location.size})`:"",m.textContent=K.consultant.size?` (${K.consultant.size})`:"",l.textContent=K.room.size?` (${K.room.size})`:"";const y=K.location.size===1;f.setAttribute("aria-disabled",y?"false":"true"),q()}c.addEventListener("click",()=>P(c,"location")),r.addEventListener("click",()=>P(r,"consultant")),f.addEventListener("click",()=>P(f,"room")),O(),g(),document.addEventListener("tags:updated",g),document.addEventListener("filters:updated",g);function H(){const y=document.createElement("div");y.className="sheet-overlay";const $=document.createElement("div");$.className="sheet",y.appendChild($);const k=ue=>{const Se=document.createElement("div");Se.className="section";const De=document.createElement("h4");return De.textContent=ue,Se.appendChild(De),$.appendChild(Se),Se},w=k("Location"),N=k("Room"),b=k("Consultant"),I=k("Sort"),R=(ue,Se,De)=>{const jt=document.createElement("div");jt.className="list",ue.appendChild(jt);for(const yt of De){const Ct=document.createElement("div");Ct.className="opt";const Bt=document.createElement("label");Bt.className="label";const st=document.createElement("input");st.type="checkbox",st.checked=K[Se].has(yt.id);const wn=document.createElement("span");wn.textContent=yt.name,Bt.appendChild(st),Bt.appendChild(wn);const Vt=document.createElement("div");Vt.className="opt-count",Vt.textContent=String(yt.count),Ct.appendChild(Bt),Ct.appendChild(Vt),Ct.addEventListener("click",()=>{st.checked=!st.checked,st.checked?K[Se].add(yt.id):K[Se].delete(yt.id)}),jt.appendChild(Ct)}},X=(le.get("location")||[]).map(ue=>({id:ue.id,name:ue.name,count:B({location:ue.id})}));R(w,"location",X);const z=Array.from(K.location),ee=z.length===1?z[0]:null,Z=(ee?Fe.get(ee)||[]:[]).map(ue=>({id:ue.id,name:ue.name,count:B({room:ue.id})}));R(N,"room",Z);const te=(le.get("consultant")||[]).map(ue=>({id:ue.id,name:ue.name,count:B({consultant:ue.id})}));R(b,"consultant",te);const Q=document.createElement("div");Q.className="segmented";const he=(ue,Se)=>{const De=document.createElement("button");return De.type="button",De.textContent=ue,De.classList.toggle("active",(re||"none")===Se),De.addEventListener("click",()=>{re=Se,ot()}),De},ot=()=>{Ae()};Q.appendChild(he("None","none"));const We=document.createElement("div");We.className="sep",Q.appendChild(We),Q.appendChild(he("Location","location"));const Nt=document.createElement("div");Nt.className="sep",Q.appendChild(Nt),Q.appendChild(he("Room","room"));const kn=document.createElement("div");kn.className="sep",Q.appendChild(kn),Q.appendChild(he("Consultant","consultant")),I.appendChild(Q);const ft=document.createElement("div");ft.className="actions";const It=document.createElement("button");It.className="btn",It.textContent="Clear",It.addEventListener("click",()=>{K.location.clear(),K.room.clear(),K.consultant.clear()});const St=document.createElement("button");St.className="btn primary",St.textContent="Apply",St.addEventListener("click",()=>{Ae(),g(),de&&pe&&pe(de),y.remove()});const At=document.createElement("button");At.className="btn primary",At.textContent="New Case",At.addEventListener("click",()=>{y.remove(),Xn()}),ft.appendChild(It),ft.appendChild(St),ft.appendChild(At),$.appendChild(ft),y.addEventListener("click",ue=>{ue.target===y&&y.remove()}),document.body.appendChild(y)}i.addEventListener("click",H)}function Ra(t,n,e={}){const o=Ce(ae(S,"cases",t,"tasks"),Ne("createdAt","desc"));let s=null,a=!1,c=null;const d=m=>{if(n){n.innerHTML="";for(const i of m)n.appendChild(Ha(t,i,{...e,_onEditStart:f,_onEditEnd:l}))}},f=()=>{n.dataset.editing="1"},l=()=>{if(delete n.dataset.editing,a&&c){const m=c;c=null,a=!1,d(m)}},r=Ie(o,async m=>{if(!n)return;const i=[];for(const u of m.docs){const p=u.data();try{const v=await oe(p.textCipher,p.textIv),C=await oe(p.statusCipher,p.statusIv),E=p.createdAt&&p.createdAt.toMillis?p.createdAt.toMillis():0;i.push({id:u.id,text:v,status:C,data:p,createdAt:E})}catch{}}if(s)for(const u of i)s.includes(u.id)||s.unshift(u.id);else{const u=v=>v==="open"?0:v==="in progress"?1:2;s=[...i].sort((v,C)=>{const E=u(v.status)-u(C.status);return E!==0?E:C.createdAt-v.createdAt}).map(v=>v.id)}const h=new Map(s.map((u,p)=>[u,p]));if(i.sort((u,p)=>(h.get(u.id)??999999)-(h.get(p.id)??999999)),n.dataset.editing==="1"){c=i,a=!0;return}d(i)},m=>console.error("Tasks cell listener error",m));return()=>{try{r()}catch{}}}function Ha(t,n,e={}){const o=document.createElement("li"),s=n.status==="in progress"?"s-inprogress":n.status==="complete"?"s-complete":"s-open";o.className="case-task "+s;const a=document.createElement("button");a.type="button",a.className="status-btn";const c=i=>i==="complete"?"‚òë":i==="in progress"?"‚óê":"‚òê";a.textContent=c(n.status),a.setAttribute("aria-label",`Task status: ${n.status}`),a.addEventListener("click",async i=>{i.stopPropagation();const h=["open","in progress","complete"],u=h[(h.indexOf(n.status)+1)%h.length];try{const{cipher:p,iv:v}=await ne(u);if(await se(G(S,"cases",t,"tasks",n.id),{statusCipher:p,statusIv:v}),n.status=u,a.textContent=c(u),a.setAttribute("aria-label",`Task status: ${u}`),o.className="case-task "+(u==="in progress"?"s-inprogress":u==="complete"?"s-complete":"s-open"),u==="complete")try{const C=await ne(n.text||"");await Ge({type:"task_completed",caseId:t,caseTitle:e&&e.caseTitle||"Case",taskId:n.id,taskTextCipher:C.cipher,taskTextIv:C.iv})}catch{}}catch(p){console.error("Failed to update status",p),j("Failed to update status")}});const d=document.createElement("span");if(d.className="task-text",d.textContent=n.text,d.addEventListener("click",i=>{i.stopPropagation(),typeof e._onEditStart=="function"&&e._onEditStart();const h=document.createElement("div");h.className="cell-editable",h.setAttribute("contenteditable","true"),h.style.minWidth="120px",h.textContent=n.text;let u=n.text;const p=async()=>{const E=(h.innerText||"").replace(/\r/g,"");if(E===u){v();return}try{const{cipher:L,iv:x}=await ne(E);await se(G(S,"cases",t,"tasks",n.id),{textCipher:L,textIv:x}),u=E,n.text=E,d.textContent=E,C()}catch(L){console.error("Failed to update task text",L),j("Failed to update task"),C()}},v=()=>{C()},C=()=>{try{h.remove()}catch{}d.style.display="",typeof e._onEditEnd=="function"&&e._onEditEnd()};h.addEventListener("paste",E=>{E.preventDefault();const L=(E.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,L);else{const x=window.getSelection();x&&x.rangeCount&&(x.deleteFromDocument(),x.getRangeAt(0).insertNode(document.createTextNode(L)))}}),h.addEventListener("keydown",E=>{E.key==="Enter"&&!(E.ctrlKey||E.metaKey)?(E.preventDefault(),p()):E.key==="Escape"&&(E.preventDefault(),v())}),h.addEventListener("blur",()=>{p()}),d.insertAdjacentElement("afterend",h),d.style.display="none",h.focus()}),o.appendChild(a),o.appendChild(d),n.data&&n.data.priority)if(e.compact){const i=document.createElement("span");i.style.fontSize="11px",i.style.color="#6b7280",i.title="Priority";const h=(n.data.priority||"").toLowerCase();i.textContent=h==="high"?"H":h==="medium"?"M":h==="low"?"L":"",i.textContent&&o.appendChild(i)}else{const i=document.createElement("span");i.className="mini-chip",i.textContent=n.data.priority,o.appendChild(i)}const f=document.createElement("span");f.className="mini-avatar";const l=n.data&&n.data.assignee?n.data.assignee.split(/\s+/).map(i=>i[0]).join("").slice(0,2).toUpperCase():"";f.textContent=l||"";const r=En(n.data&&n.data.assignee||"");f.style.background=r.bg,f.style.color=r.color,f.style.border=`1px solid ${r.border}`,f.addEventListener("click",i=>{i.stopPropagation();const h=document.querySelector(".assignee-panel");h&&h.remove();const u=document.createElement("div");u.className="assignee-panel",u.style.position="fixed",u.style.zIndex="2147483646";const p=(E,L)=>{const x=document.createElement("button");x.type="button",x.className="assignee-option",x.textContent=E,x.addEventListener("click",async T=>{T.stopPropagation();try{await se(G(S,"cases",t,"tasks",n.id),{assignee:L})}catch(F){console.error("Failed to reassign",F),j("Failed to reassign")}finally{u.remove()}}),u.appendChild(x)};p("Unassigned",null);for(const E of Ve)p(E.username,E.username);document.body.appendChild(u);const v=f.getBoundingClientRect();requestAnimationFrame(()=>{const E=u.offsetWidth||160,L=Math.min(Math.max(8,v.right-E),window.innerWidth-E-8),x=Math.min(window.innerHeight-u.offsetHeight-8,v.bottom+6);u.style.left=`${Math.round(L)}px`,u.style.top=`${Math.round(x)}px`});const C=E=>{!u||u.contains(E.target)||E.target===f||(u.remove(),document.removeEventListener("click",C,!0))};setTimeout(()=>document.addEventListener("click",C,!0),0)});const m=document.createElement("button");return m.type="button",m.className="icon-btn delete-btn",m.textContent="üóë",m.title="Delete task",m.addEventListener("click",async i=>{if(i.stopPropagation(),!!confirm("Delete this task?"))try{await xe(G(S,"cases",t,"tasks",n.id))}catch(h){console.error("Failed to delete task",h),j("Failed to delete task")}}),o.appendChild(f),o.appendChild(m),o}function hn(t,n){const e=document.createElement("div");e.className="tag-panel";const o=document.createElement("h4");o.textContent="Edit tags",e.appendChild(o);const s=document.createElement("div");s.className="row",e.appendChild(s);const a=document.createElement("div");a.style.display="flex",a.style.gap="6px";const c=document.createElement("select"),d=(T,F,D=!0)=>{if(T.innerHTML="",D){const A=document.createElement("option");A.value="",A.textContent="Unassigned",T.appendChild(A)}for(const A of F){const U=document.createElement("option");U.value=A.id,U.textContent=A.name,T.appendChild(U)}};d(c,le.get("location")||[]);const f=document.createElement("button");f.type="button",f.textContent="+",f.className="icon-btn small",f.title="Add ward",f.addEventListener("click",async()=>{await zt("location")}),a.appendChild(c),a.appendChild(f),s.appendChild(a);const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";const r=document.createElement("select");d(r,[],!0);const m=document.createElement("button");m.type="button",m.textContent="+",m.className="icon-btn small",m.title="Add room",m.addEventListener("click",async()=>{const T=c.value||"";if(!T){j("Pick a ward first");return}await sa(T)}),l.appendChild(r),l.appendChild(m),s.appendChild(l);const i=document.createElement("div");i.style.display="flex",i.style.gap="6px";const h=document.createElement("select");d(h,le.get("consultant")||[]);const u=document.createElement("button");u.type="button",u.textContent="+",u.className="icon-btn small",u.title="Add consultant",u.addEventListener("click",async()=>{await zt("consultant")}),i.appendChild(h),i.appendChild(u),s.appendChild(i);const p=document.createElement("div");p.className="actions",e.appendChild(p);const v=document.createElement("button");v.className="icon-btn small",v.textContent="Cancel",p.appendChild(v);const C=document.createElement("button");C.className="icon-btn small",C.textContent="Save",p.appendChild(C),(async()=>{const T=G(S,"cases",t),F=await Bn(T),D=F.exists()&&F.data().caseTags||{};D.location?c.value=D.location:c.value="",await E(),D.room?r.value=D.room:r.value="",D.consultant?h.value=D.consultant:h.value=""})();async function E(){const T=c.value||null;if(T){const F=await vn(T);d(r,F,!0)}else d(r,[],!0)}c.addEventListener("change",async()=>{await E(),r.value=""}),v.addEventListener("click",()=>{e.remove(),document.removeEventListener("click",x,!0)}),C.addEventListener("click",async()=>{try{const T=c.value||null,F=r.value||null,D=h.value||null,A={location:T,consultant:D};T&&F?A.room=F:A.room=null,await se(G(S,"cases",t),{caseTags:A}),e.remove(),document.removeEventListener("click",x,!0)}catch(T){console.error("Failed to update tags",T),j("Failed to update tags")}}),document.body.appendChild(e);const L=n.getBoundingClientRect();requestAnimationFrame(()=>{const T=Math.min(window.innerWidth-e.offsetWidth-8,L.left),F=Math.min(window.innerHeight-e.offsetHeight-8,L.bottom+6);e.style.left=`${Math.max(8,T)}px`,e.style.top=`${Math.max(8,F)}px`});const x=T=>{!e||e.contains(T.target)||(e.remove(),document.removeEventListener("click",x,!0))};setTimeout(()=>document.addEventListener("click",x,!0),0)}function qa(){const t=[{el:Pn,L:"A"},{el:$n,L:"B"},{el:Rn,L:"C"},{el:Hn,L:"D"},{el:qn,L:"E"},{el:Un,L:"F"}];for(const{el:e,L:o}of t)e&&e.addEventListener("blur",()=>{ie!=null&&Ba(ie,o,e.value)});const n=[{el:_n,L:"A"},{el:On,L:"B"},{el:Wn,L:"C"},{el:Kn,L:"D"},{el:zn,L:"E"}];for(const{el:e,L:o}of n)e&&e.addEventListener("blur",()=>{ie!=null&&Fa(ie,o,e.value)})}function Ua(t){fe&&(fe(),fe=null);const n=G(S,"cases",t);fe=Ie(n,async e=>{if(!e.exists())return;const o=e.data();try{const a=document.getElementById("case-tag-chips");if(a){a.innerHTML="";const c=o.caseTags||{},d=(f,l)=>{if(!l)return;const m=(f==="room"?Fe.get(c.location)||[]:le.get(f)||[]).find(p=>p.id===l);if(!m)return;const i=document.createElement("span");i.className="tag-chip",i.setAttribute("role","button"),i.setAttribute("tabindex","0");const h=document.createElement("span");h.textContent=m.name,i.appendChild(h);const u=()=>{hn(t,Qe||a)};i.addEventListener("click",p=>{p.stopPropagation(),u()}),i.addEventListener("keydown",p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),u())}),a.appendChild(i)};d("location",c.location||null),c.room&&c.location&&d("room",c.room),d("consultant",c.consultant||null)}}catch{}const s=[{L:"A",el:document.getElementById("notes-A-items")},{L:"B",el:document.getElementById("notes-B-items")},{L:"C",el:document.getElementById("notes-C-items")},{L:"D",el:document.getElementById("notes-D-items")},{L:"E",el:document.getElementById("notes-E-items")}];for(const a of s){const c=await ta(o,a.L);_a(a.el,a.L,c)}try{const a=(d,f)=>{if(!d)return;const l=`col${f}Color`,r=o[l]||null;d.style.background=r||""},c=(d,f)=>{const l=document.getElementById(d);if(!l)return;const r=`col${f}Color`,m=o[r]||null;l.querySelectorAll("input, textarea").forEach(i=>{i.style.background=m||""})};c("notes-A-items","A"),c("notes-B-items","B"),c("notes-C-items","C"),c("notes-D-items","D"),c("notes-E-items","E")}catch{}})}function _a(t,n,e){var r;if(!t)return;t.innerHTML="";const o=8,s=(r=t.parentElement)==null?void 0:r.querySelector('.add-note-item[data-letter="'+n+'"]'),a=e.length<o;s&&(s.disabled=!a,s.onclick=()=>{if(e.length>=o){j("Limit reached");return}e.push(vt()),d();try{Ge({type:"note_added",caseId:ie,noteSection:n})}catch{}c()});const c=()=>{t.innerHTML="",e.forEach((m,i)=>{const h=document.createElement("div");h.className="note-item",h.dataset.id=m.id;const u=document.createElement("input");u.type="text",u.className="note-item-header",u.placeholder="Header",u.value=m.title||"";const p=document.createElement("textarea");p.className="note-item-body",p.placeholder="Add details‚Ä¶",p.value=m.body||"";const v=document.createElement("div");v.className="note-actions";const C=document.createElement("button");C.type="button",C.className="icon-btn small",C.textContent="‚Üë",C.title="Move up",C.disabled=i===0;const E=document.createElement("button");E.type="button",E.className="icon-btn small",E.textContent="‚Üì",E.title="Move down",E.disabled=i===e.length-1;const L=document.createElement("button");L.type="button",L.className="icon-btn small delete-btn",L.textContent="üóë",L.title="Delete",v.appendChild(C),v.appendChild(E),v.appendChild(L),h.appendChild(u),h.appendChild(p),h.appendChild(v),t.appendChild(h),u.addEventListener("blur",()=>{m.title=u.value,l()}),p.addEventListener("blur",()=>{m.body=p.value,l()});const x=()=>{for(let F=0;F<e.length;F++)e[F].order=e[F].order&&Number.isFinite(e[F].order)?e[F].order:0},T=()=>{for(let F=0;F<e.length;F++)e[F].order=F+1};C.addEventListener("click",()=>{if(i===0)return;x();const F=e[i-1];e[i-1]=e[i],e[i]=F,T(),d(),c()}),E.addEventListener("click",()=>{if(i===e.length-1)return;x();const F=e[i+1];e[i+1]=e[i],e[i]=F,T(),d(),c()}),L.addEventListener("click",()=>{e.splice(i,1),d(),c()})})},d=async()=>{try{await na(ie,n,e)}catch(m){console.error("save items",m),j("Failed to save")}s&&(s.disabled=e.length>=o)};let f=null;const l=()=>{clearTimeout(f),f=setTimeout(d,500)};c()}function Oa(){tt.addEventListener("click",()=>yn("tasks")),xt.addEventListener("click",()=>yn("notes"))}function Wa(){try{return window.matchMedia("(min-width: 900px)").matches}catch{return!1}}function fn(){const t=document.getElementById("tasks"),n=document.getElementById("notes");if(!(!t||!n))if(Wa())t.hidden=!1,n.hidden=!1;else{const e=tt&&tt.classList.contains("active");t.hidden=!e,n.hidden=e}}function yn(t){const n=t==="tasks";tt&&(tt.classList.toggle("active",n),tt.setAttribute("aria-selected",String(n))),xt&&(xt.classList.toggle("active",!n),xt.setAttribute("aria-selected",String(!n))),fn()}function ze(){if(cn){ln=!0;return}if(!bt)return;const t=o=>o==="high"?3:o==="medium"?2:o==="low"?1:0;let n=Vn.filter(o=>{const s=o.data&&o.data.priority||"",a=!Ut.size||Ut.has(o.status),c=_t==="all"||s===_t,d=!Ot||o.text.toLowerCase().includes(Ot.toLowerCase());return a&&c&&d}),e;if(kt==="pri-asc"||kt==="pri-desc")e=[...n].sort((o,s)=>{const a=o.data&&o.data.priority||"",c=s.data&&s.data.priority||"";return kt==="pri-asc"?t(a)-t(c):t(c)-t(a)});else{const o=new Map((Yn||[]).map((s,a)=>[s,a]));e=[...n].sort((s,a)=>(o.get(s.id)??999999)-(o.get(a.id)??999999))}bt.innerHTML="";for(const o of e){const s=Je&&o.id===Je;bt.appendChild(Ka(o,{openComments:s}))}if(Je){const o=document.getElementById("task-"+Je);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("flash-highlight"),setTimeout(()=>o.classList.remove("flash-highlight"),1400)),Je=null}}function Ka(t,n={}){const{caseId:e,id:o,text:s,status:a,data:c}=t,d=document.createElement("li"),f=a==="in progress"?"s-inprogress":a==="complete"?"s-complete":"s-open";d.className="case-task "+f,d.id="task-"+o;const l=document.createElement("button");l.type="button",l.className="status-btn";const r=q=>q==="complete"?"‚òë":q==="in progress"?"‚óê":"‚òê";l.textContent=r(a),l.setAttribute("aria-label",`Task status: ${a}`),l.addEventListener("click",async q=>{var P;q.stopPropagation();const O=["open","in progress","complete"],M=O[(O.indexOf(((P=l.getAttribute("aria-label"))==null?void 0:P.split(": ")[1])||a)+1)%O.length];try{const{cipher:J,iv:B}=await ne(M);if(await se(G(S,"cases",e,"tasks",o),{statusCipher:J,statusIv:B}),l.textContent=r(M),l.setAttribute("aria-label",`Task status: ${M}`),d.className="case-task "+(M==="in progress"?"s-inprogress":M==="complete"?"s-complete":"s-open"),M==="complete")try{const g=await ne(m.textContent||"");await Ge({type:"task_completed",caseId:e,taskId:o,taskTextCipher:g.cipher,taskTextIv:g.iv})}catch{}}catch(J){console.error("Failed to update status",J),j("Failed to update status")}});const m=document.createElement("span");m.className="task-text",m.textContent=s,m.addEventListener("click",q=>{q.stopPropagation(),cn=!0;const O=document.createElement("div");O.className="cell-editable",O.setAttribute("contenteditable","true"),O.textContent=s;let M=s;const P=()=>{try{O.remove()}catch{}m.style.display="",cn=!1,ln&&(ln=!1,ze())},J=async()=>{const B=(O.innerText||"").replace(/\r/g,"");if(B===M){P();return}try{const{cipher:g,iv:H}=await ne(B);await se(G(S,"cases",e,"tasks",o),{textCipher:g,textIv:H}),M=B,m.textContent=B}catch(g){console.error("Failed to update task",g),j("Failed to update task")}P()};O.addEventListener("paste",B=>{B.preventDefault();const g=(B.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,g);else{const H=window.getSelection();H&&H.rangeCount&&(H.deleteFromDocument(),H.getRangeAt(0).insertNode(document.createTextNode(g)))}}),O.addEventListener("keydown",B=>{B.key==="Enter"&&!(B.ctrlKey||B.metaKey)?(B.preventDefault(),J()):B.key==="Escape"&&(B.preventDefault(),P())}),O.addEventListener("blur",()=>{J()}),m.insertAdjacentElement("afterend",O),m.style.display="none",O.focus()}),d.appendChild(l),d.appendChild(m);const i=document.createElement("button");i.type="button",i.className="icon-btn",i.setAttribute("aria-label","Edit task"),i.textContent="‚úèÔ∏è",i.addEventListener("click",q=>{q.stopPropagation(),m.click()}),d.appendChild(i);const h=document.createElement("button");if(h.type="button",h.className="icon-btn delete-btn",h.setAttribute("aria-label","Delete task"),h.textContent="üóë",h.addEventListener("click",async q=>{if(q.stopPropagation(),!!confirm("Delete this task?"))try{await xe(G(S,"cases",e,"tasks",o))}catch(O){console.error("Failed to delete task",O),j("Failed to delete task")}}),d.appendChild(h),c.priority){const q=document.createElement("span");q.className="mini-chip",q.textContent=c.priority,d.appendChild(q)}const u=document.createElement("span");u.className="mini-avatar";const p=c.assignee?c.assignee.split(/\s+/).map(q=>q[0]).join("").slice(0,2).toUpperCase():"";u.textContent=p||"";const v=En(c.assignee||"");u.style.background=v.bg,u.style.color=v.color,u.style.border=`1px solid ${v.border}`;let C=null;const E=()=>{C&&(C.remove(),C=null)};u.addEventListener("mouseenter",()=>{if(!c.assignee)return;C=document.createElement("div"),C.className="assignee-tip",C.textContent=c.assignee,C.style.position="fixed",C.style.zIndex="2147483647",document.body.appendChild(C);const q=u.getBoundingClientRect();requestAnimationFrame(()=>{const O=C.offsetHeight||24;C.style.left=`${Math.round(q.left+q.width/2)}px`,C.style.top=`${Math.round(q.top-6-O)}px`,C.style.transform="translateX(-50%)"})}),u.addEventListener("mouseleave",E),u.addEventListener("click",q=>{q.stopPropagation(),E();const O=document.querySelector(".assignee-panel");O&&O.remove();const M=document.createElement("div");M.className="assignee-panel",M.style.position="fixed",M.style.zIndex="2147483646";const P=(g,H)=>{const y=document.createElement("button");y.type="button",y.className="assignee-option",y.textContent=g,y.addEventListener("click",async $=>{$.stopPropagation();try{await se(G(S,"cases",e,"tasks",o),{assignee:H}),ze()}catch(k){console.error("Failed to reassign",k),j("Failed to reassign")}finally{M.remove()}}),M.appendChild(y)};P("Unassigned",null);for(const g of Ve)P(g.username,g.username);document.body.appendChild(M);const J=u.getBoundingClientRect();requestAnimationFrame(()=>{const g=M.offsetWidth||180,H=Math.min(Math.max(8,J.right-g),window.innerWidth-g-8),y=Math.min(window.innerHeight-M.offsetHeight-8,J.bottom+6);M.style.left=`${Math.round(H)}px`,M.style.top=`${Math.round(y)}px`});const B=g=>{!M||M.contains(g.target)||g.target===u||(M.remove(),document.removeEventListener("click",B,!0))};setTimeout(()=>document.addEventListener("click",B,!0),0)}),d.appendChild(u);const L=document.createElement("button");L.type="button",L.className="icon-btn comment-toggle",L.setAttribute("aria-label","Show comments"),L.textContent="üí¨";const x=document.createElement("span");x.className="badge comment-count",d.appendChild(L),d.appendChild(x);const T=document.createElement("div");T.className="comment-section",T.hidden=!(n&&n.openComments);const F=document.createElement("ul");F.className="comments",T.appendChild(F);const D=document.createElement("form");D.className="comment-form";const A=document.createElement("input");A.placeholder="Add comment",D.appendChild(A);const U=document.createElement("button");U.className="icon-btn add-comment-btn",U.type="submit",U.textContent="‚ûï",U.setAttribute("aria-label","Add comment"),D.appendChild(U),T.appendChild(D);let _=!1,Y=0;const V=()=>{x.textContent=Y>0?String(Y):"",L.setAttribute("aria-label",T.hidden?"Show comments":"Hide comments"),L.textContent=T.hidden?"üí¨":"‚úñ"};return V(),!T.hidden&&!_&&(Lt(e,o,F,q=>{Y=q,V()}),_=!0),L.addEventListener("click",()=>{const q=T.hidden;T.hidden=!q,V(),q&&!_&&(Lt(e,o,F,O=>{Y=O,V()}),_=!0)}),D.addEventListener("submit",async q=>{q.preventDefault();const O=A.value.trim();if(!O)return;const M=document.createElement("li");M.className="optimistic";const P=document.createElement("span");P.textContent=me?`${me}: ${O}`:O,M.appendChild(P),F.appendChild(M),A.value="",T.hidden=!1,V();try{const{cipher:J,iv:B}=await ne(O);await Me(ae(S,"cases",e,"tasks",o,"comments"),{cipher:J,iv:B,username:me,createdAt:Oe()});try{await Ge({type:"comment_added",caseId:e,taskId:o,commentCipher:J,commentIv:B})}catch{}_||(Lt(e,o,F,g=>{Y=g,V()}),_=!0)}catch{M.classList.add("failed"),j("Failed to add comment")}}),d.appendChild(T),d}function za(){Jt&&Jt.addEventListener("submit",async t=>{t.preventDefault();const n=Zt.value.trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),s=Et&&Et.value||null;await Me(ae(S,"cases"),{titleCipher:e,titleIv:o,createdAt:Oe(),username:me,location:s}),Zt.value="",Et&&(Et.value="")})}function ja(){aa(),document.getElementById("task-input")&&document.getElementById("composer-opts")&&document.getElementById("task-input").addEventListener("focus",()=>{document.getElementById("composer-opts").hidden=!1}),Dn.addEventListener("submit",async t=>{if(t.preventDefault(),!ie)return;const n=Qt.value.trim(),e="open";if(!n)return;const{cipher:o,iv:s}=await ne(n),{cipher:a,iv:c}=await ne(e),d=document.getElementById("task-assignee"),f=document.getElementById("task-priority"),l=d&&d.value||null,r=f&&f.value||null,m=await Me(ae(S,"cases",ie,"tasks"),{textCipher:o,textIv:s,statusCipher:a,statusIv:c,createdAt:Oe(),username:me,assignee:l,priority:r});try{await Ge({type:"task_added",caseId:ie,taskId:m.id,taskTextCipher:o,taskTextIv:s,assignee:l,priority:r})}catch{}Qt.value="",d&&(d.value=""),f&&(f.value="")})}function aa(){const t=document.getElementById("task-assignee");if(!t)return;const n=t.value;t.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="Unassigned",t.appendChild(e);for(const o of Ve){const s=document.createElement("option");s.value=o.username,s.textContent=o.username,t.appendChild(s)}t.value=n||""}window.addEventListener("DOMContentLoaded",async()=>{document.getElementById("case-list"),Be=document.getElementById("case-list-section"),Jt=document.getElementById("case-form"),Zt=document.getElementById("case-input"),Et=document.getElementById("case-location"),ve=document.getElementById("case-detail"),Qe=document.getElementById("case-title"),we=document.getElementById("updates-section"),Xe=document.getElementById("updates-list"),document.getElementById("updates-toolbar"),je=document.getElementById("updates-user-filter"),Mt=document.getElementById("updates-search"),Yt=document.getElementById("updates-load-more"),Ln=document.getElementById("back-btn"),Dn=document.getElementById("task-form"),Qt=document.getElementById("task-input"),bt=document.getElementById("task-list"),document.getElementById("task-assignee"),document.getElementById("task-priority"),document.getElementById("composer-opts"),Pn=document.getElementById("colA-input"),$n=document.getElementById("colB-input"),Rn=document.getElementById("colC-input"),Hn=document.getElementById("colD-input"),qn=document.getElementById("colE-input"),Un=document.getElementById("colF-input"),_n=document.getElementById("colA-body"),On=document.getElementById("colB-body"),Wn=document.getElementById("colC-body"),Kn=document.getElementById("colD-body"),zn=document.getElementById("colE-body"),tt=document.getElementById("tab-tasks"),xt=document.getElementById("tab-notes");const t=document.getElementById("tab-table");document.getElementById("tab-cases");const n=document.getElementById("tab-my"),e=document.getElementById("tab-updates");qe=document.getElementById("user-detail"),tn=document.getElementById("user-title"),pt=document.getElementById("user-task-list"),Gt=document.getElementById("user-back-btn"),Xt=document.getElementById("brand-home");const o=document.getElementById("case-header-actions");if(o&&!document.getElementById("case-overflow-btn")){const l=document.createElement("button");l.id="case-overflow-btn",l.className="icon-btn case-overflow-btn",l.type="button",l.setAttribute("aria-haspopup","true"),l.setAttribute("aria-expanded","false"),l.textContent="‚ãØ";const r=document.createElement("div");r.id="case-overflow-panel",r.className="case-overflow-panel",r.hidden=!0,((h,u,p=!1)=>{const v=document.createElement("button");v.type="button",v.className="case-overflow-item"+(p?" delete":""),v.textContent=h,v.addEventListener("click",C=>{C.stopPropagation(),u(),r.hidden=!0,l.setAttribute("aria-expanded","false")}),r.appendChild(v)})("Delete case",async()=>{if(ie&&confirm("Delete this case and all its items?"))try{await oa(ie),ie=null,ve.hidden=!0,ce&&(ce.hidden=!1),j("Case deleted")}catch(h){console.error("Failed to delete case",h),j("Failed to delete case")}},!0),o.appendChild(l),o.appendChild(r);const i=h=>{r.hidden=!h,l.setAttribute("aria-expanded",String(h))};l.addEventListener("click",h=>{h.stopPropagation(),i(r.hidden)}),document.addEventListener("click",h=>{!r.hidden&&h.target!==l&&!r.contains(h.target)&&i(!1)},!0)}document.getElementById("user-filter"),mn=Array.from(document.querySelectorAll(".user-status")),un=document.getElementById("user-priority-filter"),pn=document.getElementById("user-sort"),ce=document.getElementById("table-section"),Pe=document.getElementById("table-root");const s=document.getElementById("hide-filters-btn"),a=document.getElementById("show-filters-btn"),c=document.getElementById("print-open-btn");Le=document.getElementById("filter-location"),Te=document.getElementById("filter-consultant"),rt=document.getElementById("sort-by-tag"),en=document.getElementById("clear-tag-filters"),za(),ja(),qa(),Oa(),fn(),window.addEventListener("resize",fn),t&&t.addEventListener("click",()=>Ze("table")),e&&e.addEventListener("click",()=>Ze("updates")),je&&je.addEventListener("change",()=>{an=je.value||"",Wt()}),Mt&&Mt.addEventListener("input",()=>{on=Mt.value.trim(),Wt()}),Yt&&Yt.addEventListener("click",Aa),n&&n.addEventListener("click",()=>Ze("my"));const d="tableFiltersHidden";s&&s.addEventListener("click",()=>wt(!0)),a&&a.addEventListener("click",()=>wt(!1));try{const l=localStorage.getItem(d)==="1";wt(l)}catch{}ya(),c&&c.addEventListener("click",()=>{const r=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><div class="print-header">Printed ${new Date().toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}</div><section id="table-section">${Pe?Pe.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,m=window.open("","_blank");if(!m){j("Pop-up blocked. Allow pop-ups to print.");return}m.document.open(),m.document.write(r),m.document.close()}),c&&c.addEventListener("click",()=>{const l=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><section id="table-section">${Pe?Pe.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,r=window.open("","_blank");if(!r){j("Pop-up blocked. Allow pop-ups to print.");return}r.document.open(),r.document.write(l),r.document.close()}),Ln.addEventListener("click",()=>{if(Ht==="user"&&qe)ge&&(ge(),ge=null),ke&&(ke(),ke=null),fe&&(fe(),fe=null),ie=null,ve.hidden=!0,qe.hidden=!1,Be&&(Be.style.display="none"),Ht="list";else if(Ht==="updates"&&we){ge&&(ge(),ge=null),ke&&(ke(),ke=null),fe&&(fe(),fe=null),ie=null,ve.hidden=!0,Ze("updates");try{const l=new URL(window.location.href);l.searchParams.delete("case"),window.history.pushState({},"",l.toString())}catch{}}else{ge&&(ge(),ge=null),ke&&(ke(),ke=null),fe&&(fe(),fe=null),ie=null,ve.hidden=!0,ce&&(ce.hidden=!1);try{window.scrollTo(0,jn||0);const l=new URL(window.location.href);l.searchParams.delete("case"),window.history.pushState({},"",l.toString())}catch{}}}),Gt&&Gt.addEventListener("click",()=>{if(qe.hidden=!0,ie?(ve.hidden=!1,Be&&(Be.style.display="none")):ce&&(ce.hidden=!1),Array.isArray(et)){for(const l of et)try{l()}catch{}et=[]}}),Xt&&(Xt.addEventListener("click",()=>{ce&&(ce.hidden=!1),ve.hidden=!0,qe.hidden=!0}),document.addEventListener("taskToolbar:status",l=>{const r=l&&l.detail||{};Ut=new Set((r.statuses||[]).map(String)),ze()}),document.addEventListener("taskToolbar:priority",l=>{_t=l&&l.detail&&l.detail.priority||"all",ze()}),document.addEventListener("taskToolbar:sort",l=>{kt=l&&l.detail&&l.detail.sort||"none",ze()}),document.addEventListener("taskToolbar:search",l=>{Ot=l&&l.detail&&l.detail.query||"",ze()}),document.addEventListener("taskToolbar:clear",()=>{Ut=new Set(["open","in progress","complete"]),_t="all",kt="none",Ot="",ze()})),document.addEventListener("userToolbar:status",l=>{const r=l&&l.detail||{};$e=new Set((r.statuses||[]).map(String)),dt(),He()}),document.addEventListener("userToolbar:priority",l=>{Ue=l&&l.detail&&l.detail.priority||"all",dt(),He()}),document.addEventListener("userToolbar:sort",l=>{_e=l&&l.detail&&l.detail.sort||"none",dt(),He()}),document.addEventListener("userToolbar:search",l=>{Ye=l&&l.detail&&l.detail.query||"",dt(),He()}),document.addEventListener("userToolbar:assignee",l=>{ye=l&&l.detail&&l.detail.assignee||"me",dt(),ca();const m=gn.get(xn());m&&m.perCase&&m.titles&&(nt=new Map(m.perCase),be=new Map(m.titles),He()),ia(at||me)}),document.addEventListener("userToolbar:clear",()=>{$e=new Set(["open","in progress","complete"]),Ue="all",_e="none",dt(),He()});try{await ua(ha)}catch(l){console.error("Failed to sign in anonymously",l);return}const f=prompt("Enter shared passphrase");if(f&&(Cn=await Ca(f),me=await Jn(),!!me)){va(),xa(),$a(),Le&&Array.from(Le.options).forEach(l=>{l.selected=K.location.has(l.value)}),Te&&Array.from(Te.options).forEach(l=>{l.selected=K.consultant.has(l.value)}),Va(),Ze("table");try{const r=new URL(window.location.href).searchParams.get("case");r&&ht(r,"Case","table","notes")}catch{}window.addEventListener("popstate",()=>{try{const r=new URL(window.location.href).searchParams.get("case");r?ie!==r&&ht(r,"Case","table","notes"):(ve.hidden=!0,ce&&(ce.hidden=!1))}catch{}})}});function j(t){const n=document.getElementById("toast-container");if(!n)return;const e=document.createElement("div");e.className="toast",e.textContent=t,n.appendChild(e),setTimeout(()=>{e.remove()},3300)}async function oa(t){const n=await ut(ae(S,"cases",t,"tasks"));for(const o of n.docs){const s=await ut(ae(S,"cases",t,"tasks",o.id,"comments"));await Promise.all(s.docs.map(a=>xe(G(S,"cases",t,"tasks",o.id,"comments",a.id)))),await xe(G(S,"cases",t,"tasks",o.id))}const e=await ut(ae(S,"cases",t,"notes"));await Promise.all(e.docs.map(o=>xe(G(S,"cases",t,"notes",o.id)))),await xe(G(S,"cases",t))}function Va(){const t=document.getElementById("user-list"),n=document.getElementById("add-user-btn"),e=document.getElementById("users-menu"),o=document.getElementById("users-btn"),s=document.getElementById("location-list"),a=document.getElementById("add-location-btn"),c=document.getElementById("manage-tags-btn");if(!t||!n||!e||!o||!s||!a)return;const d=m=>{e.hidden=!m,o.setAttribute("aria-expanded",String(m))};o.addEventListener("click",m=>{m.stopPropagation(),d(e.hidden)}),document.addEventListener("click",m=>{!e.hidden&&!e.contains(m.target)&&m.target!==o&&d(!1)}),n.addEventListener("click",async m=>{m.stopPropagation();const i=(prompt("Add user name")||"").trim();i&&await Me(ae(S,"users"),{username:i,createdAt:Oe()})}),c&&c.addEventListener("click",m=>{m.stopPropagation(),d(!1),r()});const f=Ce(ae(S,"users"),Ne("username"));Pt&&(Pt(),Pt=null),Pt=Ie(f,m=>{t.innerHTML="",Ve=[];for(const i of m.docs){const u=i.data().username||"Unknown";Ve.push({id:i.id,username:u});const p=document.createElement("li"),v=document.createElement("button");v.className="name icon-btn",v.textContent=u,v.addEventListener("click",()=>{d(!1),me=u,bn(u)});const C=document.createElement("button");C.className="icon-btn",C.textContent="‚úèÔ∏è",C.setAttribute("aria-label",`Edit ${u}`),C.addEventListener("click",async L=>{L.stopPropagation();const x=(prompt("Edit user name",u)||"").trim();!x||x===u||await se(G(S,"users",i.id),{username:x})});const E=document.createElement("button");E.className="icon-btn delete-btn",E.textContent="üóë",E.setAttribute("aria-label",`Delete ${u}`),E.addEventListener("click",async L=>{L.stopPropagation(),confirm(`Delete user '${u}'?`)&&await xe(G(S,"users",i.id))}),p.appendChild(v),p.appendChild(C),p.appendChild(E),t.appendChild(p)}aa();try{const i=Ve.map(h=>h.username);document.dispatchEvent(new CustomEvent("userToolbar:users",{detail:{users:i}}))}catch{}});const l=Ce(ae(S,"locations"),Ne("name"));$t&&($t(),$t=null),$t=Ie(l,m=>{s.innerHTML="",sn=[];for(const i of m.docs){const u=(i.data().name||"").trim()||"Unnamed";sn.push({id:i.id,name:u});const p=document.createElement("li"),v=document.createElement("button");v.className="name icon-btn",v.textContent=u;const C=document.createElement("button");C.className="icon-btn",C.textContent="‚úèÔ∏è",C.setAttribute("aria-label",`Edit ${u}`),C.addEventListener("click",async L=>{L.stopPropagation();const x=(prompt("Edit location",u)||"").trim();if(!(!x||x===u))try{await se(G(S,"locations",i.id),{name:x})}catch(T){console.error("Failed to update location",T),j("Failed to update location (permissions)")}});const E=document.createElement("button");E.className="icon-btn delete-btn",E.textContent="üóë",E.setAttribute("aria-label",`Delete ${u}`),E.addEventListener("click",async L=>{if(L.stopPropagation(),!!confirm(`Delete location '${u}'?`))try{await xe(G(S,"locations",i.id))}catch(x){console.error("Failed to delete location",x),j("Failed to delete location (permissions)")}}),p.appendChild(v),p.appendChild(C),p.appendChild(E),s.appendChild(p)}Ya()},m=>{console.error("Locations listener error",m),j("Cannot access locations (permissions)")});function r(){const m=document.createElement("div");m.className="modal-overlay";const i=document.createElement("div");i.className="modal tags-manager",m.appendChild(i);const h=document.createElement("h3");h.textContent="Manage Tags",i.appendChild(h);const u=document.createElement("div");u.className="tabs";const p=document.createElement("button");p.className="tab active",p.textContent="Locations",u.appendChild(p);const v=document.createElement("button");v.className="tab",v.textContent="Consultants",u.appendChild(v),i.appendChild(u);const C=document.createElement("div");i.appendChild(C);const E=document.createElement("div");E.className="section-actions",i.appendChild(E);const L=document.createElement("button");L.className="btn",L.textContent="Close",E.appendChild(L),document.body.appendChild(m);const x=_=>{p.classList.toggle("active",_==="loc"),v.classList.toggle("active",_==="cons"),A(_)};p.addEventListener("click",()=>x("loc")),v.addEventListener("click",()=>x("cons")),L.addEventListener("click",()=>m.remove());const T=()=>{const _=p.classList.contains("active")?"loc":"cons";A(_)},F=_=>{p.classList.contains("active")&&A("loc")};document.addEventListener("tags:updated",T),document.addEventListener("subtags:updated",F);const D=()=>{document.removeEventListener("tags:updated",T),document.removeEventListener("subtags:updated",F)};L.addEventListener("click",D,{once:!0}),x("loc");async function A(_){var $;if(C.innerHTML="",_==="cons"){U("consultant");return}const Y=document.createElement("div");Y.className="grid",C.appendChild(Y);const V=document.createElement("div");V.className="tags-list",Y.appendChild(V);const q=document.createElement("div");q.className="rooms-list",Y.appendChild(q);const O=document.createElement("h4");O.textContent="Wards",V.appendChild(O);const M=document.createElement("h4");M.textContent="Rooms",q.appendChild(M);const P=document.createElement("div");V.appendChild(P);const J=document.createElement("div");J.className="section-actions",V.appendChild(J);const B=document.createElement("button");B.textContent="Add ward",B.className="btn",J.appendChild(B);let g=(($=(le.get("location")||[])[0])==null?void 0:$.id)||"";function H(){P.innerHTML="";const k=le.get("location")||[];for(let w=0;w<k.length;w++){const N=k[w],b=document.createElement("div");b.className="entry";const I=document.createElement("span");I.className="name",I.textContent=`${w+1}. ${N.name}`,b.appendChild(I),b.addEventListener("click",()=>{g=N.id,y()});const R=document.createElement("div");R.className="row-actions";const X=document.createElement("button");X.textContent="‚Üë",X.addEventListener("click",()=>Rt("location",w,-1)),R.appendChild(X);const z=document.createElement("button");z.textContent="‚Üì",z.addEventListener("click",()=>Rt("location",w,1)),R.appendChild(z);const ee=document.createElement("button");ee.textContent="Edit",ee.addEventListener("click",()=>In(N.id,N.name)),R.appendChild(ee);const W=document.createElement("button");W.textContent="Delete",W.addEventListener("click",()=>Sn("location",N.id)),R.appendChild(W),b.appendChild(R),P.appendChild(b)}}H(),B.addEventListener("click",()=>zt("location"));async function y(){q.innerHTML="";const k=document.createElement("h4");k.textContent="Rooms",q.appendChild(k);const w=document.createElement("div");q.appendChild(w);const N=await vn(g);for(let R=0;R<N.length;R++){const X=N[R],z=document.createElement("div");z.className="entry";const ee=document.createElement("span");ee.className="name",ee.textContent=`${R+1}. ${X.name}`,z.appendChild(ee);const W=document.createElement("div");W.className="row-actions";const Z=document.createElement("button");Z.textContent="‚Üë",Z.addEventListener("click",()=>An(g,R,-1)),W.appendChild(Z);const te=document.createElement("button");te.textContent="‚Üì",te.addEventListener("click",()=>An(g,R,1)),W.appendChild(te);const Q=document.createElement("button");Q.textContent="Edit",Q.addEventListener("click",()=>Ga(g,X.id,X.name)),W.appendChild(Q);const he=document.createElement("button");he.textContent="Delete",he.addEventListener("click",()=>Xa(g,X.id)),W.appendChild(he),z.appendChild(W),w.appendChild(z)}const b=document.createElement("div");b.className="section-actions",q.appendChild(b);const I=document.createElement("button");I.className="btn",I.textContent="Add room",I.addEventListener("click",()=>sa(g)),b.appendChild(I)}y()}function U(_){C.innerHTML="";const Y=document.createElement("div");Y.className="tags-list",C.appendChild(Y);const V=document.createElement("h4");V.textContent="Consultants",Y.appendChild(V);const q=document.createElement("div");Y.appendChild(q);const O=le.get(_)||[];for(let J=0;J<O.length;J++){const B=O[J],g=document.createElement("div");g.className="entry";const H=document.createElement("span");H.className="name",H.textContent=`${J+1}. ${B.name}`,g.appendChild(H);const y=document.createElement("div");y.className="row-actions";const $=document.createElement("button");$.textContent="‚Üë",$.addEventListener("click",()=>Rt(_,J,-1)),y.appendChild($);const k=document.createElement("button");k.textContent="‚Üì",k.addEventListener("click",()=>Rt(_,J,1)),y.appendChild(k);const w=document.createElement("button");w.textContent="Edit",w.addEventListener("click",()=>In(B.id,B.name)),y.appendChild(w);const N=document.createElement("button");N.textContent="Delete",N.addEventListener("click",()=>Sn(_,B.id)),y.appendChild(N),g.appendChild(y),q.appendChild(g)}const M=document.createElement("div");M.className="section-actions",Y.appendChild(M);const P=document.createElement("button");P.className="btn",P.textContent="Add",P.addEventListener("click",()=>zt(_)),M.appendChild(P)}}a.addEventListener("click",async m=>{m.stopPropagation();const i=(prompt("Add location name")||"").trim();if(i)try{await Me(ae(S,"locations"),{name:i,createdAt:Oe()})}catch(h){console.error("Failed to add location",h),j("Failed to add location (permissions)")}})}function Ya(){const t=document.getElementById("case-location");if(!t)return;const n=t.value;t.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="No location",t.appendChild(e);for(const o of sn){const s=document.createElement("option");s.value=o.name,s.textContent=o.name,t.appendChild(s)}t.value=n||""}async function zt(t){try{const n=(prompt(`Add ${t}`)||"").trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),s=le.get(t)||[];await Me(ae(S,"tags"),{type:t,order:s.length,nameCipher:e,nameIv:o})}catch(n){console.error("Failed to add tag",n),j("Failed to add tag")}}async function In(t,n){try{const e=(prompt("Rename",n)||"").trim();if(!e)return;const{cipher:o,iv:s}=await ne(e);await se(G(S,"tags",t),{nameCipher:o,nameIv:s})}catch(e){console.error("Failed to rename tag",e),j("Failed to rename")}}async function Sn(t,n){try{if(!confirm("Delete tag and its rooms (if any)?"))return;const e=await ut(ae(S,"tags",n,"subtags"));for(const o of e.docs)await xe(G(S,"tags",n,"subtags",o.id));await xe(G(S,"tags",n))}catch(e){console.error("Failed to delete tag",e),j("Failed to delete")}}async function Rt(t,n,e){try{const o=(le.get(t)||[]).slice(),s=n+e;if(s<0||s>=o.length)return;const a=o[n],c=o[s];await Promise.all([se(G(S,"tags",a.id),{order:s}),se(G(S,"tags",c.id),{order:n})])}catch(o){console.error("Failed to reorder",o),j("Failed to reorder")}}async function sa(t){try{if(!t)return;const n=(prompt("Add room")||"").trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),s=Fe.get(t)||[];await Me(ae(S,"tags",t,"subtags"),{type:"room",order:s.length,nameCipher:e,nameIv:o})}catch(n){console.error("Failed to add room",n),j("Failed to add room")}}async function Ga(t,n,e){try{const o=(prompt("Rename room",e)||"").trim();if(!o)return;const{cipher:s,iv:a}=await ne(o);await se(G(S,"tags",t,"subtags",n),{nameCipher:s,nameIv:a})}catch(o){console.error("Failed to rename room",o),j("Failed to rename room")}}async function Xa(t,n){try{if(!confirm("Delete this room?"))return;await xe(G(S,"tags",t,"subtags",n))}catch(e){console.error("Failed to delete room",e),j("Failed to delete room")}}async function An(t,n,e){try{const o=(Fe.get(t)||[]).slice(),s=n+e;if(s<0||s>=o.length)return;const a=o[n],c=o[s];await Promise.all([se(G(S,"tags",t,"subtags",a.id),{order:s}),se(G(S,"tags",t,"subtags",c.id),{order:n})])}catch(o){console.error("Failed to reorder room",o),j("Failed to reorder room")}}function bn(t){at=t,ca(),Be&&(Be.style.display="none"),ve.hidden=!0,qe.hidden=!1;const n=document.getElementById("change-user-link");n&&n.addEventListener("click",async()=>{const s=await Jn();s&&s!==me&&(me=s,bn(s))},{once:!0});const e=Gn.get(t);e&&typeof e=="object"?($e=new Set(e.statuses||["open","in progress","complete"]),Ue=e.priority||"all",_e=e.sort||"none",Ye=e.search||"",ye=e.assignee||"me"):($e=new Set(["open","in progress","complete"]),Ue="all",_e="none",Ye="",ye="me"),mn.length&&mn.forEach(s=>s.checked=$e.has(s.value)),un&&(un.value=Ue),pn&&(pn.value=_e),document.dispatchEvent(new CustomEvent("userToolbar:hydrate",{detail:{statuses:Array.from($e),priority:Ue,sort:_e,search:Ye,assignee:ye}}));const o=gn.get(xn());o&&o.perCase&&o.titles?(nt=new Map(o.perCase),be=new Map(o.titles),He()):pt&&(pt.innerHTML='<li style="list-style:none;color:var(--muted);padding:8px 0;">Loading‚Ä¶</li>'),ia(t)}function ca(){if(!tn)return;let t="";ye==="all"?t="All tasks":ye==="unassigned"?t="Unassigned tasks":ye==="me"?t=`${me||at||"Me"}'s tasks`:ye.startsWith("name:")&&(t=`${ye.slice(5)}'s tasks`),tn.innerHTML=`${t} <button id="change-user-link" class="change-user-link" type="button">(Change user)</button>`}function xn(){return ye||"me"}function dt(){at&&Gn.set(at,{statuses:Array.from($e),priority:Ue,sort:_e,search:Ye,assignee:ye})}async function ia(t){if(Array.isArray(et)){for(const s of et)try{s()}catch{}et=[]}be||(be=new Map),nt||(nt=new Map);let n=ra(S,"tasks"),e;ye==="all"?e=n:ye==="unassigned"?e=Ce(n,Ft("assignee","==",null)):ye==="me"?e=Ce(n,Ft("assignee","==",me||t)):ye.startsWith("name:")?e=Ce(n,Ft("assignee","==",ye.slice(5))):e=Ce(n,Ft("assignee","==",me||t));const o=Ie(e,async s=>{try{const a=s.docs,c=new Map,d=[],f=[],l=new Set;for(const m of a){const i=m.data(),h=m.ref.parent&&m.ref.parent.parent,u=h?h.id:null;if(!u)continue;l.add(u);const p={taskId:m.id,caseId:u,assignee:i.assignee||null,priority:i.priority||null,text:null,status:null};f.push(p),d.push(Promise.all([oe(i.textCipher,i.textIv),oe(i.statusCipher,i.statusIv)]).then(([v,C])=>{p.text=v,p.status=C}).catch(v=>{console.error("Decrypt task failed",v)}))}await Promise.all(d);for(const m of f)!m||!m.caseId||!m.text||(c.has(m.caseId)||c.set(m.caseId,[]),c.get(m.caseId).push(m));const r=[];for(const m of l)be.has(m)||r.push(Bn(G(S,"cases",m)).then(async i=>{if(i.exists()){const h=i.data();try{const u=await oe(h.titleCipher,h.titleIv);be.set(m,u)}catch{be.set(m,"(case)")}}else be.set(m,"(case)")}).catch(()=>{be.set(m,"(case)")}));if(await Promise.all(r),nt=c,gn.set(xn(),{perCase:new Map(c),titles:new Map(be)}),dn){rn=!0;return}He()}catch(a){console.error("Failed to build user tasks view",a)}});et.push(o)}function He(){if(!pt)return;pt.innerHTML="";const t=Array.from(nt.keys()).sort((n,e)=>(be.get(n)||"").localeCompare(be.get(e)||""));for(const n of t){let e=nt.get(n)||[];if($e&&$e.size&&(e=e.filter(i=>$e.has(i.status))),Ue!=="all"&&(e=e.filter(i=>(i.priority||"")===Ue)),Ye&&Ye.trim()){const i=Ye.toLowerCase();e=e.filter(h=>(h.text||"").toLowerCase().includes(i))}if(e.length===0)continue;const o=be.get(n)||"(case)",s=document.createElement("div");s.className="card user-case-card";const a=document.createElement("div");a.className="user-case-header";const c=document.createElement("h3"),d=document.createElement("button");d.className="link-btn",d.textContent=o,d.setAttribute("aria-label",`Open case ${o}`),d.addEventListener("click",()=>ht(n,o,"user","notes")),c.appendChild(d),a.appendChild(c);const f=document.createElement("span");f.className="badge",f.textContent=String(e.length),a.appendChild(f),s.appendChild(a);const l=document.createElement("ul"),r=i=>i==="high"?3:i==="medium"?2:i==="low"?1:0;let m=[...e];_e==="pri-desc"?m.sort((i,h)=>r(h.priority)-r(i.priority)):_e==="pri-asc"&&m.sort((i,h)=>r(i.priority)-r(h.priority));for(const i of m){const h=document.createElement("li"),u=i.status==="in progress"?"s-inprogress":i.status==="complete"?"s-complete":"s-open";h.className="case-task "+u;const p=document.createElement("button");p.type="button",p.className="status-btn";const v=B=>B==="complete"?"‚òë":B==="in progress"?"‚óê":"‚òê";p.textContent=v(i.status),p.setAttribute("aria-label",`Task status: ${i.status}`),p.addEventListener("click",async B=>{B.stopPropagation();const g=["open","in progress","complete"],H=g[(g.indexOf(i.status)+1)%g.length];try{const{cipher:y,iv:$}=await ne(H);if(await se(G(S,"cases",n,"tasks",i.taskId),{statusCipher:y,statusIv:$}),i.status=H,p.textContent=v(H),p.setAttribute("aria-label",`Task status: ${H}`),h.className="case-task "+(H==="in progress"?"s-inprogress":H==="complete"?"s-complete":"s-open"),H==="complete")try{const k=await ne(i.text||"");await Ge({type:"task_completed",caseId:n,caseTitle:o,taskId:i.taskId,taskTextCipher:k.cipher,taskTextIv:k.iv})}catch{}}catch(y){console.error("Failed to update status",y),j("Failed to update status")}});const C=document.createElement("span");if(C.className="task-text",C.textContent=i.text,C.addEventListener("click",B=>{B.stopPropagation(),dn=!0;const g=document.createElement("div");g.className="cell-editable",g.setAttribute("contenteditable","true"),g.textContent=i.text;let H=i.text;const y=()=>{try{g.remove()}catch{}C.style.display="",dn=!1,rn&&(rn=!1,He())},$=async()=>{const k=(g.innerText||"").replace(/\r/g,"");if(k===H){y();return}try{const{cipher:w,iv:N}=await ne(k);await se(G(S,"cases",n,"tasks",i.taskId),{textCipher:w,textIv:N}),H=k,C.textContent=k}catch(w){console.error("Failed to update task",w),j("Failed to update task")}y()};g.addEventListener("paste",k=>{k.preventDefault();const w=(k.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,w);else{const N=window.getSelection();N&&N.rangeCount&&(N.deleteFromDocument(),N.getRangeAt(0).insertNode(document.createTextNode(w)))}}),g.addEventListener("keydown",k=>{k.key==="Enter"&&!(k.ctrlKey||k.metaKey)?(k.preventDefault(),$()):k.key==="Escape"&&(k.preventDefault(),y())}),g.addEventListener("blur",()=>{$()}),C.insertAdjacentElement("afterend",g),C.style.display="none",g.focus()}),h.appendChild(p),h.appendChild(C),i.priority){const B=document.createElement("span");B.className="mini-chip",B.textContent=i.priority,h.appendChild(B)}const E=document.createElement("span");E.className="mini-avatar";const L=i.assignee?i.assignee.split(/\s+/).map(B=>B[0]).join("").slice(0,2).toUpperCase():"";E.textContent=L||"";const x=En(i.assignee||"");E.style.background=x.bg,E.style.color=x.color,E.style.border=`1px solid ${x.border}`;let T=null;const F=()=>{T&&(T.remove(),T=null)};E.addEventListener("mouseenter",()=>{if(!i.assignee)return;T=document.createElement("div"),T.className="assignee-tip",T.textContent=i.assignee,T.style.position="fixed",T.style.zIndex="2147483647",document.body.appendChild(T);const B=E.getBoundingClientRect();requestAnimationFrame(()=>{const g=T.offsetHeight||24;T.style.left=`${Math.round(B.left+B.width/2)}px`,T.style.top=`${Math.round(B.top-6-g)}px`,T.style.transform="translateX(-50%)"})}),E.addEventListener("mouseleave",F),E.addEventListener("click",B=>{B.stopPropagation(),F();const g=document.querySelector(".assignee-panel");g&&g.remove();const H=document.createElement("div");H.className="assignee-panel",H.style.position="fixed",H.style.zIndex="2147483646";const y=(w,N)=>{const b=document.createElement("button");b.type="button",b.className="assignee-option",b.textContent=w,b.addEventListener("click",async I=>{var R;I.stopPropagation();try{if(await se(G(S,"cases",n,"tasks",i.taskId),{assignee:N}),at&&N!==at){h.remove();const X=parseInt(((R=s.querySelector(".badge"))==null?void 0:R.textContent)||"1",10);!Number.isNaN(X)&&X>0&&(s.querySelector(".badge").textContent=String(X-1))}}catch(X){console.error("Failed to reassign",X),j("Failed to reassign")}finally{H.remove()}}),H.appendChild(b)};y("Unassigned",null);for(const w of Ve)y(w.username,w.username);document.body.appendChild(H);const $=E.getBoundingClientRect();requestAnimationFrame(()=>{const w=H.offsetWidth||180,N=Math.min(Math.max(8,$.right-w),window.innerWidth-w-8),b=Math.min(window.innerHeight-H.offsetHeight-8,$.bottom+6);H.style.left=`${Math.round(N)}px`,H.style.top=`${Math.round(b)}px`});const k=w=>{!H||H.contains(w.target)||w.target===E||(H.remove(),document.removeEventListener("click",k,!0))};setTimeout(()=>document.addEventListener("click",k,!0),0)}),h.appendChild(E);const D=document.createElement("button");D.type="button",D.className="icon-btn delete-btn",D.textContent="üóë",D.title="Delete task",D.addEventListener("click",async B=>{if(B.stopPropagation(),!!confirm("Delete this task?"))try{await xe(G(S,"cases",n,"tasks",i.taskId)),h.remove();const g=s.querySelector(".badge");if(g){const H=parseInt(g.textContent||"1",10);!Number.isNaN(H)&&H>0&&(g.textContent=String(H-1))}}catch(g){console.error("Failed to delete task",g),j("Failed to delete task")}}),h.appendChild(D);const A=document.createElement("button");A.type="button",A.className="icon-btn comment-toggle",A.setAttribute("aria-label","Show comments"),A.textContent="üí¨";const U=document.createElement("span");U.className="badge comment-count",h.appendChild(A),h.appendChild(U);const _=document.createElement("div");_.className="comment-section",_.hidden=!0;const Y=document.createElement("ul");Y.className="comments",_.appendChild(Y);const V=document.createElement("form");V.className="comment-form";const q=document.createElement("input");q.placeholder="Add comment",V.appendChild(q);const O=document.createElement("button");O.className="icon-btn add-comment-btn",O.type="submit",O.textContent="‚ûï",O.setAttribute("aria-label","Add comment"),V.appendChild(O),_.appendChild(V);let M=!1,P=0;const J=()=>{U.textContent=P>0?String(P):"",A.textContent=_.hidden?"üí¨":"‚úñ",A.setAttribute("aria-label",_.hidden?"Show comments":"Hide comments")};J(),A.addEventListener("click",()=>{const B=_.hidden;_.hidden=!B,J(),B&&!M&&(Lt(n,i.taskId,Y,g=>{P=g,J()}),M=!0)}),V.addEventListener("submit",async B=>{B.preventDefault();const g=q.value.trim();if(!g)return;const H=document.createElement("li");H.className="optimistic";const y=document.createElement("span");y.textContent=me?`${me}: ${g}`:g,H.appendChild(y),Y.appendChild(H),q.value="",_.hidden=!1,J();try{const{cipher:$,iv:k}=await ne(g);await Me(ae(S,"cases",n,"tasks",i.taskId,"comments"),{cipher:$,iv:k,username:me,createdAt:Oe()});try{await Ge({type:"comment_added",caseId:n,taskId:i.taskId,commentCipher:$,commentIv:k})}catch{}M||(Lt(n,i.taskId,Y,w=>{P=w,J()}),M=!0)}catch{H.classList.add("failed"),j("Failed to add comment")}}),h.appendChild(_),l.appendChild(h)}s.appendChild(l),pt.appendChild(s)}}
