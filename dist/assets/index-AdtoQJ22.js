import{initializeApp as ua}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";import{getFirestore as pa,addDoc as Fe,collection as ae,serverTimestamp as We,query as ge,orderBy as Ne,onSnapshot as Ie,updateDoc as oe,doc as X,deleteDoc as Te,collectionGroup as fa,where as $t,getDoc as $n,getDocs as ht,limit as Rn}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import{getAuth as ha,signInAnonymously as ya}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=e(a);fetch(a.href,s)}})();const ga={apiKey:"AIzaSyBo5a6Uxk1vJwS8WqFnccjSnNOOXreOhcg",authDomain:"catalist-1.firebaseapp.com",projectId:"catalist-1",storageBucket:"catalist-1.firebasestorage.app",messagingSenderId:"843924921323",appId:"1:843924921323:web:0e7a847f8cd70db55f57ae",measurementId:"G-6NZEC4ED4C"},Hn=ua(ga),I=pa(Hn),Ca=ha(Hn);let kn,ie,Be,on,sn,bt,ve,Je,An,qn,cn,wt,_n,Un,On,Wn,Kn,zn,jn,Vn,Yn,Gn,Xn,se,$e,we,dt,ot,Pe,st,Qt,en,tn,xe,Le,mt,ln,Qe,xt,_e,rn,yt,nn,an,le=null,vt=!1,Rt=!1,Ut="list",Jn=0,tt=null,Ce=null,ke=null,he=null,ze=null,Ee=null,Ot=null,It=[],dn=new Map,Wt=new Set(["task_added","task_completed","comment_added","note_added"]),Kt="",zt="",St=0,de=null,pe=null,ct=new Map,Ht=null,qt=null,Ve=[],mn=[],Ze=[],ut=null,jt=new Set(["open","in progress","complete"]),Vt="all",Lt="none",Yt="",Zn=[],Qn=null,et=new Map,be=new Map,Re=new Set(["open","in progress","complete"]),Ue="all",Oe="none",wn=new Map,ye="me",un=!1,pn=!1,fn=!1,hn=!1,Ye="",yn=[],gn,Cn,ea=new Map;const Ea=["#fef3c7","#fde68a","#dcfce7","#bbf7d0","#dbeafe","#bfdbfe","#e0e7ff","#ddd6fe","#fae8ff","#fee2e2","#ffe4e6","#f3e8ff"];let ft=!0;function Bn(t){ft=!!t;const n=document.getElementById("table-section");n&&n.classList.toggle("cell-color-disabled",!t);try{localStorage.setItem("table.showCellColor",t?"1":"0")}catch{}if(!t){const e=document.querySelector(".color-panel");e&&e.remove()}}let re=new Map,Me=new Map,j={location:new Set,consultant:new Set,room:new Set},me="none",He="asc";function it(t){return Array.from(t||[]).join(",")}function lt(t){return new Set((t||"").split(",").map(n=>n.trim()).filter(Boolean))}function Ae(){try{localStorage.setItem("table.filters.location",it(j.location)),localStorage.setItem("table.filters.consultant",it(j.consultant)),localStorage.setItem("table.filters.room",it(j.room)),localStorage.setItem("table.sort.key",me||"none"),localStorage.setItem("table.sort.dir",He||"asc")}catch{}try{const t=new URL(window.location.href),n=t.searchParams,e=(a,s)=>{s?n.set(a,s):n.delete(a)};e("loc",it(j.location)),e("cons",it(j.consultant)),e("room",it(j.room)),e("sort",me&&me!=="none"?me:""),e("dir",He&&me!=="none"?He:"");const o=t.toString();window.history.replaceState(null,"",o)}catch{}}function va(){try{const n=new URL(window.location.href).searchParams,e=n.get("loc"),o=n.get("cons"),a=n.get("room"),s=n.get("sort"),c=n.get("dir");if(e||o||a||s){e&&(j.location=lt(e)),o&&(j.consultant=lt(o)),a&&(j.room=lt(a)),s&&(me=s),c&&(He=c);return}}catch{}try{j.location=lt(localStorage.getItem("table.filters.location")),j.consultant=lt(localStorage.getItem("table.filters.consultant")),j.room=lt(localStorage.getItem("table.filters.room")),me=localStorage.getItem("table.sort.key")||"none",He=localStorage.getItem("table.sort.dir")||"asc"}catch{}}function Tt(t){const n=document.getElementById("table-tags-controls"),e=document.getElementById("table-section");if(!n||!e)return;let o=document.getElementById("filters-placeholder");if(t){n.style.display="none",o||(o=document.createElement("div"),o.id="filters-placeholder",o.className="filters-placeholder",e.insertBefore(o,document.getElementById("table-root"))),o.innerHTML="";const a=document.createElement("button");a.type="button",a.className="show-filters-btn",a.textContent="Show Filters",a.addEventListener("click",()=>Tt(!1)),o.appendChild(a);try{localStorage.setItem("tableFiltersHidden","1")}catch{}}else{n.style.display="",o&&o.remove();try{localStorage.setItem("tableFiltersHidden","0")}catch{}}}async function ta(){const t=document.createElement("div");t.className="modal-overlay";const n=document.createElement("div");n.className="modal",t.appendChild(n);const e=document.createElement("h3");e.textContent="New Case",n.appendChild(e);const o=document.createElement("div");o.className="stack",n.appendChild(o);const a=document.createElement("label");a.textContent="Title";const s=document.createElement("input");s.placeholder="Enter case title",s.setAttribute("aria-label","Case title"),a.appendChild(s),o.appendChild(a);const c=document.createElement("label");c.textContent="Location";const d=document.createElement("select");c.appendChild(d),o.appendChild(c);const h=document.createElement("label");h.textContent="Room";const l=document.createElement("select");h.appendChild(l),o.appendChild(h);const m=document.createElement("label");m.textContent="Consultant";const r=document.createElement("select");m.appendChild(r),o.appendChild(m);const i=document.createElement("div");i.className="actions";const f=document.createElement("button");f.className="btn",f.textContent="Cancel";const u=document.createElement("button");u.className="btn primary",u.textContent="Create",i.appendChild(f),i.appendChild(u),n.appendChild(i),document.body.appendChild(t);const p=(S,O,M=!0)=>{if(S.innerHTML="",M){const L=document.createElement("option");L.value="",L.textContent="Unassigned",S.appendChild(L)}for(const L of O){const q=document.createElement("option");q.value=L.id,q.textContent=L.name,S.appendChild(q)}},w=async()=>{const S=d.value||"";if(S){const O=await Ln(S);p(l,O,!0)}else p(l,[],!0)};p(d,re.get("location")||[]),p(r,re.get("consultant")||[]);const E=Array.from(j.location||[]);E.length===1&&(d.value=E[0]);const y=Array.from(j.consultant||[]);y.length===1&&(r.value=y[0]),await w();const D=Array.from(j.room||[]);D.length===1&&(l.value=D[0]),d.addEventListener("change",async()=>{await w(),l.value=""});const F=()=>t.remove();f.addEventListener("click",F),u.addEventListener("click",async()=>{const S=(s.value||"").trim();if(!S){s.focus();return}try{const O=await ne(S),M={location:d.value||null,consultant:r.value||null},L=d.value||null,q=l.value||null;L&&q?M.room=q:M.room=null,await Fe(ae(I,"cases"),{titleCipher:O.cipher,titleIv:O.iv,createdAt:We(),caseTags:M}),F(),Y("Case created")}catch(O){console.error("Failed to create case",O),Y("Failed to create case")}}),s.focus()}function xn(t){if(!t)return{bg:"#e5e7eb",border:"#d1d5db",color:"#374151"};let n=0;for(let s=0;s<t.length;s++)n=(n*31+t.charCodeAt(s))%360;const e=`hsl(${n}, 70%, 90%)`,o=`hsl(${n}, 60%, 65%)`,a=`hsl(${n}, 40%, 25%)`;return{bg:e,border:o,color:a}}async function ba(t){const n=new TextEncoder,e=n.encode("shared-salt"),o=await crypto.subtle.importKey("raw",n.encode(t),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function ka(t){return btoa(String.fromCharCode(...new Uint8Array(t)))}function wa(t){return Uint8Array.from(atob(t),n=>n.charCodeAt(0))}async function ne(t){const n=new TextEncoder,e=crypto.getRandomValues(new Uint8Array(12)),o=await crypto.subtle.encrypt({name:"AES-GCM",iv:e},kn,n.encode(t));return{cipher:ka(o),iv:Array.from(e)}}async function ce(t,n){const e=new TextDecoder,o=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(n)},kn,wa(t));return e.decode(o)}async function At(t,n,e="list",o="notes"){le=t,Ut=e==="user"?"user":e==="table"?"table":e==="updates"?"updates":"list",Je.textContent=n,se&&(se.hidden=!0),we&&(we.hidden=!0),Be&&(Be.style.display="none"),_e.hidden=!0,ve.hidden=!1,Ia(t),za(t),bn(o);try{const a=new URL(window.location.href);a.searchParams.set("case",t),window.history.pushState({caseId:t},"",a.toString())}catch{}}function pt(t){const n=document.getElementById("tab-table"),e=document.getElementById("tab-my"),o=document.getElementById("tab-updates"),a=t==="table",s=t==="my",c=t==="updates";if(n&&(n.classList.toggle("active",a),n.setAttribute("aria-selected",String(a))),e&&(e.classList.toggle("active",s),e.setAttribute("aria-selected",String(s))),o&&(o.classList.toggle("active",c),o.setAttribute("aria-selected",String(c))),a){if(Be&&(Be.style.display="none"),ve.hidden=!0,_e.hidden=!0,we&&(we.hidden=!0),se&&(se.hidden=!1),ze||_a(),Ee){try{Ee()}catch{}Ee=null}}else if(s){if(se&&(se.hidden=!0),ze&&(ze(),ze=null),we&&(we.hidden=!0),Ee){try{Ee()}catch{}Ee=null}Tn(ie)}else if(c){se&&(se.hidden=!0),ze&&(ze(),ze=null),ve.hidden=!0,_e.hidden=!0,we&&(we.hidden=!1),Ee||Da();try{const d=`updates.lastSeen:${ie||""}`;St=parseInt(localStorage.getItem(d)||"0",10)||0}catch{St=0}}else{if(we&&(we.hidden=!0),Ee){try{Ee()}catch{}Ee=null}se&&(se.hidden=!1)}}function na(){return new Promise(async t=>{const n=document.createElement("div");n.className="modal-overlay";const e=document.createElement("div");e.className="modal",n.appendChild(e);const o=document.createElement("h3");o.textContent="Select your user",e.appendChild(o);const a=document.createElement("div");a.className="row",e.appendChild(a);const s=document.createElement("select");s.style.height="48px",s.style.borderRadius="12px",s.style.border="1px solid #e5e7eb",s.style.padding="0 12px",a.appendChild(s);const c=document.createElement("div");c.className="actions",e.appendChild(c);const d=document.createElement("button");d.className="btn",d.textContent="Cancel",c.appendChild(d);const h=document.createElement("button");h.className="btn primary",h.textContent="Continue",c.appendChild(h),document.body.appendChild(n);let l=null;const m=i=>{const f=s.value;s.innerHTML="";for(const u of i){const p=document.createElement("option");p.value=u,p.textContent=u,s.appendChild(p)}f&&i.includes(f)&&(s.value=f)};try{const i=ge(ae(I,"users"),Ne("username"));l=Ie(i,f=>{const u=f.docs.map(p=>(p.data().username||"").trim()).filter(Boolean);m(u)})}catch{const f=await ht(ge(ae(I,"users"),Ne("username")));m(f.docs.map(u=>(u.data().username||"").trim()).filter(Boolean))}const r=()=>{l&&l(),n.remove()};d.addEventListener("click",()=>{r(),t("")}),h.addEventListener("click",()=>{const i=s.value||"";r(),t(i)}),s.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),h.click())}),s.focus()})}function xa(){const t=ge(ae(I,"tags"),Ne("order"));Ie(t,async n=>{const e=new Map;for(const o of n.docs){const a=o.data(),s=a.type||"";let c="";try{c=await ce(a.nameCipher,a.nameIv)}catch{}const d={id:o.id,name:c,order:typeof a.order=="number"?a.order:0,type:s};e.has(s)||e.set(s,[]),e.get(s).push(d)}for(const[o,a]of e)a.sort((s,c)=>s.order-c.order||s.name.localeCompare(c.name));re=e,La(),document.dispatchEvent(new CustomEvent("tags:updated"))},n=>console.error("Tags listener error",n))}function Ln(t){return t?Me.has(t)?Promise.resolve(Me.get(t)):new Promise(n=>{const e=ge(ae(I,"tags",t,"subtags"),Ne("order"));Ie(e,async o=>{const a=[];for(const s of o.docs){const c=s.data();let d="";try{d=await ce(c.nameCipher,c.nameIv)}catch{}a.push({id:s.id,name:d,order:typeof c.order=="number"?c.order:0,type:c.type||"room"})}a.sort((s,c)=>s.order-c.order||s.name.localeCompare(c.name)),Me.set(t,a),document.dispatchEvent(new CustomEvent("subtags:updated",{detail:{parentId:t}})),n(a)})}):Promise.resolve([])}function La(){xe&&Mn(xe,re.get("location")||[]),Le&&Mn(Le,re.get("consultant")||[])}function Mn(t,n){const e=new Set(Array.from(t.selectedOptions||[]).map(o=>o.value));t.innerHTML="";for(const o of n){const a=document.createElement("option");a.value=o.id,a.textContent=o.name,t.appendChild(a)}for(const o of Array.from(t.options))e.has(o.value)&&(o.selected=!0)}function Ta(){const t=()=>{se&&!se.hidden&&de&&pe&&pe(de)},n=()=>{j.location=new Set(Array.from((xe==null?void 0:xe.selectedOptions)||[]).map(e=>e.value)),j.consultant=new Set(Array.from((Le==null?void 0:Le.selectedOptions)||[]).map(e=>e.value)),Ae(),t()};xe&&xe.addEventListener("change",n),Le&&Le.addEventListener("change",n),mt&&mt.addEventListener("change",()=>{me=mt.value||"none",Ae(),t()}),ln&&ln.addEventListener("click",()=>{var e,o;j.location.clear(),j.consultant.clear(),(o=(e=j.room)==null?void 0:e.clear)==null||o.call(e),xe&&Array.from(xe.options).forEach(a=>a.selected=!1),Le&&Array.from(Le.options).forEach(a=>a.selected=!1),mt&&(mt.value="none"),me="none",Ae(),t()})}function Na(t){for(const n of["location","consultant","room"]){const e=j[n];if(e&&e.size){const o=t&&t[n];if(!o||!e.has(o))return!1}}return!0}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggle-all-tasks");if(!t)return;const n=()=>{document.querySelectorAll(".case-tasks-wrap").forEach(a=>{a.hidden=vt}),document.querySelectorAll(".case-tasks-toggle").forEach(a=>{a instanceof HTMLElement&&(a.id==="toggle-all-tasks"||a.id==="toggle-all-comments"||(a.textContent=vt?"Show tasks":"Hide tasks"))}),t.textContent=vt?"Expand all":"Collapse all"};t.addEventListener("click",()=>{vt=!vt,n()}),n()});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("toggle-all-comments");if(!t)return;const n=()=>{document.querySelectorAll(".case-mini-comments").forEach(o=>{o instanceof HTMLElement&&(o.hidden=Rt)}),t.textContent=Rt?"Show comments":"Hide comments"};t.addEventListener("click",()=>{Rt=!Rt,n()}),n()});function Ia(t){const n=ge(ae(I,"cases",t,"tasks"),Ne("createdAt","desc"));Ce&&Ce();let e=null;Ce=Ie(n,async o=>{wt.innerHTML="";const a=[];for(const c of o.docs){const d=c.data();try{const h=await ce(d.textCipher,d.textIv),l=await ce(d.statusCipher,d.statusIv),m=d.createdAt&&d.createdAt.toMillis?d.createdAt.toMillis():0;a.push({docSnap:c,data:d,text:h,status:l,createdAt:m})}catch(h){console.error("Skipping undecryptable task",h)}}if(e)for(const c of a){const d=c.docSnap.id;e.includes(d)||e.unshift(d)}else{const c=h=>h==="open"?0:h==="in progress"?1:2;e=[...a].sort((h,l)=>{const m=c(h.status)-c(l.status);return m!==0?m:l.createdAt-h.createdAt}).map(h=>h.docSnap.id)}const s=new Map(e.map((c,d)=>[c,d]));a.sort((c,d)=>(s.get(c.docSnap.id)??999999)-(s.get(d.docSnap.id)??999999)),Qn=e.slice(),Zn=a.map(({docSnap:c,data:d,text:h,status:l,createdAt:m})=>({caseId:t,id:c.id,text:h,status:l,data:d,createdAt:m})),je()})}function Nt(t,n,e,o){const a=ge(ae(I,"cases",t,"tasks",n,"comments"),Ne("createdAt","asc"));Ie(a,async s=>{o&&o(s.size),e.innerHTML="";for(const c of s.docs){const{cipher:d,iv:h,username:l}=c.data();try{const m=await ce(d,h),r=document.createElement("li"),i=document.createElement("span");i.textContent=l?`${l}: ${m}`:m,r.appendChild(i);const f=document.createElement("div");f.className="case-actions";const u=document.createElement("button");u.className="icon-btn",u.textContent="‚úèÔ∏è",u.setAttribute("aria-label","Edit comment"),u.addEventListener("click",async()=>{const E=(prompt("Edit comment",m)||"").trim();if(!E)return;const{cipher:y,iv:D}=await ne(E);await oe(X(I,"cases",t,"tasks",n,"comments",c.id),{cipher:y,iv:D}),Y("Comment updated")}),f.appendChild(u);const p=document.createElement("button");p.className="icon-btn delete-btn",p.textContent="üóë",p.setAttribute("aria-label","Delete comment"),p.addEventListener("click",async()=>{confirm("Delete this comment?")&&(await Te(X(I,"cases",t,"tasks",n,"comments",c.id)),Y("Comment deleted"))}),f.appendChild(p),r.appendChild(f),e.appendChild(r)}catch(m){console.error("Skipping undecryptable comment",m)}}},s=>console.error("Comments listener error",s))}async function Ge(t={}){try{const n={type:t.type,caseId:t.caseId||le||"",username:ie,createdAt:We()};let e=t.caseTitle||(typeof Je<"u"&&Je&&Je.textContent?Je.textContent:"Case");try{e=(e||"").trim()}catch{}const{cipher:o,iv:a}=await ne(e||"Case"),s={...n,caseTitleCipher:o,caseTitleIv:a},c=["taskId","taskTextCipher","taskTextIv","assignee","priority","commentCipher","commentIv","noteSection","noteTitleCipher","noteTitleIv"];for(const d of c)t[d]!==void 0&&(s[d]=t[d]);await Fe(ae(I,"updates"),s)}catch(n){console.error("Failed to log update",n)}}function Sa(t){var n;try{if(!t)return"";const e=t.toDate?t.toDate():t;return((n=e.toLocaleString)==null?void 0:n.call(e))||String(e)}catch{return""}}function Aa(t){try{const n=t.toDate?t.toDate():t,e=Date.now()-n.getTime(),o=Math.floor(e/1e3);if(o<60)return`${o}s ago`;const a=Math.floor(o/60);if(a<60)return`${a}m ago`;const s=Math.floor(a/60);return s<24?`${s}h ago`:`${Math.floor(s/24)}d ago`}catch{return""}}function Ba(t){try{const n=t.toDate?t.toDate():t;return n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0")}catch{return""}}function Ma(t){var n;try{const e=t.toDate?t.toDate():t,o=new Date,a=new Date;a.setDate(o.getDate()-1);const s=(c,d)=>c.getFullYear()===d.getFullYear()&&c.getMonth()===d.getMonth()&&c.getDate()===d.getDate();return s(e,o)?"Today":s(e,a)?"Yesterday":((n=e.toLocaleDateString)==null?void 0:n.call(e,void 0,{weekday:"short",month:"short",day:"numeric"}))||e.toDateString()}catch{return""}}function Fa(t){const n=document.createElement("li");n.className="update-item",t.createdAtMs&&St&&t.createdAtMs>St&&n.classList.add("new");const e=document.createElement("div");e.className="update-icon",e.textContent=t.icon||"‚Ä¢";const o=document.createElement("div");o.className="update-content";const a=document.createElement("div");a.className="update-line";const s=document.createElement("span");s.className="who",s.textContent=t.username||"Someone";const c=document.createElement("a");c.href="#",c.className="link",c.style.textDecoration="none",c.style.color="inherit";let d="";t.type==="task_added"?d=` added ${t.taskText||"a task"} to `:t.type==="task_completed"?d=` marked ${t.taskText||"a task"} as complete in `:t.type==="comment_added"?d=" commented in ":t.type==="note_added"&&(d=` added a note to section ${t.noteSection||""} in `);const h=document.createElement("span");h.className="chip",h.textContent=t.caseTitle||"Case";const l=document.createDocumentFragment();if(l.appendChild(s),l.appendChild(document.createTextNode(d)),l.appendChild(h),t.type==="comment_added"&&t.comment){const r=document.createElement("span");r.className="chip",r.textContent=t.comment,r.style.maxWidth="220px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",l.appendChild(document.createTextNode(" ")),l.appendChild(r)}if((t.type==="task_added"||t.type==="task_completed")&&t.taskText){const r=document.createElement("span");r.className="chip",r.textContent=t.taskText,r.style.maxWidth="220px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.whiteSpace="nowrap",l.appendChild(document.createTextNode(" ")),l.appendChild(r)}a.appendChild(l),c.appendChild(a),c.addEventListener("click",r=>{r.preventDefault();const i=t.caseId;if(i){try{pt("table")}catch{}t.taskId&&(ut=t.taskId),At(i,t.caseTitle||"Case","updates","tasks")}}),o.appendChild(c);const m=document.createElement("div");return m.className="update-meta",m.title=t.createdAt?Sa(t.createdAt):"",m.textContent=t.createdAt?Aa(t.createdAt):"",n.appendChild(e),n.appendChild(o),n.appendChild(m),n}function Xe(){if(!dt)return;dt.innerHTML="";const t=It.filter(e=>!(!Wt.has(e.type)||Kt&&(e.username||"")!==Kt||zt&&!`${e.username||""} ${e.caseTitle||""} ${e.taskText||""} ${e.comment||""}`.toLowerCase().includes(zt.toLowerCase())));if(t.length===0){const e=document.createElement("div");e.className="update-empty",e.textContent="No updates yet.",dt.appendChild(e);return}let n="";for(const e of t){const o=e.createdAt?Ba(e.createdAt):"";if(o&&o!==n){n=o;const a=document.createElement("div");a.className="update-group",a.textContent=Ma(e.createdAt),dt.appendChild(a)}dt.appendChild(Fa(e))}}function Da(){try{const t=ge(ae(I,"updates"),Ne("createdAt","desc"),Rn(100));if(Ee)try{Ee()}catch{}Ee=Ie(t,async n=>{var e;It=[],dn.clear();for(const o of n.docs){const a=o.data(),s={id:o.id,type:a.type,username:a.username||"",caseId:a.caseId||"",taskId:a.taskId||"",createdAt:a.createdAt||null,createdAtMs:(e=a.createdAt)!=null&&e.toMillis?a.createdAt.toMillis():null};try{a.caseTitleCipher&&a.caseTitleIv&&(s.caseTitle=await ce(a.caseTitleCipher,a.caseTitleIv))}catch{}if(s.type==="task_added"||s.type==="task_completed")try{a.taskTextCipher&&a.taskTextIv&&(s.taskText=await ce(a.taskTextCipher,a.taskTextIv))}catch{}else if(s.type==="comment_added")try{a.commentCipher&&a.commentIv&&(s.comment=await ce(a.commentCipher,a.commentIv))}catch{}else if(s.type==="note_added"){s.noteSection=a.noteSection||"";try{a.noteTitleCipher&&a.noteTitleIv&&(s.noteTitle=await ce(a.noteTitleCipher,a.noteTitleIv))}catch{}}s.icon=s.type==="task_added"?"‚ûï":s.type==="task_completed"?"‚òë":s.type==="comment_added"?"üí¨":s.type==="note_added"?"üìù":"‚Ä¢",It.push(s),dn.set(o.id,s)}if(Ot=n.docs[n.docs.length-1]||null,Pe){const o=Pe.value;Pe.innerHTML='<option value="">All users</option>'+(Ve||[]).map(a=>`<option value="${a.username}">${a.username}</option>`).join(""),Pe.value=o||""}Xe()},n=>console.error("Updates listener error",n))}catch(t){console.error("Failed to start updates listener",t)}}async function Pa(){var t;if(Ot)try{const n=ge(ae(I,"updates"),Ne("createdAt","desc"),startAfter(Ot),Rn(100)),e=await ht(n),o=[];for(const a of e.docs){const s=a.data(),c={id:a.id,type:s.type,username:s.username||"",caseId:s.caseId||"",taskId:s.taskId||"",createdAt:s.createdAt||null,createdAtMs:(t=s.createdAt)!=null&&t.toMillis?s.createdAt.toMillis():null};try{s.caseTitleCipher&&s.caseTitleIv&&(c.caseTitle=await ce(s.caseTitleCipher,s.caseTitleIv))}catch{}if(c.type==="task_added"||c.type==="task_completed")try{s.taskTextCipher&&s.taskTextIv&&(c.taskText=await ce(s.taskTextCipher,s.taskTextIv))}catch{}else if(c.type==="comment_added")try{s.commentCipher&&s.commentIv&&(c.comment=await ce(s.commentCipher,s.commentIv))}catch{}else if(c.type==="note_added"){c.noteSection=s.noteSection||"";try{s.noteTitleCipher&&s.noteTitleIv&&(c.noteTitle=await ce(s.noteTitleCipher,s.noteTitleIv))}catch{}}c.icon=c.type==="task_added"?"‚ûï":c.type==="task_completed"?"‚òë":c.type==="comment_added"?"üí¨":c.type==="note_added"?"üìù":"‚Ä¢",o.push(c),dn.set(a.id,c)}Ot=e.docs[e.docs.length-1]||null,It=It.concat(o),Xe()}catch(n){console.error("Failed to load more updates",n)}}function Gt(t){return{c:`col${t}Cipher`,iv:`col${t}Iv`}}function aa(t){return{c:`col${t}BodyCipher`,iv:`col${t}BodyIv`}}async function $a(t,n,e){const{c:o,iv:a}=Gt(n),s=(e||"").trim();if(t)try{if(!s)await oe(X(I,"cases",t),{[o]:null,[a]:null});else{const c=await ne(s);await oe(X(I,"cases",t),{[o]:c.cipher,[a]:c.iv})}}catch(c){console.error("Failed to save column",n,c),Y("Failed to save")}}async function Ra(t,n,e){const{c:o,iv:a}=aa(n),s=(e||"").trim();if(t)try{if(!s)await oe(X(I,"cases",t),{[o]:null,[a]:null});else{const c=await ne(s);await oe(X(I,"cases",t),{[o]:c.cipher,[a]:c.iv})}}catch(c){console.error("Failed to save body column",n,c),Y("Failed to save")}}function oa(t){return`col${t}Items`}function kt(t="",n=""){return{id:Math.random().toString(36).slice(2,10),title:t,body:n,order:Date.now()}}async function sa(t,n){const e=t[oa(n)]||null;if(Array.isArray(e)&&e.length){const s=[];for(const c of e){let d="",h="";try{c.titleCipher&&c.titleIv&&(d=await ce(c.titleCipher,c.titleIv))}catch{}try{c.bodyCipher&&c.bodyIv&&(h=await ce(c.bodyCipher,c.bodyIv))}catch{}s.push({id:c.id||Math.random().toString(36).slice(2,10),title:d,body:h,order:c.order||0})}return s.sort((c,d)=>(c.order||0)-(d.order||0)),s}let o="",a="";try{const{c:s,iv:c}=Gt(n);t[s]&&t[c]&&(o=await ce(t[s],t[c]))}catch{}try{const{c:s,iv:c}=aa(n);t[s]&&t[c]&&(a=await ce(t[s],t[c]))}catch{}return o||a?[{id:"legacy",title:o,body:a,order:0}]:[]}async function Ha(t){const n=[];for(const e of t){const{cipher:o,iv:a}=await ne((e.title||"").trim()),{cipher:s,iv:c}=await ne((e.body||"").trim());n.push({id:e.id,titleCipher:o,titleIv:a,bodyCipher:s,bodyIv:c,order:e.order||0})}return n}async function ca(t,n,e){const o=oa(n),a=await Ha(e),s=e[0]&&(e[0].title||"").trim()||"",c=s?await ne(s):null,d={[o]:a};if(c){const{c:h,iv:l}=Gt(n);d[h]=c.cipher,d[l]=c.iv}else{const{c:h,iv:l}=Gt(n);d[h]=null,d[l]=null}await oe(X(I,"cases",t),d)}function qa(){if(!$e)return{table:null,tbody:null};const t=document.createElement("table");t.className="data-table";const n=document.createElement("thead"),e=document.createElement("tr"),o=["Patient","Diagnosis","History","Micro/ABx","Investigations","Updates","Tasks"];for(const s of o){const c=document.createElement("th");c.textContent=s,e.appendChild(c)}n.appendChild(e);const a=document.createElement("tbody");return t.appendChild(n),t.appendChild(a),{table:t,tbody:a}}function _a(){const t=ge(ae(I,"cases"),Ne("createdAt","desc"));pe=async n=>{const e=document.activeElement;if(e&&e.classList&&(e.classList.contains("cell-editable")||e.classList.contains("cell-title")))return;const{table:o,tbody:a}=qa();if(!o||!a||!$e)return;let s=n;if(me&&me!=="none"){const l=[];for(const m of s){const i=m.data().caseTags||{};let f=999999;if(me==="location"){const p=(re.get("location")||[]).findIndex(w=>w.id===i.location);f=p===-1?999999:p}else if(me==="consultant"){const p=(re.get("consultant")||[]).findIndex(w=>w.id===i.consultant);f=p===-1?999999:p}else if(me==="room"){const p=(Me.get(i.location)||[]).findIndex(w=>w.id===i.room);f=p===-1?999999:p}l.push({d:m,score:f,title:""})}for(const m of l)try{const r=m.d.data();m.title=await ce(r.titleCipher,r.titleIv)}catch{}l.sort((m,r)=>m.score-r.score||m.title.localeCompare(r.title)),He==="desc"&&l.reverse(),s=l.map(m=>m.d)}for(const l of s){const m=l.data();let r="";try{r=await ce(m.titleCipher,m.titleIv)}catch{}if(!r||!r.trim())continue;const i=document.createElement("tr"),f=document.createElement("td"),u=document.createElement("div");u.className="name-cell";const p=document.createElement("div");p.className="name-row";const w=document.createElement("button");w.className="patient-link",w.textContent=r,w.addEventListener("click",()=>{Jn=window.scrollY,At(l.id,r,"table","notes")}),p.appendChild(w);const E=document.createElement("button");E.type="button",E.className="edit-tags-btn",E.textContent="Tags",E.addEventListener("click",O=>{O.stopPropagation(),En(l.id,f)}),p.appendChild(E);const y=document.createElement("button");y.type="button",y.className="icon-btn delete-btn",y.textContent="üóë",y.title="Delete case",y.addEventListener("click",async O=>{if(O.stopPropagation(),!!confirm("Delete this case and all its items?"))try{if(await la(l.id),le===l.id){if(Ce){try{Ce()}catch{}Ce=null}if(ke){try{ke()}catch{}ke=null}if(he){try{he()}catch{}he=null}le=null,ve.hidden=!0,se&&(se.hidden=!1)}Y("Case deleted")}catch(M){console.error("Failed to delete case",M),Y("Failed to delete case")}}),p.appendChild(y),u.appendChild(p);const D=document.createElement("div");D.className="tag-chips";const F=m.caseTags||{},S=(O,M,L)=>{if(!L)return;const q=M==="room"?Me.get(F.location)||[]:re.get(M)||[],_=q.findIndex(W=>W.id===L);if(_===-1)return;const B=q[_],A=document.createElement("span");A.className="tag-chip",A.setAttribute("role","button"),A.setAttribute("tabindex","0");const H=document.createElement("span");H.className="tag-order",H.textContent=String(_+1)+".",A.appendChild(H);const Z=document.createElement("span");if(Z.textContent=B.name,A.appendChild(Z),M==="location"){A.title="Edit tags";const W=()=>{En(l.id,f)};A.addEventListener("click",x=>{x.stopPropagation(),W()}),A.addEventListener("keydown",x=>{(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),W())})}else{A.title=`Filter by ${O}`;const W=()=>{const x=j[M];x.has(L)?x.delete(L):x.add(L),A.classList.toggle("active",x.has(L)),Ae(),de&&pe&&pe(de);const U=new CustomEvent("filters:updated");document.dispatchEvent(U)};try{const x=j[M];A.classList.toggle("active",x&&x.has(L))}catch{}A.addEventListener("click",x=>{x.stopPropagation(),W()}),A.addEventListener("keydown",x=>{(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),W())})}D.appendChild(A)};S("Location","location",F.location||null),F.room&&F.location&&S("Room","room",F.room),S("Consultant","consultant",F.consultant||null),u.appendChild(D),f.appendChild(u),i.appendChild(f);for(const O of["A","B","C","D","E","F"]){const M=document.createElement("td");if(O==="F"){const L=document.createElement("div");L.className="cell-tasks";const q=document.createElement("ul");L.appendChild(q);const _=document.createElement("form");_.className="composer compact";const B=document.createElement("input");if(B.placeholder="Add task‚Ä¶",B.setAttribute("aria-label","Task description"),_.appendChild(B),_.addEventListener("submit",async H=>{H.preventDefault();const Z=(B.value||"").trim();if(!Z)return;const{cipher:W,iv:x}=await ne(Z),{cipher:U,iv:$}=await ne("open"),k=await Fe(ae(I,"cases",l.id,"tasks"),{textCipher:W,textIv:x,statusCipher:U,statusIv:$,createdAt:We(),username:ie||null,assignee:null,priority:null});try{await Ge({type:"task_added",caseId:l.id,caseTitle:r,taskId:k.id,taskTextCipher:W,taskTextIv:x})}catch{}B.value=""}),M.appendChild(L),M.appendChild(_),ct.has(l.id)){try{ct.get(l.id)()}catch{}ct.delete(l.id)}const A=Oa(l.id,q);ct.set(l.id,A)}else{const L=document.createElement("div");L.className="cell-items";const q=await sa(m,O),_=8,B=`${l.id}:${O}`;window._cellExpand||(window._cellExpand=new Set);const A=window._cellExpand.has(B),H=async()=>{try{await ca(l.id,O,q)}catch(k){console.error("save",k),Y("Failed to save")}};let Z=null;const W=()=>{clearTimeout(Z),Z=setTimeout(H,500)},x=k=>{if(L.innerHTML="",!q.length){const g=document.createElement("div");g.className="cell-line";const P=document.createElement("div");P.className="cell-bullet",g.appendChild(P);const v=document.createElement("div");v.className="cell-title",v.setAttribute("contenteditable","true"),v.dataset.placeholder="Add header‚Ä¶",v.addEventListener("input",()=>{const b=(v.textContent||"").trim();b.length>0&&q.length===0&&(q.push(kt(b,"")),window._cellExpand.add(B),x(!0),W(),setTimeout(()=>{const T=L.querySelector(".cell-title");T&&T.focus()},0))}),v.addEventListener("keydown",b=>{if(b.key==="Enter"&&!(b.ctrlKey||b.metaKey||b.shiftKey)){b.preventDefault();const T=(v.textContent||"").trim();if(!T)return;q.splice(0,0,kt(T,"")),q.splice(1,0,kt("","")),window._cellExpand.add(B),x(!0),W(),setTimeout(()=>{const C=L.querySelectorAll(".cell-title")[1];C&&C.focus()},0)}else if(b.key==="Enter"&&(b.ctrlKey||b.metaKey)){b.preventDefault();const T=M.cellIndex,C=i.nextElementSibling;if(C&&C.children[T]){const N=C.children[T].querySelector(".cell-title, .cell-editable");N&&N.focus()}}else if(b.key==="Tab"){b.preventDefault();const T=b.shiftKey?-1:1;let N=M.cellIndex+T,R=i;if(N<1){const V=i.previousElementSibling;if(V)R=V,N=6;else return}else if(N>6){const V=i.nextElementSibling;if(V)R=V,N=1;else return}const G=R.children[N];if(G){const V=G.querySelector(".cell-title, .cell-editable");V&&V.focus()}}}),g.appendChild(v),L.appendChild(g);return}const K=k?Math.min(q.length,_):Math.min(q.length,3);for(let g=0;g<K;g++){const P=q[g],v=document.createElement("div");v.className="cell-line";const b=document.createElement("div");b.className="cell-bullet",v.appendChild(b);const T=document.createElement("div");if(T.className="cell-title",T.setAttribute("contenteditable","true"),T.textContent=P.title||"",T.addEventListener("keydown",C=>{const N=window.getSelection(),R=N&&N.anchorOffset===0&&N.anchorNode&&(N.anchorNode===T||N.anchorNode.parentElement===T),G=!T.textContent||T.textContent.replace(/\u200B/g,"").trim()==="";if(C.key==="Enter"&&!(C.ctrlKey||C.metaKey||C.shiftKey)){if(C.preventDefault(),q.length>=_){Y("Limit 8 items");return}const V=kt("","");q.splice(g+1,0,V),window._cellExpand.add(B),x(!0),W(),setTimeout(()=>{const ee=L.querySelectorAll(".cell-title")[g+1];if(ee){ee.focus();try{const z=window.getSelection(),J=document.createRange();J.selectNodeContents(ee),J.collapse(!0),z.removeAllRanges(),z.addRange(J)}catch{}}},0)}else if(C.key==="Backspace"&&g>0&&G)C.preventDefault(),q.splice(g,1),x(k),W(),setTimeout(()=>{const V=L.querySelectorAll(".cell-title")[g-1];if(V){V.focus();try{const ee=window.getSelection(),z=document.createRange();z.selectNodeContents(V),z.collapse(!1),ee.removeAllRanges(),ee.addRange(z)}catch{}}},0);else if(C.key==="Backspace"&&R&&g>0){C.preventDefault();const V=q[g-1],ee=q[g];V.title=(V.title||"")+(ee.title||""),q.splice(g,1),x(k),W(),setTimeout(()=>{const z=L.querySelectorAll(".cell-title")[g-1];if(z){z.focus();try{const J=window.getSelection(),te=document.createRange();te.selectNodeContents(z),te.collapse(!1),J.removeAllRanges(),J.addRange(te)}catch{}}},0)}else if(C.key==="Tab"){C.preventDefault();const V=C.shiftKey?-1:1;let z=M.cellIndex+V,J=i;if(z<1){const Q=i.previousElementSibling;if(Q)J=Q,z=6;else return}else if(z>6){const Q=i.nextElementSibling;if(Q)J=Q,z=1;else return}const te=J.children[z];if(te){const Q=te.querySelector(".cell-title, .cell-editable");Q&&Q.focus()}}else if(C.key==="Enter"&&(C.ctrlKey||C.metaKey)){C.preventDefault();const V=M.cellIndex,ee=i.nextElementSibling;if(ee&&ee.children[V]){const z=ee.children[V].querySelector(".cell-title, .cell-editable");z&&z.focus()}}}),T.addEventListener("input",()=>{P.title=T.textContent||"",W()}),v.appendChild(T),(P.body||"").trim().length>0){const C=document.createElement("button");C.type="button",C.className="line-info-btn",C.textContent="‚Ä∫",C.title="Show details";let N=null,R=!1,G=!1,V=!1;const ee=()=>{N&&(N.remove(),N=null),R=!1,document.removeEventListener("click",z,!0)},z=te=>{N&&!N.contains(te.target)&&te.target!==C&&ee()},J=()=>{if(N)return;N=document.createElement("div"),N.className="cell-body-panel";const te=document.createElement("div");te.className="cell-body-text",te.textContent=P.body||"",N.appendChild(te),document.body.appendChild(N);const Q=C.getBoundingClientRect();requestAnimationFrame(()=>{const fe=N.offsetWidth||240,nt=N.offsetHeight||120,Ke=Math.min(Math.max(8,Q.right-fe),window.innerWidth-fe-8),Bt=Math.min(window.innerHeight-nt-8,Q.bottom+6);N.style.left=`${Math.round(Ke)}px`,N.style.top=`${Math.round(Bt)}px`}),N.addEventListener("mouseenter",()=>{V=!0}),N.addEventListener("mouseleave",()=>{V=!1,!R&&!G&&setTimeout(()=>{!R&&!G&&N&&ee()},120)})};C.addEventListener("mouseenter",()=>{G=!0,R||J()}),C.addEventListener("mouseleave",()=>{G=!1,!R&&!V&&setTimeout(()=>{!R&&!G&&N&&ee()},120)}),C.addEventListener("click",te=>{te.stopPropagation(),N||J(),R?ee():(R=!0,document.addEventListener("click",z,!0))}),v.appendChild(C)}L.appendChild(v)}if(!k&&q.length>3){const g=document.createElement("div");g.className="cell-more",g.textContent=`+${q.length-3}`,g.addEventListener("click",()=>{window._cellExpand.add(B),x(!0)}),L.appendChild(g)}if(k&&q.length>3){const g=document.createElement("div");g.className="cell-collapse",g.textContent="Collapse",g.addEventListener("click",()=>{window._cellExpand.delete(B),x(!1)}),L.appendChild(g)}};x(A);const U=`col${O}Color`,$=m[U]||null;if($&&(M.style.background=$),ft){const k=document.createElement("button");k.type="button",k.className="cell-color-btn",k.title="Cell color",k.addEventListener("click",K=>{K.stopPropagation();const g=document.querySelector(".color-panel");g&&g.remove();const P=document.createElement("div");P.className="color-panel";const v=document.createElement("div");v.className="color-swatch none",v.title="None",v.addEventListener("click",async C=>{C.stopPropagation();try{const N={};N[U]=null,await oe(X(I,"cases",l.id),N),M.style.background=""}catch(N){console.error("Failed to clear color",N),Y("Failed to update color")}P.remove()}),P.appendChild(v);for(const C of Ea){const N=document.createElement("div");N.className="color-swatch",N.style.background=C,N.title=C,N.addEventListener("click",async R=>{R.stopPropagation();try{const G={};G[U]=C,await oe(X(I,"cases",l.id),G),M.style.background=C}catch(G){console.error("Failed to set color",G),Y("Failed to update color")}P.remove()}),P.appendChild(N)}document.body.appendChild(P);const b=k.getBoundingClientRect();requestAnimationFrame(()=>{const C=P.offsetWidth||180,N=P.offsetHeight||120,R=Math.min(Math.max(8,b.right-C),window.innerWidth-C-8),G=Math.min(window.innerHeight-N-8,b.bottom+6);P.style.left=`${Math.round(R)}px`,P.style.top=`${Math.round(G)}px`});const T=C=>{!P.contains(C.target)&&C.target!==k&&(P.remove(),document.removeEventListener("click",T,!0))};setTimeout(()=>document.addEventListener("click",T,!0),0)}),M.appendChild(k)}M.appendChild(L)}i.appendChild(M)}Na(m.caseTags||{})&&a.appendChild(i)}$e.innerHTML="",$e.appendChild(o);const c=document.createElement("div");c.className="new-case-footer";const d=document.createElement("button");d.type="button",d.className="btn primary",d.textContent="‚ûï New Case",d.addEventListener("click",ta),c.appendChild(d),$e.appendChild(c);const h=new Set(n.map(l=>l.id));for(const[l,m]of Array.from(ct.entries()))if(!h.has(l)){try{m()}catch{}ct.delete(l)}},ze=Ie(t,n=>{de=n.docs,pe&&pe(de);try{document.dispatchEvent(new CustomEvent("filters:updated"))}catch{}},n=>console.error("Table listener error",n))}function Ua(){const t=document.getElementById("table-tags-controls");if(!t)return;t.innerHTML="";const n=document.createElement("div");n.className="left";const e=document.createElement("div");e.className="right",t.appendChild(n),t.appendChild(e);const o=document.createElement("div");o.className="filter-chips",n.appendChild(o);const a=document.createElement("span");a.className="section-label",a.textContent="Filters",n.appendChild(a);const s=document.createElement("div");s.className="pills-wrap",n.appendChild(s);const c=document.createElement("button");c.type="button",c.className="filter-pill",c.setAttribute("aria-haspopup","listbox"),c.setAttribute("aria-expanded","false"),c.textContent="Location";const d=document.createElement("span");d.className="count",d.textContent="",c.appendChild(d),s.appendChild(c);const h=document.createElement("button");h.type="button",h.className="filter-pill",h.setAttribute("aria-haspopup","listbox"),h.setAttribute("aria-expanded","false"),h.textContent="Room";const l=document.createElement("span");l.className="count",l.textContent="",h.appendChild(l),s.appendChild(h);const m=document.createElement("button");m.type="button",m.className="filter-pill",m.setAttribute("aria-haspopup","listbox"),m.setAttribute("aria-expanded","false"),m.textContent="Consultant";const r=document.createElement("span");r.className="count",r.textContent="",m.appendChild(r),s.appendChild(m);const i=document.createElement("button");i.type="button",i.className="mobile-filters-btn",i.textContent="Filters",e.appendChild(i);const f=document.createElement("span");f.className="section-label",f.textContent="Sort",e.appendChild(f);const u=document.createElement("div");u.className="segmented";const p=(g,P)=>{const v=document.createElement("button");return v.type="button",v.textContent=g,v.dataset.key=P,v.addEventListener("click",()=>{me=P,Ae(),Z(),de&&pe&&pe(de)}),v},w=p("None","none"),E=p("Location","location"),y=p("Room","room"),D=p("Consultant","consultant");u.appendChild(w);const F=document.createElement("div");F.className="sep",u.appendChild(F),u.appendChild(E);const S=document.createElement("div");S.className="sep",u.appendChild(S),u.appendChild(y);const O=document.createElement("div");O.className="sep",u.appendChild(O),u.appendChild(D);const M=document.createElement("button");M.type="button",M.className="sort-dir",M.textContent="‚Üë",M.title="Toggle sort direction",M.addEventListener("click",()=>{He=He==="asc"?"desc":"asc",M.textContent=He==="asc"?"‚Üë":"‚Üì",Ae(),de&&pe&&pe(de)});const L=document.createElement("button");L.type="button",L.className="icon-btn small",L.textContent="Clear",L.addEventListener("click",()=>{j.location.clear(),j.consultant.clear(),j.room.clear(),Ae(),k(),de&&pe&&pe(de)});const q=document.createElement("button");q.type="button",q.className="icon-btn small",q.textContent="Hide",q.addEventListener("click",()=>{Tt(!0)}),e.appendChild(u),e.appendChild(M),e.appendChild(L),e.appendChild(q);const _=document.createElement("label");_.className="ctrl",_.style.display="inline-flex",_.style.alignItems="center",_.style.gap="6px";const B=document.createElement("input");B.type="checkbox";const A=document.createElement("span");A.textContent="Cell colors",A.className="section-label";try{ft=(localStorage.getItem("table.showCellColor")??"1")!=="0"}catch{ft=!0}B.checked=!!ft,Bn(ft),B.addEventListener("change",()=>{Bn(B.checked)}),_.appendChild(B),_.appendChild(A),e.insertBefore(_,L);function H(){o.innerHTML="";const g=(v,b,T)=>{const C=document.createElement("span");C.className="filter-chip";const N=document.createElement("span");N.textContent=T,C.appendChild(N);const R=document.createElement("span");R.className="x",R.textContent="‚úï",R.setAttribute("role","button"),R.setAttribute("tabindex","0");const G=()=>{j[v].delete(b),Ae(),k(),de&&pe&&pe(de)};R.addEventListener("click",G),R.addEventListener("keydown",V=>{(V.key==="Enter"||V.key===" ")&&(V.preventDefault(),G())}),C.appendChild(R),o.appendChild(C)},P=(v,b)=>{for(const T of j[v]){const C=b.find(N=>N.id===T);C&&g(v,T,C.name)}};P("location",re.get("location")||[]),P("consultant",re.get("consultant")||[]);for(const v of j.room){let b="Room";for(const[T,C]of Me.entries()){const N=(C||[]).find(R=>R.id===v);if(N){b=N.name;break}}g("room",v,b)}}function Z(){[w,E,y,D].forEach(g=>g.classList.toggle("active",g.dataset.key===(me||"none"))),M.style.display=me&&me!=="none"?"":"none",M.textContent=He==="asc"?"‚Üë":"‚Üì"}let W=null;function x(g,P){const v=document.querySelector(".filter-popover");if(v&&W===g){v.remove(),g.setAttribute("aria-expanded","false"),W=null;return}U(g,P)}function U(g,P){if(g.getAttribute("aria-disabled")==="true")return;const v=document.querySelector(".filter-popover");v&&v.remove();const b=document.createElement("div");b.className="filter-popover",b.setAttribute("role","listbox");const T=document.createElement("input");T.className="search",T.type="search",T.placeholder="Search‚Ä¶",b.appendChild(T);const C=document.createElement("div");C.className="list",b.appendChild(C),document.body.appendChild(b);const N=g.getBoundingClientRect();requestAnimationFrame(()=>{const z=Math.min(window.innerWidth-b.offsetWidth-8,N.left),J=Math.min(window.innerHeight-b.offsetHeight-8,N.bottom+6);b.style.left=`${Math.max(8,z)}px`,b.style.top=`${Math.max(8,J)}px`});const R=j[P],G=[];if(P==="room"){const z=Array.from(j.location),J=z.length===1?z[0]:null,te=J?Me.get(J)||[]:[];for(const Q of te)G.push({id:Q.id,name:Q.name,count:$({room:Q.id})})}else{const z=re.get(P)||[];for(const J of z)G.push({id:J.id,name:J.name,count:$({[P]:J.id})})}const V=()=>{const z=(T.value||"").toLowerCase();C.innerHTML="";for(const J of G){if(z&&!J.name.toLowerCase().includes(z))continue;const te=document.createElement("div");te.className="opt",te.setAttribute("role","option"),te.setAttribute("aria-selected",String(R.has(J.id)));const Q=document.createElement("div");Q.className="label";const fe=document.createElement("input");fe.type="checkbox",fe.checked=R.has(J.id),Q.appendChild(fe);const nt=document.createElement("span");nt.textContent=J.name,Q.appendChild(nt);const Ke=document.createElement("div");Ke.className="opt-count",Ke.textContent=String(J.count),te.appendChild(Q),te.appendChild(Ke),te.addEventListener("click",()=>{R.has(J.id)?R.delete(J.id):R.add(J.id),te.setAttribute("aria-selected",String(R.has(J.id))),fe.checked=R.has(J.id),Ae(),k(),de&&pe&&pe(de)}),C.appendChild(te)}};V(),T.addEventListener("input",()=>{clearTimeout(T._t),T._t=setTimeout(V,120)});const ee=z=>{!b.contains(z.target)&&z.target!==g&&(b.remove(),document.removeEventListener("click",ee,!0),g.setAttribute("aria-expanded","false"),W=null)};setTimeout(()=>document.addEventListener("click",ee,!0),0),g.setAttribute("aria-expanded","true"),W=g,T.focus()}function $(g){if(!Array.isArray(de))return 0;let P=0;for(const v of de){const b=v.data().caseTags||{};let T=!0;for(const C in g)if(!b[C]||b[C]!==g[C]){T=!1;break}T&&P++}return P}function k(){d.textContent=j.location.size?` (${j.location.size})`:"",r.textContent=j.consultant.size?` (${j.consultant.size})`:"",l.textContent=j.room.size?` (${j.room.size})`:"";const g=j.location.size===1;h.setAttribute("aria-disabled",g?"false":"true"),H()}c.addEventListener("click",()=>x(c,"location")),m.addEventListener("click",()=>x(m,"consultant")),h.addEventListener("click",()=>x(h,"room")),Z(),k(),document.addEventListener("tags:updated",k),document.addEventListener("filters:updated",k);function K(){const g=document.createElement("div");g.className="sheet-overlay";const P=document.createElement("div");P.className="sheet",g.appendChild(P);const v=ue=>{const Se=document.createElement("div");Se.className="section";const De=document.createElement("h4");return De.textContent=ue,Se.appendChild(De),P.appendChild(Se),Se},b=v("Location"),T=v("Room"),C=v("Consultant"),N=v("Sort"),R=(ue,Se,De)=>{const Jt=document.createElement("div");Jt.className="list",ue.appendChild(Jt);for(const Ct of De){const Et=document.createElement("div");Et.className="opt";const Pt=document.createElement("label");Pt.className="label";const at=document.createElement("input");at.type="checkbox",at.checked=j[Se].has(Ct.id);const Sn=document.createElement("span");Sn.textContent=Ct.name,Pt.appendChild(at),Pt.appendChild(Sn);const Zt=document.createElement("div");Zt.className="opt-count",Zt.textContent=String(Ct.count),Et.appendChild(Pt),Et.appendChild(Zt),Et.addEventListener("click",()=>{at.checked=!at.checked,at.checked?j[Se].add(Ct.id):j[Se].delete(Ct.id)}),Jt.appendChild(Et)}},G=(re.get("location")||[]).map(ue=>({id:ue.id,name:ue.name,count:$({location:ue.id})}));R(b,"location",G);const V=Array.from(j.location),ee=V.length===1?V[0]:null,J=(ee?Me.get(ee)||[]:[]).map(ue=>({id:ue.id,name:ue.name,count:$({room:ue.id})}));R(T,"room",J);const te=(re.get("consultant")||[]).map(ue=>({id:ue.id,name:ue.name,count:$({consultant:ue.id})}));R(C,"consultant",te);const Q=document.createElement("div");Q.className="segmented";const fe=(ue,Se)=>{const De=document.createElement("button");return De.type="button",De.textContent=ue,De.classList.toggle("active",(me||"none")===Se),De.addEventListener("click",()=>{me=Se,nt()}),De},nt=()=>{Ae()};Q.appendChild(fe("None","none"));const Ke=document.createElement("div");Ke.className="sep",Q.appendChild(Ke),Q.appendChild(fe("Location","location"));const Bt=document.createElement("div");Bt.className="sep",Q.appendChild(Bt),Q.appendChild(fe("Room","room"));const In=document.createElement("div");In.className="sep",Q.appendChild(In),Q.appendChild(fe("Consultant","consultant")),N.appendChild(Q);const gt=document.createElement("div");gt.className="actions";const Mt=document.createElement("button");Mt.className="btn",Mt.textContent="Clear",Mt.addEventListener("click",()=>{j.location.clear(),j.room.clear(),j.consultant.clear()});const Ft=document.createElement("button");Ft.className="btn primary",Ft.textContent="Apply",Ft.addEventListener("click",()=>{Ae(),k(),de&&pe&&pe(de),g.remove()});const Dt=document.createElement("button");Dt.className="btn primary",Dt.textContent="New Case",Dt.addEventListener("click",()=>{g.remove(),ta()}),gt.appendChild(Mt),gt.appendChild(Ft),gt.appendChild(Dt),P.appendChild(gt),g.addEventListener("click",ue=>{ue.target===g&&g.remove()}),document.body.appendChild(g)}i.addEventListener("click",K)}function Oa(t,n,e={}){const o=ge(ae(I,"cases",t,"tasks"),Ne("createdAt","desc"));let a=null,s=!1,c=null;const d=r=>{if(n){n.innerHTML="";for(const i of r)n.appendChild(Wa(t,i,{...e,_onEditStart:h,_onEditEnd:l}))}},h=()=>{n.dataset.editing="1"},l=()=>{if(delete n.dataset.editing,s&&c){const r=c;c=null,s=!1,d(r)}},m=Ie(o,async r=>{if(!n)return;const i=[];for(const u of r.docs){const p=u.data();try{const w=await ce(p.textCipher,p.textIv),E=await ce(p.statusCipher,p.statusIv),y=p.createdAt&&p.createdAt.toMillis?p.createdAt.toMillis():0;i.push({id:u.id,text:w,status:E,data:p,createdAt:y})}catch{}}if(a)for(const u of i)a.includes(u.id)||a.unshift(u.id);else{const u=w=>w==="open"?0:w==="in progress"?1:2;a=[...i].sort((w,E)=>{const y=u(w.status)-u(E.status);return y!==0?y:E.createdAt-w.createdAt}).map(w=>w.id)}const f=new Map(a.map((u,p)=>[u,p]));if(i.sort((u,p)=>(f.get(u.id)??999999)-(f.get(p.id)??999999)),n.dataset.editing==="1"){c=i,s=!0;return}d(i)},r=>console.error("Tasks cell listener error",r));return()=>{try{m()}catch{}}}function Wa(t,n,e={}){const o=document.createElement("li"),a=n.status==="in progress"?"s-inprogress":n.status==="complete"?"s-complete":"s-open";o.className="case-task "+a;const s=document.createElement("button");s.type="button",s.className="status-btn";const c=i=>i==="complete"?"‚òë":i==="in progress"?"‚óê":"‚òê";s.textContent=c(n.status),s.setAttribute("aria-label",`Task status: ${n.status}`),s.addEventListener("click",async i=>{i.stopPropagation();const f=["open","in progress","complete"],u=f[(f.indexOf(n.status)+1)%f.length];try{const{cipher:p,iv:w}=await ne(u);if(await oe(X(I,"cases",t,"tasks",n.id),{statusCipher:p,statusIv:w}),n.status=u,s.textContent=c(u),s.setAttribute("aria-label",`Task status: ${u}`),o.className="case-task "+(u==="in progress"?"s-inprogress":u==="complete"?"s-complete":"s-open"),u==="complete")try{const E=await ne(n.text||"");await Ge({type:"task_completed",caseId:t,taskId:n.id,taskTextCipher:E.cipher,taskTextIv:E.iv})}catch{}}catch(p){console.error("Failed to update status",p),Y("Failed to update status")}});const d=document.createElement("span");if(d.className="task-text",d.textContent=n.text,d.addEventListener("click",i=>{i.stopPropagation(),typeof e._onEditStart=="function"&&e._onEditStart();const f=document.createElement("div");f.className="cell-editable",f.setAttribute("contenteditable","true"),f.style.minWidth="120px",f.textContent=n.text;let u=n.text;const p=async()=>{const y=(f.innerText||"").replace(/\r/g,"");if(y===u){w();return}try{const{cipher:D,iv:F}=await ne(y);await oe(X(I,"cases",t,"tasks",n.id),{textCipher:D,textIv:F}),u=y,n.text=y,d.textContent=y,E()}catch(D){console.error("Failed to update task text",D),Y("Failed to update task"),E()}},w=()=>{E()},E=()=>{try{f.remove()}catch{}d.style.display="",typeof e._onEditEnd=="function"&&e._onEditEnd()};f.addEventListener("paste",y=>{y.preventDefault();const D=(y.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,D);else{const F=window.getSelection();F&&F.rangeCount&&(F.deleteFromDocument(),F.getRangeAt(0).insertNode(document.createTextNode(D)))}}),f.addEventListener("keydown",y=>{y.key==="Enter"&&!(y.ctrlKey||y.metaKey)?(y.preventDefault(),p()):y.key==="Escape"&&(y.preventDefault(),w())}),f.addEventListener("blur",()=>{p()}),d.insertAdjacentElement("afterend",f),d.style.display="none",f.focus()}),o.appendChild(s),o.appendChild(d),n.data&&n.data.priority)if(e.compact){const i=document.createElement("span");i.style.fontSize="11px",i.style.color="#6b7280",i.title="Priority";const f=(n.data.priority||"").toLowerCase();i.textContent=f==="high"?"H":f==="medium"?"M":f==="low"?"L":"",i.textContent&&o.appendChild(i)}else{const i=document.createElement("span");i.className="mini-chip",i.textContent=n.data.priority,o.appendChild(i)}const h=document.createElement("span");h.className="mini-avatar";const l=n.data&&n.data.assignee?n.data.assignee.split(/\s+/).map(i=>i[0]).join("").slice(0,2).toUpperCase():"";h.textContent=l||"";const m=xn(n.data&&n.data.assignee||"");h.style.background=m.bg,h.style.color=m.color,h.style.border=`1px solid ${m.border}`,h.addEventListener("click",i=>{i.stopPropagation();const f=document.querySelector(".assignee-panel");f&&f.remove();const u=document.createElement("div");u.className="assignee-panel",u.style.position="fixed",u.style.zIndex="2147483646";const p=(y,D)=>{const F=document.createElement("button");F.type="button",F.className="assignee-option",F.textContent=y,F.addEventListener("click",async S=>{S.stopPropagation();try{await oe(X(I,"cases",t,"tasks",n.id),{assignee:D})}catch(O){console.error("Failed to reassign",O),Y("Failed to reassign")}finally{u.remove()}}),u.appendChild(F)};p("Unassigned",null);for(const y of Ve)p(y.username,y.username);document.body.appendChild(u);const w=h.getBoundingClientRect();requestAnimationFrame(()=>{const y=u.offsetWidth||160,D=Math.min(Math.max(8,w.right-y),window.innerWidth-y-8),F=Math.min(window.innerHeight-u.offsetHeight-8,w.bottom+6);u.style.left=`${Math.round(D)}px`,u.style.top=`${Math.round(F)}px`});const E=y=>{!u||u.contains(y.target)||y.target===h||(u.remove(),document.removeEventListener("click",E,!0))};setTimeout(()=>document.addEventListener("click",E,!0),0)});const r=document.createElement("button");return r.type="button",r.className="icon-btn delete-btn",r.textContent="üóë",r.title="Delete task",r.addEventListener("click",async i=>{if(i.stopPropagation(),!!confirm("Delete this task?"))try{await Te(X(I,"cases",t,"tasks",n.id))}catch(f){console.error("Failed to delete task",f),Y("Failed to delete task")}}),o.appendChild(h),o.appendChild(r),o}function En(t,n){const e=document.createElement("div");e.className="tag-panel";const o=document.createElement("h4");o.textContent="Edit tags",e.appendChild(o);const a=document.createElement("div");a.className="row",e.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.gap="6px";const c=document.createElement("select"),d=(S,O,M=!0)=>{if(S.innerHTML="",M){const L=document.createElement("option");L.value="",L.textContent="Unassigned",S.appendChild(L)}for(const L of O){const q=document.createElement("option");q.value=L.id,q.textContent=L.name,S.appendChild(q)}};d(c,re.get("location")||[]);const h=document.createElement("button");h.type="button",h.textContent="+",h.className="icon-btn small",h.title="Add ward",h.addEventListener("click",async()=>{await Xt("location")}),s.appendChild(c),s.appendChild(h),a.appendChild(s);const l=document.createElement("div");l.style.display="flex",l.style.gap="6px";const m=document.createElement("select");d(m,[],!0);const r=document.createElement("button");r.type="button",r.textContent="+",r.className="icon-btn small",r.title="Add room",r.addEventListener("click",async()=>{const S=c.value||"";if(!S){Y("Pick a ward first");return}await ra(S)}),l.appendChild(m),l.appendChild(r),a.appendChild(l);const i=document.createElement("div");i.style.display="flex",i.style.gap="6px";const f=document.createElement("select");d(f,re.get("consultant")||[]);const u=document.createElement("button");u.type="button",u.textContent="+",u.className="icon-btn small",u.title="Add consultant",u.addEventListener("click",async()=>{await Xt("consultant")}),i.appendChild(f),i.appendChild(u),a.appendChild(i);const p=document.createElement("div");p.className="actions",e.appendChild(p);const w=document.createElement("button");w.className="icon-btn small",w.textContent="Cancel",p.appendChild(w);const E=document.createElement("button");E.className="icon-btn small",E.textContent="Save",p.appendChild(E),(async()=>{const S=X(I,"cases",t),O=await $n(S),M=O.exists()&&O.data().caseTags||{};M.location?c.value=M.location:c.value="",await y(),M.room?m.value=M.room:m.value="",M.consultant?f.value=M.consultant:f.value=""})();async function y(){const S=c.value||null;if(S){const O=await Ln(S);d(m,O,!0)}else d(m,[],!0)}c.addEventListener("change",async()=>{await y(),m.value=""}),w.addEventListener("click",()=>{e.remove(),document.removeEventListener("click",F,!0)}),E.addEventListener("click",async()=>{try{const S=c.value||null,O=m.value||null,M=f.value||null,L={location:S,consultant:M};S&&O?L.room=O:L.room=null,await oe(X(I,"cases",t),{caseTags:L}),e.remove(),document.removeEventListener("click",F,!0)}catch(S){console.error("Failed to update tags",S),Y("Failed to update tags")}}),document.body.appendChild(e);const D=n.getBoundingClientRect();requestAnimationFrame(()=>{const S=Math.min(window.innerWidth-e.offsetWidth-8,D.left),O=Math.min(window.innerHeight-e.offsetHeight-8,D.bottom+6);e.style.left=`${Math.max(8,S)}px`,e.style.top=`${Math.max(8,O)}px`});const F=S=>{!e||e.contains(S.target)||(e.remove(),document.removeEventListener("click",F,!0))};setTimeout(()=>document.addEventListener("click",F,!0),0)}function Ka(){const t=[{el:_n,L:"A"},{el:Un,L:"B"},{el:On,L:"C"},{el:Wn,L:"D"},{el:Kn,L:"E"},{el:zn,L:"F"}];for(const{el:e,L:o}of t)e&&e.addEventListener("blur",()=>{le!=null&&$a(le,o,e.value)});const n=[{el:jn,L:"A"},{el:Vn,L:"B"},{el:Yn,L:"C"},{el:Gn,L:"D"},{el:Xn,L:"E"}];for(const{el:e,L:o}of n)e&&e.addEventListener("blur",()=>{le!=null&&Ra(le,o,e.value)})}function za(t){he&&(he(),he=null);const n=X(I,"cases",t);he=Ie(n,async e=>{if(!e.exists())return;const o=e.data();try{const s=document.getElementById("case-tag-chips");if(s){s.innerHTML="";const c=o.caseTags||{},d=(h,l)=>{if(!l)return;const r=(h==="room"?Me.get(c.location)||[]:re.get(h)||[]).find(p=>p.id===l);if(!r)return;const i=document.createElement("span");i.className="tag-chip",i.setAttribute("role","button"),i.setAttribute("tabindex","0");const f=document.createElement("span");f.textContent=r.name,i.appendChild(f);const u=()=>{En(t,Je||s)};i.addEventListener("click",p=>{p.stopPropagation(),u()}),i.addEventListener("keydown",p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),u())}),s.appendChild(i)};d("location",c.location||null),c.room&&c.location&&d("room",c.room),d("consultant",c.consultant||null)}}catch{}const a=[{L:"A",el:document.getElementById("notes-A-items")},{L:"B",el:document.getElementById("notes-B-items")},{L:"C",el:document.getElementById("notes-C-items")},{L:"D",el:document.getElementById("notes-D-items")},{L:"E",el:document.getElementById("notes-E-items")}];for(const s of a){const c=await sa(o,s.L);ja(s.el,s.L,c)}try{const s=(d,h)=>{if(!d)return;const l=`col${h}Color`,m=o[l]||null;d.style.background=m||""},c=(d,h)=>{const l=document.getElementById(d);if(!l)return;const m=`col${h}Color`,r=o[m]||null;l.querySelectorAll("input, textarea").forEach(i=>{i.style.background=r||""})};c("notes-A-items","A"),c("notes-B-items","B"),c("notes-C-items","C"),c("notes-D-items","D"),c("notes-E-items","E")}catch{}})}function ja(t,n,e){var m;if(!t)return;t.innerHTML="";const o=8,a=(m=t.parentElement)==null?void 0:m.querySelector('.add-note-item[data-letter="'+n+'"]'),s=e.length<o;a&&(a.disabled=!s,a.onclick=()=>{if(e.length>=o){Y("Limit reached");return}e.push(kt()),d();try{Ge({type:"note_added",caseId:le,noteSection:n})}catch{}c()});const c=()=>{t.innerHTML="",e.forEach((r,i)=>{const f=document.createElement("div");f.className="note-item",f.dataset.id=r.id;const u=document.createElement("input");u.type="text",u.className="note-item-header",u.placeholder="Header",u.value=r.title||"";const p=document.createElement("textarea");p.className="note-item-body",p.placeholder="Add details‚Ä¶",p.value=r.body||"";const w=document.createElement("div");w.className="note-actions";const E=document.createElement("button");E.type="button",E.className="icon-btn small",E.textContent="‚Üë",E.title="Move up",E.disabled=i===0;const y=document.createElement("button");y.type="button",y.className="icon-btn small",y.textContent="‚Üì",y.title="Move down",y.disabled=i===e.length-1;const D=document.createElement("button");D.type="button",D.className="icon-btn small delete-btn",D.textContent="üóë",D.title="Delete",w.appendChild(E),w.appendChild(y),w.appendChild(D),f.appendChild(u),f.appendChild(p),f.appendChild(w),t.appendChild(f),u.addEventListener("blur",()=>{r.title=u.value,l()}),p.addEventListener("blur",()=>{r.body=p.value,l()}),E.addEventListener("click",()=>{const F=e[i-1];e[i-1]=e[i],e[i]=F,d(),c()}),y.addEventListener("click",()=>{const F=e[i+1];e[i+1]=e[i],e[i]=F,d(),c()}),D.addEventListener("click",()=>{e.splice(i,1),d(),c()})})},d=async()=>{try{await ca(le,n,e)}catch(r){console.error("save items",r),Y("Failed to save")}a&&(a.disabled=e.length>=o)};let h=null;const l=()=>{clearTimeout(h),h=setTimeout(d,500)};c()}function Va(){Qe.addEventListener("click",()=>bn("tasks")),xt.addEventListener("click",()=>bn("notes"))}function Ya(){try{return window.matchMedia("(min-width: 900px)").matches}catch{return!1}}function vn(){const t=document.getElementById("tasks"),n=document.getElementById("notes");if(!(!t||!n))if(Ya())t.hidden=!1,n.hidden=!1;else{const e=Qe&&Qe.classList.contains("active");t.hidden=!e,n.hidden=e}}function bn(t){const n=t==="tasks";Qe&&(Qe.classList.toggle("active",n),Qe.setAttribute("aria-selected",String(n))),xt&&(xt.classList.toggle("active",!n),xt.setAttribute("aria-selected",String(!n))),vn()}function je(){if(un){pn=!0;return}if(!wt)return;const t=o=>o==="high"?3:o==="medium"?2:o==="low"?1:0;let n=Zn.filter(o=>{const a=o.data&&o.data.priority||"",s=!jt.size||jt.has(o.status),c=Vt==="all"||a===Vt,d=!Yt||o.text.toLowerCase().includes(Yt.toLowerCase());return s&&c&&d}),e;if(Lt==="pri-asc"||Lt==="pri-desc")e=[...n].sort((o,a)=>{const s=o.data&&o.data.priority||"",c=a.data&&a.data.priority||"";return Lt==="pri-asc"?t(s)-t(c):t(c)-t(s)});else{const o=new Map((Qn||[]).map((a,s)=>[a,s]));e=[...n].sort((a,s)=>(o.get(a.id)??999999)-(o.get(s.id)??999999))}wt.innerHTML="";for(const o of e){const a=ut&&o.id===ut;wt.appendChild(Ga(o,{openComments:a}))}if(ut){const o=document.getElementById("task-"+ut);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("flash-highlight"),setTimeout(()=>o.classList.remove("flash-highlight"),1400)),ut=null}}function Ga(t,n={}){const{caseId:e,id:o,text:a,status:s,data:c}=t,d=document.createElement("li"),h=s==="in progress"?"s-inprogress":s==="complete"?"s-complete":"s-open";d.className="case-task "+h,d.id="task-"+o;const l=document.createElement("button");l.type="button",l.className="status-btn";const m=B=>B==="complete"?"‚òë":B==="in progress"?"‚óê":"‚òê";l.textContent=m(s),l.setAttribute("aria-label",`Task status: ${s}`),l.addEventListener("click",async B=>{var Z;B.stopPropagation();const A=["open","in progress","complete"],H=A[(A.indexOf(((Z=l.getAttribute("aria-label"))==null?void 0:Z.split(": ")[1])||s)+1)%A.length];try{const{cipher:W,iv:x}=await ne(H);if(await oe(X(I,"cases",e,"tasks",o),{statusCipher:W,statusIv:x}),l.textContent=m(H),l.setAttribute("aria-label",`Task status: ${H}`),d.className="case-task "+(H==="in progress"?"s-inprogress":H==="complete"?"s-complete":"s-open"),H==="complete")try{const U=await ne(r.textContent||"");await Ge({type:"task_completed",caseId:e,taskId:o,taskTextCipher:U.cipher,taskTextIv:U.iv})}catch{}}catch(W){console.error("Failed to update status",W),Y("Failed to update status")}});const r=document.createElement("span");if(r.className="task-text",r.textContent=a,r.addEventListener("click",B=>{B.stopPropagation(),un=!0;const A=document.createElement("div");A.className="cell-editable",A.setAttribute("contenteditable","true"),A.textContent=a;let H=a;const Z=()=>{try{A.remove()}catch{}r.style.display="",un=!1,pn&&(pn=!1,je())},W=async()=>{const x=(A.innerText||"").replace(/\r/g,"");if(x===H){Z();return}try{const{cipher:U,iv:$}=await ne(x);await oe(X(I,"cases",e,"tasks",o),{textCipher:U,textIv:$}),H=x,r.textContent=x}catch(U){console.error("Failed to update task",U),Y("Failed to update task")}Z()};A.addEventListener("paste",x=>{x.preventDefault();const U=(x.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,U);else{const $=window.getSelection();$&&$.rangeCount&&($.deleteFromDocument(),$.getRangeAt(0).insertNode(document.createTextNode(U)))}}),A.addEventListener("keydown",x=>{x.key==="Enter"&&!(x.ctrlKey||x.metaKey)?(x.preventDefault(),W()):x.key==="Escape"&&(x.preventDefault(),Z())}),A.addEventListener("blur",()=>{W()}),r.insertAdjacentElement("afterend",A),r.style.display="none",A.focus()}),d.appendChild(l),d.appendChild(r),c.priority){const B=document.createElement("span");B.className="mini-chip",B.textContent=c.priority,d.appendChild(B)}const i=document.createElement("span");i.className="mini-avatar";const f=c.assignee?c.assignee.split(/\s+/).map(B=>B[0]).join("").slice(0,2).toUpperCase():"";i.textContent=f||"";const u=xn(c.assignee||"");i.style.background=u.bg,i.style.color=u.color,i.style.border=`1px solid ${u.border}`;let p=null;const w=()=>{p&&(p.remove(),p=null)};i.addEventListener("mouseenter",()=>{if(!c.assignee)return;p=document.createElement("div"),p.className="assignee-tip",p.textContent=c.assignee,p.style.position="fixed",p.style.zIndex="2147483647",document.body.appendChild(p);const B=i.getBoundingClientRect();requestAnimationFrame(()=>{const A=p.offsetHeight||24;p.style.left=`${Math.round(B.left+B.width/2)}px`,p.style.top=`${Math.round(B.top-6-A)}px`,p.style.transform="translateX(-50%)"})}),i.addEventListener("mouseleave",w),i.addEventListener("click",B=>{B.stopPropagation(),w();const A=document.querySelector(".assignee-panel");A&&A.remove();const H=document.createElement("div");H.className="assignee-panel",H.style.position="fixed",H.style.zIndex="2147483646";const Z=(U,$)=>{const k=document.createElement("button");k.type="button",k.className="assignee-option",k.textContent=U,k.addEventListener("click",async K=>{K.stopPropagation();try{await oe(X(I,"cases",e,"tasks",o),{assignee:$}),je()}catch(g){console.error("Failed to reassign",g),Y("Failed to reassign")}finally{H.remove()}}),H.appendChild(k)};Z("Unassigned",null);for(const U of Ve)Z(U.username,U.username);document.body.appendChild(H);const W=i.getBoundingClientRect();requestAnimationFrame(()=>{const U=H.offsetWidth||180,$=Math.min(Math.max(8,W.right-U),window.innerWidth-U-8),k=Math.min(window.innerHeight-H.offsetHeight-8,W.bottom+6);H.style.left=`${Math.round($)}px`,H.style.top=`${Math.round(k)}px`});const x=U=>{!H||H.contains(U.target)||U.target===i||(H.remove(),document.removeEventListener("click",x,!0))};setTimeout(()=>document.addEventListener("click",x,!0),0)}),d.appendChild(i);const E=document.createElement("button");E.type="button",E.className="icon-btn comment-toggle",E.setAttribute("aria-label","Show comments"),E.textContent="üí¨";const y=document.createElement("span");y.className="badge comment-count",d.appendChild(E),d.appendChild(y);const D=document.createElement("div");D.className="comment-section",D.hidden=!(n&&n.openComments);const F=document.createElement("ul");F.className="comments",D.appendChild(F);const S=document.createElement("form");S.className="comment-form";const O=document.createElement("input");O.placeholder="Add comment",S.appendChild(O);const M=document.createElement("button");M.className="icon-btn add-comment-btn",M.type="submit",M.textContent="‚ûï",M.setAttribute("aria-label","Add comment"),S.appendChild(M),D.appendChild(S);let L=!1,q=0;const _=()=>{y.textContent=q>0?String(q):"",E.setAttribute("aria-label",D.hidden?"Show comments":"Hide comments"),E.textContent=D.hidden?"üí¨":"‚úñ"};return _(),!D.hidden&&!L&&(Nt(e,o,F,B=>{q=B,_()}),L=!0),E.addEventListener("click",()=>{const B=D.hidden;D.hidden=!B,_(),B&&!L&&(Nt(e,o,F,A=>{q=A,_()}),L=!0)}),S.addEventListener("submit",async B=>{B.preventDefault();const A=O.value.trim();if(!A)return;const H=document.createElement("li");H.className="optimistic";const Z=document.createElement("span");Z.textContent=ie?`${ie}: ${A}`:A,H.appendChild(Z),F.appendChild(H),O.value="",D.hidden=!1,_();try{const{cipher:W,iv:x}=await ne(A);await Fe(ae(I,"cases",e,"tasks",o,"comments"),{cipher:W,iv:x,username:ie,createdAt:We()});try{await Ge({type:"comment_added",caseId:e,taskId:o,commentCipher:W,commentIv:x})}catch{}L||(Nt(e,o,F,U=>{q=U,_()}),L=!0)}catch{H.classList.add("failed"),Y("Failed to add comment")}}),d.appendChild(D),d}function Xa(){on&&on.addEventListener("submit",async t=>{t.preventDefault();const n=sn.value.trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),a=bt&&bt.value||null;await Fe(ae(I,"cases"),{titleCipher:e,titleIv:o,createdAt:We(),username:ie,location:a}),sn.value="",bt&&(bt.value="")})}function Ja(){ia(),document.getElementById("task-input")&&document.getElementById("composer-opts")&&document.getElementById("task-input").addEventListener("focus",()=>{document.getElementById("composer-opts").hidden=!1}),qn.addEventListener("submit",async t=>{if(t.preventDefault(),!le)return;const n=cn.value.trim(),e="open";if(!n)return;const{cipher:o,iv:a}=await ne(n),{cipher:s,iv:c}=await ne(e),d=document.getElementById("task-assignee"),h=document.getElementById("task-priority"),l=d&&d.value||null,m=h&&h.value||null,r=await Fe(ae(I,"cases",le,"tasks"),{textCipher:o,textIv:a,statusCipher:s,statusIv:c,createdAt:We(),username:ie,assignee:l,priority:m});try{await Ge({type:"task_added",caseId:le,taskId:r.id,taskTextCipher:o,taskTextIv:a,assignee:l,priority:m})}catch{}cn.value="",d&&(d.value=""),h&&(h.value="")})}function ia(){const t=document.getElementById("task-assignee");if(!t)return;const n=t.value;t.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="Unassigned",t.appendChild(e);for(const o of Ve){const a=document.createElement("option");a.value=o.username,a.textContent=o.username,t.appendChild(a)}t.value=n||""}window.addEventListener("DOMContentLoaded",async()=>{document.getElementById("case-list"),Be=document.getElementById("case-list-section"),on=document.getElementById("case-form"),sn=document.getElementById("case-input"),bt=document.getElementById("case-location"),ve=document.getElementById("case-detail"),Je=document.getElementById("case-title"),we=document.getElementById("updates-section"),dt=document.getElementById("updates-list"),document.getElementById("updates-toolbar"),ot=document.getElementById("updates-type-pills"),Pe=document.getElementById("updates-user-filter"),st=document.getElementById("updates-search"),Qt=document.getElementById("updates-mark-read"),en=document.getElementById("updates-clear"),tn=document.getElementById("updates-load-more"),An=document.getElementById("back-btn"),qn=document.getElementById("task-form"),cn=document.getElementById("task-input"),wt=document.getElementById("task-list"),document.getElementById("task-assignee"),document.getElementById("task-priority"),document.getElementById("composer-opts"),_n=document.getElementById("colA-input"),Un=document.getElementById("colB-input"),On=document.getElementById("colC-input"),Wn=document.getElementById("colD-input"),Kn=document.getElementById("colE-input"),zn=document.getElementById("colF-input"),jn=document.getElementById("colA-body"),Vn=document.getElementById("colB-body"),Yn=document.getElementById("colC-body"),Gn=document.getElementById("colD-body"),Xn=document.getElementById("colE-body"),Qe=document.getElementById("tab-tasks"),xt=document.getElementById("tab-notes");const t=document.getElementById("tab-table");document.getElementById("tab-cases");const n=document.getElementById("tab-my"),e=document.getElementById("tab-updates");_e=document.getElementById("user-detail"),rn=document.getElementById("user-title"),yt=document.getElementById("user-task-list"),nn=document.getElementById("user-back-btn"),an=document.getElementById("brand-home");const o=document.getElementById("case-header-actions");if(o&&!document.getElementById("case-overflow-btn")){const l=document.createElement("button");l.id="case-overflow-btn",l.className="icon-btn case-overflow-btn",l.type="button",l.setAttribute("aria-haspopup","true"),l.setAttribute("aria-expanded","false"),l.textContent="‚ãØ";const m=document.createElement("div");m.id="case-overflow-panel",m.className="case-overflow-panel",m.hidden=!0,((f,u,p=!1)=>{const w=document.createElement("button");w.type="button",w.className="case-overflow-item"+(p?" delete":""),w.textContent=f,w.addEventListener("click",E=>{E.stopPropagation(),u(),m.hidden=!0,l.setAttribute("aria-expanded","false")}),m.appendChild(w)})("Delete case",async()=>{if(le&&confirm("Delete this case and all its items?"))try{await la(le),le=null,ve.hidden=!0,se&&(se.hidden=!1),Y("Case deleted")}catch(f){console.error("Failed to delete case",f),Y("Failed to delete case")}},!0),o.appendChild(l),o.appendChild(m);const i=f=>{m.hidden=!f,l.setAttribute("aria-expanded",String(f))};l.addEventListener("click",f=>{f.stopPropagation(),i(m.hidden)}),document.addEventListener("click",f=>{!m.hidden&&f.target!==l&&!m.contains(f.target)&&i(!1)},!0)}document.getElementById("user-filter"),yn=Array.from(document.querySelectorAll(".user-status")),gn=document.getElementById("user-priority-filter"),Cn=document.getElementById("user-sort"),se=document.getElementById("table-section"),$e=document.getElementById("table-root");const a=document.getElementById("hide-filters-btn"),s=document.getElementById("show-filters-btn"),c=document.getElementById("print-open-btn");xe=document.getElementById("filter-location"),Le=document.getElementById("filter-consultant"),mt=document.getElementById("sort-by-tag"),ln=document.getElementById("clear-tag-filters"),Xa(),Ja(),Ka(),Va(),vn(),window.addEventListener("resize",vn),t&&t.addEventListener("click",()=>pt("table")),e&&e.addEventListener("click",()=>pt("updates")),ot&&ot.addEventListener("click",l=>{const m=l.target.closest("button[data-type]");if(!m)return;m.classList.toggle("active");const r=m.getAttribute("data-type");m.classList.contains("active")?Wt.add(r):Wt.delete(r),Xe()}),Pe&&Pe.addEventListener("change",()=>{Kt=Pe.value||"",Xe()}),st&&st.addEventListener("input",()=>{zt=st.value.trim(),Xe()}),en&&en.addEventListener("click",()=>{Wt=new Set(["task_added","task_completed","comment_added","note_added"]),Array.from((ot==null?void 0:ot.querySelectorAll(".pill"))||[]).forEach(l=>l.classList.add("active")),Kt="",Pe&&(Pe.value=""),zt="",st&&(st.value=""),Xe()}),Qt&&Qt.addEventListener("click",()=>{try{const l=`updates.lastSeen:${ie||""}`,m=Date.now();localStorage.setItem(l,String(m)),St=m}catch{}Xe()}),tn&&tn.addEventListener("click",Pa),n&&n.addEventListener("click",()=>pt("my"));const d="tableFiltersHidden";a&&a.addEventListener("click",()=>Tt(!0)),s&&s.addEventListener("click",()=>Tt(!1));try{const l=localStorage.getItem(d)==="1";Tt(l)}catch{}va(),c&&c.addEventListener("click",()=>{const m=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><div class="print-header">Printed ${new Date().toLocaleString(void 0,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"})}</div><section id="table-section">${$e?$e.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,r=window.open("","_blank");if(!r){Y("Pop-up blocked. Allow pop-ups to print.");return}r.document.open(),r.document.write(m),r.document.close()}),c&&c.addEventListener("click",()=>{const l=`<!doctype html><html><head><meta charset="utf-8"><title>Print Table</title><link rel="stylesheet" href="style.css"></head><body class="print-mode"><section id="table-section">${$e?$e.innerHTML:""}</section><script>window.addEventListener('load',function(){ setTimeout(function(){ window.print(); }, 50); });<\/script></body></html>`,m=window.open("","_blank");if(!m){Y("Pop-up blocked. Allow pop-ups to print.");return}m.document.open(),m.document.write(l),m.document.close()}),An.addEventListener("click",()=>{if(Ut==="user"&&_e)Ce&&(Ce(),Ce=null),ke&&(ke(),ke=null),he&&(he(),he=null),le=null,ve.hidden=!0,_e.hidden=!1,Be&&(Be.style.display="none"),Ut="list";else if(Ut==="updates"&&we){Ce&&(Ce(),Ce=null),ke&&(ke(),ke=null),he&&(he(),he=null),le=null,ve.hidden=!0,pt("updates");try{const l=new URL(window.location.href);l.searchParams.delete("case"),window.history.pushState({},"",l.toString())}catch{}}else{Ce&&(Ce(),Ce=null),ke&&(ke(),ke=null),he&&(he(),he=null),le=null,ve.hidden=!0,se&&(se.hidden=!1);try{window.scrollTo(0,Jn||0);const l=new URL(window.location.href);l.searchParams.delete("case"),window.history.pushState({},"",l.toString())}catch{}}}),nn&&nn.addEventListener("click",()=>{if(_e.hidden=!0,le?(ve.hidden=!1,Be&&(Be.style.display="none")):se&&(se.hidden=!1),Array.isArray(Ze)){for(const l of Ze)try{l()}catch{}Ze=[]}}),an&&(an.addEventListener("click",()=>{se&&(se.hidden=!1),ve.hidden=!0,_e.hidden=!0}),document.addEventListener("taskToolbar:status",l=>{const m=l&&l.detail||{};jt=new Set((m.statuses||[]).map(String)),je()}),document.addEventListener("taskToolbar:priority",l=>{Vt=l&&l.detail&&l.detail.priority||"all",je()}),document.addEventListener("taskToolbar:sort",l=>{Lt=l&&l.detail&&l.detail.sort||"none",je()}),document.addEventListener("taskToolbar:search",l=>{Yt=l&&l.detail&&l.detail.query||"",je()}),document.addEventListener("taskToolbar:clear",()=>{jt=new Set(["open","in progress","complete"]),Vt="all",Lt="none",Yt="",je()})),document.addEventListener("userToolbar:status",l=>{const m=l&&l.detail||{};Re=new Set((m.statuses||[]).map(String)),rt(),qe()}),document.addEventListener("userToolbar:priority",l=>{Ue=l&&l.detail&&l.detail.priority||"all",rt(),qe()}),document.addEventListener("userToolbar:sort",l=>{Oe=l&&l.detail&&l.detail.sort||"none",rt(),qe()}),document.addEventListener("userToolbar:search",l=>{Ye=l&&l.detail&&l.detail.query||"",rt(),qe()}),document.addEventListener("userToolbar:assignee",l=>{ye=l&&l.detail&&l.detail.assignee||"me",rt(),da();const r=wn.get(Nn());r&&r.perCase&&r.titles&&(et=new Map(r.perCase),be=new Map(r.titles),qe()),ma(tt||ie)}),document.addEventListener("userToolbar:clear",()=>{Re=new Set(["open","in progress","complete"]),Ue="all",Oe="none",rt(),qe()});try{await ya(Ca)}catch(l){console.error("Failed to sign in anonymously",l);return}const h=prompt("Enter shared passphrase");if(h&&(kn=await ba(h),ie=await na(),!!ie)){xa(),Ta(),Ua(),xe&&Array.from(xe.options).forEach(l=>{l.selected=j.location.has(l.value)}),Le&&Array.from(Le.options).forEach(l=>{l.selected=j.consultant.has(l.value)}),Za(),pt("table");try{const m=new URL(window.location.href).searchParams.get("case");m&&At(m,"Case","table","notes")}catch{}window.addEventListener("popstate",()=>{try{const m=new URL(window.location.href).searchParams.get("case");m?le!==m&&At(m,"Case","table","notes"):(ve.hidden=!0,se&&(se.hidden=!1))}catch{}})}});function Y(t){const n=document.getElementById("toast-container");if(!n)return;const e=document.createElement("div");e.className="toast",e.textContent=t,n.appendChild(e),setTimeout(()=>{e.remove()},3300)}async function la(t){const n=await ht(ae(I,"cases",t,"tasks"));for(const o of n.docs){const a=await ht(ae(I,"cases",t,"tasks",o.id,"comments"));await Promise.all(a.docs.map(s=>Te(X(I,"cases",t,"tasks",o.id,"comments",s.id)))),await Te(X(I,"cases",t,"tasks",o.id))}const e=await ht(ae(I,"cases",t,"notes"));await Promise.all(e.docs.map(o=>Te(X(I,"cases",t,"notes",o.id)))),await Te(X(I,"cases",t))}function Za(){const t=document.getElementById("user-list"),n=document.getElementById("add-user-btn"),e=document.getElementById("users-menu"),o=document.getElementById("users-btn"),a=document.getElementById("location-list"),s=document.getElementById("add-location-btn"),c=document.getElementById("manage-tags-btn");if(!t||!n||!e||!o||!a||!s)return;const d=r=>{e.hidden=!r,o.setAttribute("aria-expanded",String(r))};o.addEventListener("click",r=>{r.stopPropagation(),d(e.hidden)}),document.addEventListener("click",r=>{!e.hidden&&!e.contains(r.target)&&r.target!==o&&d(!1)}),n.addEventListener("click",async r=>{r.stopPropagation();const i=(prompt("Add user name")||"").trim();i&&await Fe(ae(I,"users"),{username:i,createdAt:We()})}),c&&c.addEventListener("click",r=>{r.stopPropagation(),d(!1),m()});const h=ge(ae(I,"users"),Ne("username"));Ht&&(Ht(),Ht=null),Ht=Ie(h,r=>{t.innerHTML="",Ve=[];for(const i of r.docs){const u=i.data().username||"Unknown";Ve.push({id:i.id,username:u});const p=document.createElement("li"),w=document.createElement("button");w.className="name icon-btn",w.textContent=u,w.addEventListener("click",()=>{d(!1),ie=u,Tn(u)});const E=document.createElement("button");E.className="icon-btn",E.textContent="‚úèÔ∏è",E.setAttribute("aria-label",`Edit ${u}`),E.addEventListener("click",async D=>{D.stopPropagation();const F=(prompt("Edit user name",u)||"").trim();!F||F===u||await oe(X(I,"users",i.id),{username:F})});const y=document.createElement("button");y.className="icon-btn delete-btn",y.textContent="üóë",y.setAttribute("aria-label",`Delete ${u}`),y.addEventListener("click",async D=>{D.stopPropagation(),confirm(`Delete user '${u}'?`)&&await Te(X(I,"users",i.id))}),p.appendChild(w),p.appendChild(E),p.appendChild(y),t.appendChild(p)}ia();try{const i=Ve.map(f=>f.username);document.dispatchEvent(new CustomEvent("userToolbar:users",{detail:{users:i}}))}catch{}});const l=ge(ae(I,"locations"),Ne("name"));qt&&(qt(),qt=null),qt=Ie(l,r=>{a.innerHTML="",mn=[];for(const i of r.docs){const u=(i.data().name||"").trim()||"Unnamed";mn.push({id:i.id,name:u});const p=document.createElement("li"),w=document.createElement("button");w.className="name icon-btn",w.textContent=u;const E=document.createElement("button");E.className="icon-btn",E.textContent="‚úèÔ∏è",E.setAttribute("aria-label",`Edit ${u}`),E.addEventListener("click",async D=>{D.stopPropagation();const F=(prompt("Edit location",u)||"").trim();if(!(!F||F===u))try{await oe(X(I,"locations",i.id),{name:F})}catch(S){console.error("Failed to update location",S),Y("Failed to update location (permissions)")}});const y=document.createElement("button");y.className="icon-btn delete-btn",y.textContent="üóë",y.setAttribute("aria-label",`Delete ${u}`),y.addEventListener("click",async D=>{if(D.stopPropagation(),!!confirm(`Delete location '${u}'?`))try{await Te(X(I,"locations",i.id))}catch(F){console.error("Failed to delete location",F),Y("Failed to delete location (permissions)")}}),p.appendChild(w),p.appendChild(E),p.appendChild(y),a.appendChild(p)}Qa()},r=>{console.error("Locations listener error",r),Y("Cannot access locations (permissions)")});function m(){const r=document.createElement("div");r.className="modal-overlay";const i=document.createElement("div");i.className="modal tags-manager",r.appendChild(i);const f=document.createElement("h3");f.textContent="Manage Tags",i.appendChild(f);const u=document.createElement("div");u.className="tabs";const p=document.createElement("button");p.className="tab active",p.textContent="Locations",u.appendChild(p);const w=document.createElement("button");w.className="tab",w.textContent="Consultants",u.appendChild(w),i.appendChild(u);const E=document.createElement("div");i.appendChild(E);const y=document.createElement("div");y.className="section-actions",i.appendChild(y);const D=document.createElement("button");D.className="btn",D.textContent="Close",y.appendChild(D),document.body.appendChild(r);const F=_=>{p.classList.toggle("active",_==="loc"),w.classList.toggle("active",_==="cons"),L(_)};p.addEventListener("click",()=>F("loc")),w.addEventListener("click",()=>F("cons")),D.addEventListener("click",()=>r.remove());const S=()=>{const _=p.classList.contains("active")?"loc":"cons";L(_)},O=_=>{p.classList.contains("active")&&L("loc")};document.addEventListener("tags:updated",S),document.addEventListener("subtags:updated",O);const M=()=>{document.removeEventListener("tags:updated",S),document.removeEventListener("subtags:updated",O)};D.addEventListener("click",M,{once:!0}),F("loc");async function L(_){var P;if(E.innerHTML="",_==="cons"){q("consultant");return}const B=document.createElement("div");B.className="grid",E.appendChild(B);const A=document.createElement("div");A.className="tags-list",B.appendChild(A);const H=document.createElement("div");H.className="rooms-list",B.appendChild(H);const Z=document.createElement("h4");Z.textContent="Wards",A.appendChild(Z);const W=document.createElement("h4");W.textContent="Rooms",H.appendChild(W);const x=document.createElement("div");A.appendChild(x);const U=document.createElement("div");U.className="section-actions",A.appendChild(U);const $=document.createElement("button");$.textContent="Add ward",$.className="btn",U.appendChild($);let k=((P=(re.get("location")||[])[0])==null?void 0:P.id)||"";function K(){x.innerHTML="";const v=re.get("location")||[];for(let b=0;b<v.length;b++){const T=v[b],C=document.createElement("div");C.className="entry";const N=document.createElement("span");N.className="name",N.textContent=`${b+1}. ${T.name}`,C.appendChild(N),C.addEventListener("click",()=>{k=T.id,g()});const R=document.createElement("div");R.className="row-actions";const G=document.createElement("button");G.textContent="‚Üë",G.addEventListener("click",()=>_t("location",b,-1)),R.appendChild(G);const V=document.createElement("button");V.textContent="‚Üì",V.addEventListener("click",()=>_t("location",b,1)),R.appendChild(V);const ee=document.createElement("button");ee.textContent="Edit",ee.addEventListener("click",()=>Fn(T.id,T.name)),R.appendChild(ee);const z=document.createElement("button");z.textContent="Delete",z.addEventListener("click",()=>Dn("location",T.id)),R.appendChild(z),C.appendChild(R),x.appendChild(C)}}K(),$.addEventListener("click",()=>Xt("location"));async function g(){H.innerHTML="";const v=document.createElement("h4");v.textContent="Rooms",H.appendChild(v);const b=document.createElement("div");H.appendChild(b);const T=await Ln(k);for(let R=0;R<T.length;R++){const G=T[R],V=document.createElement("div");V.className="entry";const ee=document.createElement("span");ee.className="name",ee.textContent=`${R+1}. ${G.name}`,V.appendChild(ee);const z=document.createElement("div");z.className="row-actions";const J=document.createElement("button");J.textContent="‚Üë",J.addEventListener("click",()=>Pn(k,R,-1)),z.appendChild(J);const te=document.createElement("button");te.textContent="‚Üì",te.addEventListener("click",()=>Pn(k,R,1)),z.appendChild(te);const Q=document.createElement("button");Q.textContent="Edit",Q.addEventListener("click",()=>eo(k,G.id,G.name)),z.appendChild(Q);const fe=document.createElement("button");fe.textContent="Delete",fe.addEventListener("click",()=>to(k,G.id)),z.appendChild(fe),V.appendChild(z),b.appendChild(V)}const C=document.createElement("div");C.className="section-actions",H.appendChild(C);const N=document.createElement("button");N.className="btn",N.textContent="Add room",N.addEventListener("click",()=>ra(k)),C.appendChild(N)}g()}function q(_){E.innerHTML="";const B=document.createElement("div");B.className="tags-list",E.appendChild(B);const A=document.createElement("h4");A.textContent="Consultants",B.appendChild(A);const H=document.createElement("div");B.appendChild(H);const Z=re.get(_)||[];for(let U=0;U<Z.length;U++){const $=Z[U],k=document.createElement("div");k.className="entry";const K=document.createElement("span");K.className="name",K.textContent=`${U+1}. ${$.name}`,k.appendChild(K);const g=document.createElement("div");g.className="row-actions";const P=document.createElement("button");P.textContent="‚Üë",P.addEventListener("click",()=>_t(_,U,-1)),g.appendChild(P);const v=document.createElement("button");v.textContent="‚Üì",v.addEventListener("click",()=>_t(_,U,1)),g.appendChild(v);const b=document.createElement("button");b.textContent="Edit",b.addEventListener("click",()=>Fn($.id,$.name)),g.appendChild(b);const T=document.createElement("button");T.textContent="Delete",T.addEventListener("click",()=>Dn(_,$.id)),g.appendChild(T),k.appendChild(g),H.appendChild(k)}const W=document.createElement("div");W.className="section-actions",B.appendChild(W);const x=document.createElement("button");x.className="btn",x.textContent="Add",x.addEventListener("click",()=>Xt(_)),W.appendChild(x)}}s.addEventListener("click",async r=>{r.stopPropagation();const i=(prompt("Add location name")||"").trim();if(i)try{await Fe(ae(I,"locations"),{name:i,createdAt:We()})}catch(f){console.error("Failed to add location",f),Y("Failed to add location (permissions)")}})}function Qa(){const t=document.getElementById("case-location");if(!t)return;const n=t.value;t.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="No location",t.appendChild(e);for(const o of mn){const a=document.createElement("option");a.value=o.name,a.textContent=o.name,t.appendChild(a)}t.value=n||""}async function Xt(t){try{const n=(prompt(`Add ${t}`)||"").trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),a=re.get(t)||[];await Fe(ae(I,"tags"),{type:t,order:a.length,nameCipher:e,nameIv:o})}catch(n){console.error("Failed to add tag",n),Y("Failed to add tag")}}async function Fn(t,n){try{const e=(prompt("Rename",n)||"").trim();if(!e)return;const{cipher:o,iv:a}=await ne(e);await oe(X(I,"tags",t),{nameCipher:o,nameIv:a})}catch(e){console.error("Failed to rename tag",e),Y("Failed to rename")}}async function Dn(t,n){try{if(!confirm("Delete tag and its rooms (if any)?"))return;const e=await ht(ae(I,"tags",n,"subtags"));for(const o of e.docs)await Te(X(I,"tags",n,"subtags",o.id));await Te(X(I,"tags",n))}catch(e){console.error("Failed to delete tag",e),Y("Failed to delete")}}async function _t(t,n,e){try{const o=(re.get(t)||[]).slice(),a=n+e;if(a<0||a>=o.length)return;const s=o[n],c=o[a];await Promise.all([oe(X(I,"tags",s.id),{order:a}),oe(X(I,"tags",c.id),{order:n})])}catch(o){console.error("Failed to reorder",o),Y("Failed to reorder")}}async function ra(t){try{if(!t)return;const n=(prompt("Add room")||"").trim();if(!n)return;const{cipher:e,iv:o}=await ne(n),a=Me.get(t)||[];await Fe(ae(I,"tags",t,"subtags"),{type:"room",order:a.length,nameCipher:e,nameIv:o})}catch(n){console.error("Failed to add room",n),Y("Failed to add room")}}async function eo(t,n,e){try{const o=(prompt("Rename room",e)||"").trim();if(!o)return;const{cipher:a,iv:s}=await ne(o);await oe(X(I,"tags",t,"subtags",n),{nameCipher:a,nameIv:s})}catch(o){console.error("Failed to rename room",o),Y("Failed to rename room")}}async function to(t,n){try{if(!confirm("Delete this room?"))return;await Te(X(I,"tags",t,"subtags",n))}catch(e){console.error("Failed to delete room",e),Y("Failed to delete room")}}async function Pn(t,n,e){try{const o=(Me.get(t)||[]).slice(),a=n+e;if(a<0||a>=o.length)return;const s=o[n],c=o[a];await Promise.all([oe(X(I,"tags",t,"subtags",s.id),{order:a}),oe(X(I,"tags",t,"subtags",c.id),{order:n})])}catch(o){console.error("Failed to reorder room",o),Y("Failed to reorder room")}}function Tn(t){tt=t,da(),Be&&(Be.style.display="none"),ve.hidden=!0,_e.hidden=!1;const n=document.getElementById("change-user-link");n&&n.addEventListener("click",async()=>{const a=await na();a&&a!==ie&&(ie=a,Tn(a))},{once:!0});const e=ea.get(t);e&&typeof e=="object"?(Re=new Set(e.statuses||["open","in progress","complete"]),Ue=e.priority||"all",Oe=e.sort||"none",Ye=e.search||"",ye=e.assignee||"me"):(Re=new Set(["open","in progress","complete"]),Ue="all",Oe="none",Ye="",ye="me"),yn.length&&yn.forEach(a=>a.checked=Re.has(a.value)),gn&&(gn.value=Ue),Cn&&(Cn.value=Oe),document.dispatchEvent(new CustomEvent("userToolbar:hydrate",{detail:{statuses:Array.from(Re),priority:Ue,sort:Oe,search:Ye,assignee:ye}}));const o=wn.get(Nn());o&&o.perCase&&o.titles?(et=new Map(o.perCase),be=new Map(o.titles),qe()):yt&&(yt.innerHTML='<li style="list-style:none;color:var(--muted);padding:8px 0;">Loading‚Ä¶</li>'),ma(t)}function da(){if(!rn)return;let t="";ye==="all"?t="All tasks":ye==="unassigned"?t="Unassigned tasks":ye==="me"?t=`${ie||tt||"Me"}'s tasks`:ye.startsWith("name:")&&(t=`${ye.slice(5)}'s tasks`),rn.innerHTML=`${t} <button id="change-user-link" class="change-user-link" type="button">(Change user)</button>`}function Nn(){return ye||"me"}function rt(){tt&&ea.set(tt,{statuses:Array.from(Re),priority:Ue,sort:Oe,search:Ye,assignee:ye})}async function ma(t){if(Array.isArray(Ze)){for(const a of Ze)try{a()}catch{}Ze=[]}be||(be=new Map),et||(et=new Map);let n=fa(I,"tasks"),e;ye==="all"?e=n:ye==="unassigned"?e=ge(n,$t("assignee","==",null)):ye==="me"?e=ge(n,$t("assignee","==",ie||t)):ye.startsWith("name:")?e=ge(n,$t("assignee","==",ye.slice(5))):e=ge(n,$t("assignee","==",ie||t));const o=Ie(e,async a=>{try{const s=a.docs,c=new Map,d=[],h=[],l=new Set;for(const r of s){const i=r.data(),f=r.ref.parent&&r.ref.parent.parent,u=f?f.id:null;if(!u)continue;l.add(u);const p={taskId:r.id,caseId:u,assignee:i.assignee||null,priority:i.priority||null,text:null,status:null};h.push(p),d.push(Promise.all([ce(i.textCipher,i.textIv),ce(i.statusCipher,i.statusIv)]).then(([w,E])=>{p.text=w,p.status=E}).catch(w=>{console.error("Decrypt task failed",w)}))}await Promise.all(d);for(const r of h)!r||!r.caseId||!r.text||(c.has(r.caseId)||c.set(r.caseId,[]),c.get(r.caseId).push(r));const m=[];for(const r of l)be.has(r)||m.push($n(X(I,"cases",r)).then(async i=>{if(i.exists()){const f=i.data();try{const u=await ce(f.titleCipher,f.titleIv);be.set(r,u)}catch{be.set(r,"(case)")}}else be.set(r,"(case)")}).catch(()=>{be.set(r,"(case)")}));if(await Promise.all(m),et=c,wn.set(Nn(),{perCase:new Map(c),titles:new Map(be)}),fn){hn=!0;return}qe()}catch(s){console.error("Failed to build user tasks view",s)}});Ze.push(o)}function qe(){if(!yt)return;yt.innerHTML="";const t=Array.from(et.keys()).sort((n,e)=>(be.get(n)||"").localeCompare(be.get(e)||""));for(const n of t){let e=et.get(n)||[];if(Re&&Re.size&&(e=e.filter(i=>Re.has(i.status))),Ue!=="all"&&(e=e.filter(i=>(i.priority||"")===Ue)),Ye&&Ye.trim()){const i=Ye.toLowerCase();e=e.filter(f=>(f.text||"").toLowerCase().includes(i))}if(e.length===0)continue;const o=be.get(n)||"(case)",a=document.createElement("div");a.className="card user-case-card";const s=document.createElement("div");s.className="user-case-header";const c=document.createElement("h3"),d=document.createElement("button");d.className="link-btn",d.textContent=o,d.setAttribute("aria-label",`Open case ${o}`),d.addEventListener("click",()=>At(n,o,"user","notes")),c.appendChild(d),s.appendChild(c);const h=document.createElement("span");h.className="badge",h.textContent=String(e.length),s.appendChild(h),a.appendChild(s);const l=document.createElement("ul"),m=i=>i==="high"?3:i==="medium"?2:i==="low"?1:0;let r=[...e];Oe==="pri-desc"?r.sort((i,f)=>m(f.priority)-m(i.priority)):Oe==="pri-asc"&&r.sort((i,f)=>m(i.priority)-m(f.priority));for(const i of r){const f=document.createElement("li"),u=i.status==="in progress"?"s-inprogress":i.status==="complete"?"s-complete":"s-open";f.className="case-task "+u;const p=document.createElement("button");p.type="button",p.className="status-btn";const w=$=>$==="complete"?"‚òë":$==="in progress"?"‚óê":"‚òê";p.textContent=w(i.status),p.setAttribute("aria-label",`Task status: ${i.status}`),p.addEventListener("click",async $=>{$.stopPropagation();const k=["open","in progress","complete"],K=k[(k.indexOf(i.status)+1)%k.length];try{const{cipher:g,iv:P}=await ne(K);if(await oe(X(I,"cases",n,"tasks",i.taskId),{statusCipher:g,statusIv:P}),i.status=K,p.textContent=w(K),p.setAttribute("aria-label",`Task status: ${K}`),f.className="case-task "+(K==="in progress"?"s-inprogress":K==="complete"?"s-complete":"s-open"),K==="complete")try{const v=await ne(i.text||"");await Ge({type:"task_completed",caseId:n,taskId:i.taskId,taskTextCipher:v.cipher,taskTextIv:v.iv})}catch{}}catch(g){console.error("Failed to update status",g),Y("Failed to update status")}});const E=document.createElement("span");if(E.className="task-text",E.textContent=i.text,E.addEventListener("click",$=>{$.stopPropagation(),fn=!0;const k=document.createElement("div");k.className="cell-editable",k.setAttribute("contenteditable","true"),k.textContent=i.text;let K=i.text;const g=()=>{try{k.remove()}catch{}E.style.display="",fn=!1,hn&&(hn=!1,qe())},P=async()=>{const v=(k.innerText||"").replace(/\r/g,"");if(v===K){g();return}try{const{cipher:b,iv:T}=await ne(v);await oe(X(I,"cases",n,"tasks",i.taskId),{textCipher:b,textIv:T}),K=v,E.textContent=v}catch(b){console.error("Failed to update task",b),Y("Failed to update task")}g()};k.addEventListener("paste",v=>{v.preventDefault();const b=(v.clipboardData||window.clipboardData).getData("text");if(document.queryCommandSupported&&document.queryCommandSupported("insertText"))document.execCommand("insertText",!1,b);else{const T=window.getSelection();T&&T.rangeCount&&(T.deleteFromDocument(),T.getRangeAt(0).insertNode(document.createTextNode(b)))}}),k.addEventListener("keydown",v=>{v.key==="Enter"&&!(v.ctrlKey||v.metaKey)?(v.preventDefault(),P()):v.key==="Escape"&&(v.preventDefault(),g())}),k.addEventListener("blur",()=>{P()}),E.insertAdjacentElement("afterend",k),E.style.display="none",k.focus()}),f.appendChild(p),f.appendChild(E),i.priority){const $=document.createElement("span");$.className="mini-chip",$.textContent=i.priority,f.appendChild($)}const y=document.createElement("span");y.className="mini-avatar";const D=i.assignee?i.assignee.split(/\s+/).map($=>$[0]).join("").slice(0,2).toUpperCase():"";y.textContent=D||"";const F=xn(i.assignee||"");y.style.background=F.bg,y.style.color=F.color,y.style.border=`1px solid ${F.border}`;let S=null;const O=()=>{S&&(S.remove(),S=null)};y.addEventListener("mouseenter",()=>{if(!i.assignee)return;S=document.createElement("div"),S.className="assignee-tip",S.textContent=i.assignee,S.style.position="fixed",S.style.zIndex="2147483647",document.body.appendChild(S);const $=y.getBoundingClientRect();requestAnimationFrame(()=>{const k=S.offsetHeight||24;S.style.left=`${Math.round($.left+$.width/2)}px`,S.style.top=`${Math.round($.top-6-k)}px`,S.style.transform="translateX(-50%)"})}),y.addEventListener("mouseleave",O),y.addEventListener("click",$=>{$.stopPropagation(),O();const k=document.querySelector(".assignee-panel");k&&k.remove();const K=document.createElement("div");K.className="assignee-panel",K.style.position="fixed",K.style.zIndex="2147483646";const g=(b,T)=>{const C=document.createElement("button");C.type="button",C.className="assignee-option",C.textContent=b,C.addEventListener("click",async N=>{var R;N.stopPropagation();try{if(await oe(X(I,"cases",n,"tasks",i.taskId),{assignee:T}),tt&&T!==tt){f.remove();const G=parseInt(((R=a.querySelector(".badge"))==null?void 0:R.textContent)||"1",10);!Number.isNaN(G)&&G>0&&(a.querySelector(".badge").textContent=String(G-1))}}catch(G){console.error("Failed to reassign",G),Y("Failed to reassign")}finally{K.remove()}}),K.appendChild(C)};g("Unassigned",null);for(const b of Ve)g(b.username,b.username);document.body.appendChild(K);const P=y.getBoundingClientRect();requestAnimationFrame(()=>{const b=K.offsetWidth||180,T=Math.min(Math.max(8,P.right-b),window.innerWidth-b-8),C=Math.min(window.innerHeight-K.offsetHeight-8,P.bottom+6);K.style.left=`${Math.round(T)}px`,K.style.top=`${Math.round(C)}px`});const v=b=>{!K||K.contains(b.target)||b.target===y||(K.remove(),document.removeEventListener("click",v,!0))};setTimeout(()=>document.addEventListener("click",v,!0),0)}),f.appendChild(y);const M=document.createElement("button");M.type="button",M.className="icon-btn delete-btn",M.textContent="üóë",M.title="Delete task",M.addEventListener("click",async $=>{if($.stopPropagation(),!!confirm("Delete this task?"))try{await Te(X(I,"cases",n,"tasks",i.taskId)),f.remove();const k=a.querySelector(".badge");if(k){const K=parseInt(k.textContent||"1",10);!Number.isNaN(K)&&K>0&&(k.textContent=String(K-1))}}catch(k){console.error("Failed to delete task",k),Y("Failed to delete task")}}),f.appendChild(M);const L=document.createElement("button");L.type="button",L.className="icon-btn comment-toggle",L.setAttribute("aria-label","Show comments"),L.textContent="üí¨";const q=document.createElement("span");q.className="badge comment-count",f.appendChild(L),f.appendChild(q);const _=document.createElement("div");_.className="comment-section",_.hidden=!0;const B=document.createElement("ul");B.className="comments",_.appendChild(B);const A=document.createElement("form");A.className="comment-form";const H=document.createElement("input");H.placeholder="Add comment",A.appendChild(H);const Z=document.createElement("button");Z.className="icon-btn add-comment-btn",Z.type="submit",Z.textContent="‚ûï",Z.setAttribute("aria-label","Add comment"),A.appendChild(Z),_.appendChild(A);let W=!1,x=0;const U=()=>{q.textContent=x>0?String(x):"",L.textContent=_.hidden?"üí¨":"‚úñ",L.setAttribute("aria-label",_.hidden?"Show comments":"Hide comments")};U(),L.addEventListener("click",()=>{const $=_.hidden;_.hidden=!$,U(),$&&!W&&(Nt(n,i.taskId,B,k=>{x=k,U()}),W=!0)}),A.addEventListener("submit",async $=>{$.preventDefault();const k=H.value.trim();if(!k)return;const K=document.createElement("li");K.className="optimistic";const g=document.createElement("span");g.textContent=ie?`${ie}: ${k}`:k,K.appendChild(g),B.appendChild(K),H.value="",_.hidden=!1,U();try{const{cipher:P,iv:v}=await ne(k);await Fe(ae(I,"cases",n,"tasks",i.taskId,"comments"),{cipher:P,iv:v,username:ie,createdAt:We()});try{await Ge({type:"comment_added",caseId:n,taskId:i.taskId,commentCipher:P,commentIv:v})}catch{}W||(Nt(n,i.taskId,B,b=>{x=b,U()}),W=!0)}catch{K.classList.add("failed"),Y("Failed to add comment")}}),f.appendChild(_),l.appendChild(f)}a.appendChild(l),yt.appendChild(a)}}
